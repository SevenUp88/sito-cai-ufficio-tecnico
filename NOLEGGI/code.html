<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Noleggi Attrezzature Idrauliche</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <!-- Aggiorna Font Awesome se necessario per coerenza, anche se 6.4.2 dovrebbe andare bene -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="code.css"/>
</head>
<body>
  <!-- === Nuovo Header Standard (Modificato) === -->
  <header class="app-header">
      <!-- CORREZIONE: Link principale del logo ora punta alla root del sito -->
      <a href="/" title="C.A.I. - Home">
           <img src="https://i.postimg.cc/Z5b3Yvr0/LOGO-CAI.png" alt="Logo CAI Consorzio Artigiani Idraulici" class="logo"> <!-- Logo standardizzato -->
      </a>

      <!-- === Contenitore per Pulsanti Header (Home e Admin) === -->
      <div class="header-controls">
          <!-- CORREZIONE: Link pulsante Home ora punta alla root del sito -->
          <a href="/" class="header-action-button" title="Torna alla Home">
              <i class="fas fa-home"></i>
          </a>
          <!-- === Pulsante Admin Noleggi (Funzionalità da definire) === -->
          <button id="noleggi-admin-trigger" class="header-action-button" title="Accesso Admin Noleggi">
              <i class="fas fa-user-shield"></i>
          </button>
      </div>
      <!-- === Fine Contenitore Pulsanti === -->
  </header>
  <!-- === Fine Nuovo Header === -->

  <div class="container">
    <!-- Titolo spostato qui -->
    <h1 class="page-title">Gestione Noleggi Attrezzature Idrauliche</h1>

    <div class="dashboard">
      <!-- Sezione Noleggi Attivi -->
      <div class="card">
         <div class="card-header"> <h2>Noleggi Attivi (più recenti prima)</h2> <button class="btn btn-primary" id="new-rental-btn"> <i class="fas fa-plus btn-icon"></i> Nuovo Noleggio </button> </div>
         <div class="stats"> <div class="stat-card"> <div class="stat-value" id="total-rentals">0</div> <div class="stat-label">Noleggi Attivi (Righe)</div> </div> <div class="stat-card"> <div class="stat-value" id="items-rented">0</div> <div class="stat-label">Articoli Noleggiati</div> </div> </div>
         <div class="inventory-container"> <table id="active-rentals-table"> <thead> <tr> <th># Noleggio</th> <th>Articolo</th> <th>Cliente</th> <th>Magazzino</th> <th>Data Inizio</th> <th>Stato</th> <th>Azioni</th> </tr> </thead> <tbody></tbody> </table> </div>
      </div>
      <!-- Sezione Inventario Rapido -->
      <div class="card">
          <div class="card-header"> <h2>Inventario Rapido</h2> <div class="actions"> <button class="btn btn-warning" id="reset-inventory"> <i class="fas fa-sync-alt btn-icon"></i> Reset </button> <label for="excel-upload" class="btn btn-success"> <i class="fas fa-file-excel btn-icon"></i> Carica Excel <input type="file" id="excel-upload" accept=".xlsx, .xls" hidden> </label> </div> </div>
          <div class="stats"> <div class="stat-card"> <div class="stat-value" id="total-items">0</div> <div class="stat-label">Articoli Totali (Quantità)</div> </div> <div class="stat-card"> <div class="stat-value" id="available-items">0</div> <div class="stat-label">Disponibili (Quantità)</div> </div> </div>
          <div class="attention-rentals"> <h3><i class="fas fa-exclamation-triangle attention-icon"></i> Noleggi da Verificare (da 5+ giorni)</h3> <ul id="oldest-rentals-list"> <li>Nessun noleggio attivo da verificare.</li> </ul> </div>
      </div>
    </div>
    <!-- Sezione Inventario Completo -->
    <div class="card">
        <div class="card-header"> <h2>Inventario Completo</h2> <div class="actions"> <button class="btn btn-success" id="new-item-btn"> <i class="fas fa-plus btn-icon"></i> Nuovo Articolo </button> <button class="btn btn-primary" id="export-inventory-btn"> <i class="fas fa-file-export btn-icon"></i> Esporta Inventario </button> </div> </div>
        <div class="search-filter"> <input type="text" id="inventory-search" placeholder="Cerca articolo..."> <select id="filter-brand"> <option value="">Tutte le marche</option> </select> <select id="filter-status"> <option value="">Tutti gli stati</option> <option value="available">Disponibili</option> <option value="rented">Esauriti</option> </select> </div>
        <div class="inventory-container"> <table id="inventory-table"> <thead> <tr> <th>Marca</th> <th>Articolo</th> <th class="text-center">Q.tà Totale</th> <th class="text-center">Disponibili</th> <th class="text-right">Prezzo Giorn. (€)</th> <th>Stato</th> <th>Azioni</th> </tr> </thead> <tbody></tbody> </table> </div>
    </div>
     <!-- Sezione Storico/Stampa Noleggi -->
     <div class="card">
         <div class="card-header"> <h2>Storico Noleggi per Cliente</h2> <div class="actions print-filters"> <label for="print-month" class="sr-only">Mese:</label> <select id="print-month" class="form-control"> <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option> </select> <label for="print-year" class="sr-only">Anno:</label> <input type="number" id="print-year" class="form-control" placeholder="Anno"> <button class="btn btn-primary" id="print-rentals-btn"> <i class="fas fa-print btn-icon"></i> Stampa Selez. </button> <button class="btn btn-warning btn-sm" id="reset-completed-btn" title="Rimuove storico completati"> <i class="fas fa-trash-alt btn-icon"></i> Azzera Storico </button> </div> </div>
         <div class="stats"> <div class="stat-card"> <div class="stat-value" id="total-completed">0</div> <div class="stat-label">Noleggi Completati (Righe)</div> </div> <div class="stat-card"> <div class="stat-value" id="total-clients">0</div> <div class="stat-label">Clienti Unici (Storico)</div> </div> </div>
         <div class="info-text"> Seleziona mese e anno per generare un resoconto. </div>
     </div>
  </div><!-- end container -->

  <!-- Modals (rimangono invariati) -->

  <!-- New/Add Rental Modal -->
  <div id="rental-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="rental-modal-title">Nuovo Noleggio</h2>
        <form id="new-rental-form">
            <input type="hidden" id="rental-number-ongoing">
            <div class="form-group">
                <label for="rental-operator">Operatore:</label>
                <select id="rental-operator" required class="form-control">
                    <option value="">-- Seleziona Operatore --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rental-warehouse">Magazzino Origine:</label>
                <select id="rental-warehouse" required class="form-control">
                    <option value="">-- Seleziona Magazzino --</option>
                    <option value="VILLALTA">VILLALTA</option>
                    <option value="SAVIGNANO">SAVIGNANO</option>
                    <option value="VILLAMARINA">VILLAMARINA</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rental-client-name">Nome Cliente:</label>
                <input type="text" id="rental-client-name" required class="form-control">
            </div >
            <div class="form-group">
                <label for="rental-start-date">Data Inizio:</label>
                <input type="date" id="rental-start-date" required class="form-control">
            </div>
            <hr style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 1rem; font-weight: 500;">Articolo da Noleggiare</h3>
            <div class="form-group">
                <label for="rental-brand-selection">Marca:</label>
                <select id="rental-brand-selection" required class="form-control">
                    <option value="">-- Prima Seleziona Marca --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rental-item-selection">Articolo:</label>
                <select id="rental-item-selection" required disabled class="form-control">
                    <option value="">-- Seleziona Marca Prima --</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rental-quantity">Quantità:</label>
                <input type="number" id="rental-quantity" min="1" value="1" required class="form-control">
                <small id="quantity-available-info" style="display: none; color: var(--gray); margin-top: 4px;"></small>
            </div>
            <div class="form-group">
                <label for="rental-notes">Note (Opzionale):</label>
                <textarea id="rental-notes" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Conferma Noleggio</button>
        </form>
    </div>
  </div>

  <!-- Edit Active Rental Modal -->
  <div id="edit-rental-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Modifica Riga Noleggio Attivo</h2>
        <form id="edit-rental-form">
            <input type="hidden" id="edit-rental-id">
            <input type="hidden" id="edit-rental-original-item-id">
            <input type="hidden" id="edit-rental-original-quantity">
            <fieldset disabled style="border: none; padding: 0; margin: 0 0 1rem 0;">
                <legend style="font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; padding: 0;">Info Noleggio (Non Modificabili)</legend>
                <div class="form-group"> <label>Numero Noleggio:</label> <input type="text" id="edit-rental-number-display" readonly class="form-control"> </div>
                <div class="form-group"> <label>Magazzino:</label> <input type="text" id="edit-rental-warehouse-display" readonly class="form-control"> </div>
                <div class="form-group"> <label>Data Inizio:</label> <input type="text" id="edit-rental-startdate-display" readonly class="form-control"> </div>
            </fieldset>
            <hr style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 1rem; font-weight: 500;">Dati Modificabili</h3>
            <div class="form-group">
                <label for="edit-rental-client-name">Nome Cliente:</label>
                <input type="text" id="edit-rental-client-name" required class="form-control" style="text-transform: uppercase;">
            </div>
            <div class="form-group">
                <label for="edit-rental-operator">Operatore:</label>
                <select id="edit-rental-operator" required class="form-control">
                    <option value="">-- Seleziona Operatore --</option>
                </select>
            </div>
            <hr style="margin: 1.5rem 0;">
            <h3 style="margin-bottom: 1rem; font-weight: 500;">Modifica Articolo (per questa riga)</h3>
            <div class="form-group"> <label for="edit-rental-brand-selection">Nuova Marca:</label> <select id="edit-rental-brand-selection" required class="form-control"> <option value="">-- Seleziona Marca --</option> </select> </div>
            <div class="form-group"> <label for="edit-rental-item-selection">Nuovo Articolo:</label> <select id="edit-rental-item-selection" required class="form-control" disabled> <option value="">-- Seleziona Marca Prima --</option> </select> </div>
            <div class="form-group"> <label for="edit-rental-quantity">Nuova Quantità:</label> <input type="number" id="edit-rental-quantity" min="1" required class="form-control"> <small id="edit-quantity-available-info" style="display: none; color: var(--gray); margin-top: 4px;"></small> </div>
            <div class="form-group"> <label for="edit-rental-notes">Note Articolo:</label> <textarea id="edit-rental-notes" class="form-control" style="text-transform: uppercase;"></textarea> </div>
            <button type="submit" class="btn btn-primary">Salva Modifiche Noleggio</button>
        </form>
    </div>
  </div>

  <!-- New Inventory Item Modal -->
  <div id="new-item-modal" class="modal">
      <div class="modal-content">
          <span class="close-btn">&times;</span>
          <h2>Nuovo Articolo Inventario</h2>
          <form id="new-item-form">
              <div class="form-group"> <label for="new-item-brand">Marca:</label> <input type="text" id="new-item-brand" required class="form-control"> </div>
              <div class="form-group"> <label for="new-item-name">Nome Articolo:</label> <input type="text" id="new-item-name" required class="form-control"> </div>
              <div class="form-group"> <label for="new-item-quantity">Quantità Totale (per tutta l'azienda):</label> <input type="number" id="new-item-quantity" min="1" value="1" required class="form-control"> </div>
              <div class="form-group"> <label for="new-item-daily-rate">Prezzo Noleggio Giornaliero (€):</label> <input type="number" id="new-item-daily-rate" min="0" step="0.01" value="0.00" required class="form-control"> </div>
              <button type="submit" class="btn btn-primary">Aggiungi Articolo</button>
          </form>
      </div>
  </div>
  <!-- Edit Inventory Item Modal -->
  <div id="edit-item-modal" class="modal"> <div class="modal-content"> <span class="close-btn">&times;</span> <h2>Modifica Articolo Inventario</h2> <form id="edit-item-form">...</form> </div> </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Assicurati che code.js sia nella stessa cartella (NOLEGGI) o aggiorna il percorso se necessario -->
  <script src="code.js"></script> 
</body>
</html>