<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestione Noleggi - CAI</title>
  
  <!-- CSS Globale -->
  <link rel="stylesheet" href="../style.css">
  <!-- CSS Specifico Noleggi -->
  <link rel="stylesheet" href="code.css"/>
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    .hidden { display: none !important; }
    #loading-indicator { text-align: center; padding: 40px; font-size: 1.1em; color: #555; }
    
    /* Stile per l'header cliccabile dell'inventario */
    #inventory-header {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }
    #inventory-header:hover {
        background-color: #f8f9fa;
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="initial-loader" class="loader-container">
      <div class="loader-spinner"></div>
      <p style="margin-top:10px;">Caricamento Noleggi...</p>
  </div>

  <!-- SEZIONE LOGIN -->
  <section id="login-section" class="hidden login-centered">
      <div class="login-card">
          <img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo CAI" class="login-logo">
          <h2>Area Noleggi</h2>
          <form id="login-form">
              <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
              <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
              <button type="submit" class="btn-login">Accedi</button>
          </form>
          <p id="login-error" class="error-message hidden" style="color:red; text-align:center; margin-top:10px;"></p>
      </div>
  </section>

  <!-- APP CONTENT -->
  <div id="app-content" class="dashboard-wrapper hidden">
      
      <!-- SIDEBAR -->
      <nav class="sidebar">
          <div class="sidebar-brand">
              <a href="/"><img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo CAI"></a>
          </div>
          <ul class="sidebar-menu"></ul> 
          <div class="sidebar-footer">&copy; 2025 CAI Solutions</div>
      </nav>

      <!-- MAIN CONTENT -->
      <main class="main-content">
          <!-- Header generato da JS -->

          <div class="content-container">
              
              <!-- Dashboard Cards Grid -->
              <div class="dashboard-noleggi-grid">
                  
                  <!-- 1. NOLEGGI ATTIVI (Pulsante Nuovo Noleggio) -->
                  <div class="card full-width-card">
                     <div class="card-header"> 
                         <h2>Noleggi Attivi</h2> 
                         <button class="btn btn-primary" id="new-rental-btn"> 
                             <i class="fas fa-plus btn-icon"></i> Nuovo Noleggio 
                         </button> 
                     </div>
                     <div class="stats"> 
                         <div class="stat-card"> <div class="stat-value" id="total-rentals">0</div> <div class="stat-label">Noleggi Attivi</div> </div> 
                         <div class="stat-card"> <div class="stat-value" id="items-rented">0</div> <div class="stat-label">Articoli Noleggiati</div> </div> 
                     </div>
                     <div class="inventory-container"> 
                         <table id="active-rentals-table"> 
                             <thead> <tr> <th># Noleggio</th> <th>Articolo</th> <th>Cliente</th> <th>Magazzino</th> <th>Data Inizio</th> <th>Stato</th> <th>Azioni</th> </tr> </thead> 
                             <tbody></tbody> 
                         </table> 
                     </div>
                  </div>

                  <!-- 2. INVENTARIO RAPIDO (Pulsante Carica Excel) -->
                  <div class="card">
                      <div class="card-header"> 
                          <h2>Inventario Rapido</h2> 
                          <div class="actions"> 
                              <button class="btn btn-warning" id="reset-inventory"> <i class="fas fa-sync-alt btn-icon"></i> Reset </button> 
                              <label for="excel-upload" class="btn btn-success"> <i class="fas fa-file-excel btn-icon"></i> Carica Excel <input type="file" id="excel-upload" accept=".xlsx, .xls" hidden> </label> 
                          </div> 
                      </div>
                      <div class="stats"> 
                          <div class="stat-card"> <div class="stat-value" id="total-items">0</div> <div class="stat-label">Articoli Totali</div> </div> 
                          <div class="stat-card"> <div class="stat-value" id="available-items">0</div> <div class="stat-label">Disponibili</div> </div> 
                      </div>
                      <div class="attention-rentals"> 
                          <h3><i class="fas fa-exclamation-triangle attention-icon"></i> Noleggi da Verificare (da 5+ giorni)</h3> 
                          <ul id="oldest-rentals-list"> <li>Nessun noleggio attivo da verificare.</li> </ul> 
                      </div>
                  </div>

                  <!-- 3. STORICO E STAMPE -->
                  <div class="card">
                     <div class="card-header"> <h2>Storico e Stampe</h2> </div>
                     <div class="actions print-filters" style="flex-direction: column; align-items: stretch; gap: 10px;"> 
                         <div style="display:flex; gap:5px;">
                             <select id="print-month" class="form-control"> <option value="1">Gennaio</option><option value="2">Febbraio</option><option value="3">Marzo</option><option value="4">Aprile</option><option value="5">Maggio</option><option value="6">Giugno</option><option value="7">Luglio</option><option value="8">Agosto</option><option value="9">Settembre</option><option value="10">Ottobre</option><option value="11">Novembre</option><option value="12">Dicembre</option> </select> 
                             <input type="number" id="print-year" class="form-control" placeholder="Anno"> 
                         </div>
                         <button class="btn btn-primary" id="print-rentals-btn"> <i class="fas fa-print btn-icon"></i> Stampa </button> 
                         <button class="btn btn-secondary" id="manage-history-btn"> <i class="fas fa-tasks btn-icon"></i> Gestisci </button> 
                         <button class="btn btn-warning btn-sm" id="reset-completed-btn"> <i class="fas fa-trash-alt btn-icon"></i> Azzera </button> 
                     </div>
                     <div class="stats" style="margin-top:15px;"> 
                         <div class="stat-card"> <div class="stat-value" id="total-completed">0</div> <div class="stat-label">Completati</div> </div> 
                     </div>
                 </div>

                  <!-- 4. INVENTARIO COMPLETO (ACCORDION - Pulsante Nuovo Articolo) -->
                  <div class="card full-width-card">
                    <!-- Header Cliccabile -->
                    <div class="card-header" id="inventory-header"> 
                        <div style="display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-chevron-right" id="inventory-arrow" style="transition: transform 0.3s; color:#666;"></i>
                            <h2>Inventario Completo</h2> 
                        </div>
                        <div class="actions"> 
                            <!-- I bottoni rimangono visibili anche a tendina chiusa -->
                            <button class="btn btn-success" id="new-item-btn"> <i class="fas fa-plus btn-icon"></i> Nuovo </button> 
                            <button class="btn btn-primary" id="export-inventory-btn"> <i class="fas fa-file-export btn-icon"></i> Export </button> 
                        </div> 
                    </div>

                    <!-- Corpo della tendina (Nascosto di default) -->
                    <div id="inventory-body" class="hidden">
                        <div class="search-filter" style="margin-top: 15px;"> 
                            <input type="text" id="inventory-search" placeholder="Cerca articolo..."> 
                            <select id="filter-brand"> <option value="">Tutte le marche</option> </select> 
                            <select id="filter-status"> <option value="">Tutti gli stati</option> <option value="available">Disponibili</option> <option value="rented">Esauriti</option> </select> 
                        </div>
                        <div class="inventory-container"> 
                            <table id="inventory-table"> 
                                <thead> 
                                    <tr> 
                                        <th>Marca</th> 
                                        <th>Articolo</th> 
                                        <th class="text-center">Totale</th> 
                                        <th class="text-center">Disp.</th> 
                                        <th class="text-right">€/Giorno</th> 
                                        <th>Stato</th> 
                                        <th>Azioni</th> 
                                    </tr> 
                                </thead> 
                                <tbody></tbody> 
                            </table> 
                        </div>
                    </div>
                </div>

              </div>
          </div>
      </main>
  </div>

  <!-- MODALI -->
  <div id="rental-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">×</span>
        <h2 id="rental-modal-title">Nuovo Noleggio</h2>
        <form id="new-rental-form">
            <input type="hidden" id="rental-number-ongoing">
            <div class="form-group"> <label>Operatore:</label> <select id="rental-operator" required class="form-control"> <option value="">-- Seleziona --</option> </select> </div>
            <div class="form-group"> <label>Magazzino:</label> <select id="rental-warehouse" required class="form-control"> <option value="">-- Seleziona --</option> <option value="VILLALTA">VILLALTA</option> <option value="SAVIGNANO">SAVIGNANO</option> <option value="VILLAMARINA">VILLAMARINA</option> </select> </div>
            <div class="form-group"> <label>Cliente:</label> <input type="text" id="rental-client-name" required class="form-control"> </div >
            <div class="form-group"> <label>Data Inizio:</label> <input type="date" id="rental-start-date" required class="form-control"> </div>
            <hr>
            <div class="form-group"> <label>Marca:</label> <select id="rental-brand-selection" required class="form-control"> <option value="">-- Prima Marca --</option> </select> </div>
            <div class="form-group"> <label>Articolo:</label> <select id="rental-item-selection" required disabled class="form-control"> <option value="">-- Seleziona Marca --</option> </select> </div>
            <div class="form-group"> <label>Quantità:</label> <input type="number" id="rental-quantity" min="1" value="1" required class="form-control"> <small id="quantity-available-info" style="display: none; color: #666;"></small> </div>
            <div class="form-group"> <label>Note:</label> <textarea id="rental-notes" class="form-control"></textarea> </div>
            <button type="submit" class="btn btn-primary btn-block">Conferma</button>
        </form>
    </div>
  </div>

  <div id="edit-rental-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">×</span>
        <h2>Modifica Noleggio</h2>
        <form id="edit-rental-form">
            <input type="hidden" id="edit-rental-id">
            <input type="hidden" id="edit-rental-original-item-id">
            <input type="hidden" id="edit-rental-original-quantity">
            <fieldset disabled>
                <div class="form-group"> <label>Numero:</label> <input type="text" id="edit-rental-number-display" class="form-control"> </div>
                <div class="form-group"> <label>Magazzino:</label> <input type="text" id="edit-rental-warehouse-display" class="form-control"> </div>
                <div class="form-group"> <label>Data Inizio:</label> <input type="text" id="edit-rental-startdate-display" class="form-control"> </div>
            </fieldset>
            <div class="form-group"> <label>Cliente:</label> <input type="text" id="edit-rental-client-name" required class="form-control"> </div>
            <div class="form-group"> <label>Operatore:</label> <select id="edit-rental-operator" required class="form-control"></select> </div>
            <hr>
            <div class="form-group"> <label>Nuova Marca:</label> <select id="edit-rental-brand-selection" required class="form-control"></select> </div>
            <div class="form-group"> <label>Nuovo Articolo:</label> <select id="edit-rental-item-selection" required class="form-control" disabled></select> </div>
            <div class="form-group"> <label>Quantità:</label> <input type="number" id="edit-rental-quantity" min="1" required class="form-control"> <small id="edit-quantity-available-info" style="display:none;"></small> </div>
            <div class="form-group"> <label>Note:</label> <textarea id="edit-rental-notes" class="form-control"></textarea> </div>
            <button type="submit" class="btn btn-primary">Salva</button>
        </form>
    </div>
  </div>

  <div id="new-item-modal" class="modal">
      <div class="modal-content">
          <span class="close-btn">×</span>
          <h2>Nuovo Articolo</h2>
          <form id="new-item-form">
              <div class="form-group"> <label>Marca:</label> <input type="text" id="new-item-brand" required class="form-control"> </div>
              <div class="form-group"> <label>Nome:</label> <input type="text" id="new-item-name" required class="form-control"> </div>
              <div class="form-group"> <label>Quantità Tot:</label> <input type="number" id="new-item-quantity" min="1" value="1" required class="form-control"> </div>
              <div class="form-group"> <label>Costo Giorn. (€):</label> <input type="number" id="new-item-daily-rate" min="0" step="0.01" value="0.00" required class="form-control"> </div>
              <button type="submit" class="btn btn-primary">Aggiungi</button>
          </form>
      </div>
  </div>

  <div id="edit-item-modal" class="modal">
      <div class="modal-content">
          <span class="close-btn">×</span>
          <h2>Modifica Articolo</h2>
          <form id="edit-item-form">
              <input type="hidden" id="edit-item-id">
              <div class="form-group"> <label>Marca:</label> <input type="text" id="edit-item-brand" required class="form-control"> </div>
              <div class="form-group"> <label>Nome:</label> <input type="text" id="edit-item-name" required class="form-control"> </div>
              <div class="form-group"> <label>Quantità Tot:</label> <input type="number" id="edit-item-total-quantity" min="0" required class="form-control"> </div>
              <div class="form-group"> <label>Disponibili:</label> <input type="number" id="edit-item-available-quantity" min="0" required class="form-control"> </div>
              <div class="form-group"> <label>Costo Giorn. (€):</label> <input type="number" id="edit-item-daily-rate" min="0" step="0.01" required class="form-control"> </div>
              <button type="submit" class="btn btn-primary">Salva</button>
          </form>
      </div>
  </div>
  
  <div id="manage-history-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">×</span>
        <h2>Gestione Storico</h2>
        <div class="form-group">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="history-search-input" class="form-control" placeholder="Cerca...">
                <button id="history-search-btn" class="btn btn-primary">Cerca</button>
            </div>
        </div>
        <hr>
        <div id="history-results-container" style="max-height: 400px; overflow-y: auto;">
            <p style="color:#666; text-align:center;">Effettua una ricerca.</p>
        </div>
    </div>
  </div>

  <!-- 1. Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- 2. INIZIALIZZAZIONE FIREBASE PRIMA DI TUTTO -->
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y", 
        authDomain: "consorzio-artigiani-idraulici.firebaseapp.com",
        projectId: "consorzio-artigiani-idraulici",
        storageBucket: "consorzio-artigiani-idraulici.appspot.com",
        messagingSenderId: "136848104008",
        appId: "1:136848104008:web:2724f60607dbe91d09d67d"
    };
    // Inizializza subito
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    // Espone db e auth globalmente per code.js e components.js
    window.db = firebase.firestore();
    window.auth = firebase.auth();
  </script>

  <!-- 3. Componenti e Logica App -->
  <script src="/components.js"></script>
  <script src="code.js"></script> 

  <!-- 4. Logica Auth, Avvio e Accordion -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Layout
        initLayout("Gestione Noleggi Attrezzature");

        // Elementi UI
        const ui = {
            loader: document.getElementById('initial-loader'),
            login: document.getElementById('login-section'),
            app: document.getElementById('app-content'),
            loginForm: document.getElementById('login-form'),
            errorMsg: document.getElementById('login-error')
        };

        // Auth Listener
        window.auth.onAuthStateChanged(user => {
            if (user) {
                // Utente Loggato
                ui.login.classList.add('hidden');
                
                // Recupera Ruolo Utente
                window.db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        window.currentUserRole = (doc.exists && doc.data().role) ? doc.data().role : 'user';
                        
                        // AVVIA L'APP NOLEGGI
                        if (typeof window.initializeApp === 'function') {
                            window.initializeApp(window.currentUserRole);
                            ui.loader.style.display = 'none';
                            ui.app.classList.remove('hidden');
                        }
                    })
                    .catch(err => {
                        console.error("Errore ruolo:", err);
                        window.currentUserRole = 'user';
                        if (typeof window.initializeApp === 'function') window.initializeApp('user');
                        ui.loader.style.display = 'none';
                        ui.app.classList.remove('hidden');
                    });

            } else {
                // Utente NON Loggato
                ui.loader.style.display = 'none';
                ui.login.classList.remove('hidden');
                ui.app.classList.add('hidden');
            }
        });

        // Gestione Login Manuale
        if(ui.loginForm) {
            ui.loginForm.addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                ui.errorMsg.classList.add('hidden');
                
                window.auth.signInWithEmailAndPassword(email, pass).catch(err => {
                    ui.errorMsg.textContent = "Errore: " + err.message;
                    ui.errorMsg.classList.remove('hidden');
                });
            });
        }

        // --- AGGIUNTA: Logica Accordion Inventario ---
        // (Si attiva anche se code.js non è ancora partito, basta che il DOM sia pronto)
        const invHeader = document.getElementById('inventory-header');
        const invBody = document.getElementById('inventory-body');
        const invArrow = document.getElementById('inventory-arrow');

        if (invHeader && invBody && invArrow) {
            invHeader.addEventListener('click', (e) => {
                // Se clicchi sui pulsanti dentro l'header, non aprire la tendina
                if (e.target.closest('button') || e.target.closest('input')) return;

                if (invBody.classList.contains('hidden')) {
                    invBody.classList.remove('hidden'); // Mostra
                    invArrow.classList.remove('fa-chevron-right');
                    invArrow.classList.add('fa-chevron-down');
                } else {
                    invBody.classList.add('hidden'); // Nascondi
                    invArrow.classList.remove('fa-chevron-down');
                    invArrow.classList.add('fa-chevron-right');
                }
            });
        }
    });
  </script>
</body>
</html>
