// Wrap everything in an IIFE
(function () {
    'use strict';

    // --- Configuration & Global State ---
    const INITIAL_INVENTORY = [];
    const INVENTORY_LS_KEY = "inventory";
    const ACTIVE_RENTALS_LS_KEY = "activeRentals";
    const COMPLETED_RENTALS_LS_KEY = "completedRentals";
    const RENTAL_COUNTER_LS_KEY = "rentalCounter";
    const WAREHOUSES = ["VILLALTA", "SAVIGNANO", "VILLAMARINA"];
    const OPERATORS = ["DANIELE", "GIOVANNI", "LEANDRO", "LEONE", "LUCA", "MASSIMO", "MATTIA", "RAFFAELE", "SERGIO", "SEVERINO", "THOMAS"];
    const LOGO_URL = "https://i.postimg.cc/1XQtFBSX/logo-cai-removebg-preview.png";
    const MIN_DAYS_FOR_ATTENTION = 5;
    let ongoingRentalInfo = null;

    // --- Utility Functions ---
    const generateId = (prefix = 'id') => `${prefix}-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    const escapeHtml = (unsafe) => { if (typeof unsafe !== 'string') unsafe = String(unsafe); return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/'/g, "&#039;"); };
    const formatPrice = (value) => { const number = parseFloat(value); return isNaN(number) ? 'N/D' : number.toLocaleString('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
    const formatDate = (dateString) => { if (!dateString) return 'N/A'; try { const parts = dateString.split('-'); if (parts.length !== 3) return dateString; const date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); if (isNaN(date.getTime())) return 'Data non valida'; return new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' }).format(date); } catch (e) { console.error("Errore formattazione data:", dateString, e); return 'Errore data'; } };
    const getDaysDifference = (startDate, endDate) => { if (!startDate || !endDate) return 1; try { const start = new Date(startDate + 'T00:00:00Z'); const end = new Date(endDate + 'T00:00:00Z'); if (isNaN(start.getTime()) || isNaN(end.getTime())) return 1; const startUTC = Date.UTC(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate()); const endUTC = Date.UTC(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate()); if (endUTC < startUTC) return 1; const diffTime = endUTC - startUTC; return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; } catch (e) { console.error("Error calculating date difference:", startDate, endDate, e); return 1; } };
    const getDaysElapsed = (startDateString) => { if (!startDateString) return 0; try { const startDate = new Date(startDateString + 'T00:00:00Z'); if (isNaN(startDate.getTime())) return 0; const today = new Date(); const todayUTCStart = Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()); const startUTC = Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()); const diffTime = todayUTCStart - startUTC; return Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24))); } catch (e) { console.error("Error calculating days elapsed:", startDateString, e); return 0; } };
    const showError = (message) => alert(`[ERRORE] ${message}`);

    // --- LocalStorage Functions ---
    const getData = (key, defaultValue = []) => { try { const data = localStorage.getItem(key); return data ? JSON.parse(data) : defaultValue; } catch (error) { console.error(`Error reading ${key} from localStorage:`, error); showError(`Errore lettura dati (${key}).`); return defaultValue; } };
    const saveData = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch (error) { console.error(`Error saving ${key} to localStorage:`, error); showError(`Errore salvataggio dati (${key}).`); } };
    const getInventory = () => getData(INVENTORY_LS_KEY, INITIAL_INVENTORY);
    const saveInventory = (data) => saveData(INVENTORY_LS_KEY, data);
    const getActiveRentals = () => getData(ACTIVE_RENTALS_LS_KEY);
    const saveActiveRentals = (data) => saveData(ACTIVE_RENTALS_LS_KEY, data);
    const getCompletedRentals = () => getData(COMPLETED_RENTALS_LS_KEY);
    const saveCompletedRentals = (data) => saveData(COMPLETED_RENTALS_LS_KEY, data);

    // --- Rental Numbering ---
    const getNextRentalNumber = () => { let currentCounter = getData(RENTAL_COUNTER_LS_KEY, 0); if (typeof currentCounter !== 'number' || isNaN(currentCounter)) { console.warn("Rental counter invalid, resetting."); currentCounter = 0; } const nextNumber = currentCounter + 1; saveData(RENTAL_COUNTER_LS_KEY, nextNumber); return nextNumber; };

    // --- Main Application Initialization (La funzione verrà definita dopo) ---
    // Sarà chiamata con DOMContentLoaded

    // --- Funzioni definite nello scope globale dell'IIFE ---
    // (Queste funzioni possono essere chiamate da initializeApp e dai listener)

    const openModal = (modalId) => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) modalElement.style.display = 'block';
    };

    const closeModal = (modalElement) => {
        if (modalElement) modalElement.style.display = 'none';
        if (modalElement && modalElement.id === 'rental-modal') {
             resetOngoingRentalState();
        }
    };

    const resetOngoingRentalState = () => {
        ongoingRentalInfo = null;
        const numberInput = document.getElementById('rental-number-ongoing');
        const opSelect = document.getElementById('rental-operator');
        const whSelect = document.getElementById('rental-warehouse');
        const clientInput = document.getElementById('rental-client-name');
        const dateInput = document.getElementById('rental-start-date');
        const title = document.getElementById('rental-modal-title');
        if (numberInput) numberInput.value = '';
        if (opSelect) opSelect.disabled = false;
        if (whSelect) whSelect.disabled = false;
        if (clientInput) clientInput.disabled = false;
        if (dateInput) dateInput.disabled = false;
        if (title) title.textContent = "Nuovo Noleggio";
    };

    const updateBillingStats = () => { // Rimosso parametro, prende sempre da LS
         const totalCompletedStat = document.getElementById('total-completed');
         const totalClientsStat = document.getElementById('total-clients');
         try { const rentals = getCompletedRentals(); const clients = [...new Set(rentals.map(rental => rental.client))]; if (totalCompletedStat) totalCompletedStat.textContent = rentals.length; if (totalClientsStat) totalClientsStat.textContent = clients.length; } catch (err) { console.error("Error updating billing stats:", err); }
    }; // <-- Assicurati che questa graffa ci sia

    const updateStats = () => {
         const totalItemsStat = document.getElementById('total-items');
         const availableItemsStat = document.getElementById('available-items');
         const totalRentalsStat = document.getElementById('total-rentals');
         const itemsRentedStat = document.getElementById('items-rented');
         try { const inventory = getInventory(); const activeRentals = getActiveRentals(); if (totalItemsStat) totalItemsStat.textContent = inventory.reduce((sum, item) => sum + item.totalQuantity, 0); if (availableItemsStat) availableItemsStat.textContent = inventory.reduce((sum, item) => sum + item.availableQuantity, 0); if (totalRentalsStat) totalRentalsStat.textContent = activeRentals.length; if (itemsRentedStat) itemsRentedStat.textContent = activeRentals.reduce((sum, rental) => sum + rental.quantity, 0); updateBillingStats(); } catch (err) { console.error("Error updating stats:", err); }
    }; // <-- Assicurati che questa graffa ci sia

    const applyInventoryFilters = (inventory) => {
         const inventorySearchInput = document.getElementById('inventory-search');
         const filterBrandSelect = document.getElementById('filter-brand');
         const filterStatusSelect = document.getElementById('filter-status');
         const searchTerm = inventorySearchInput ? inventorySearchInput.value.toLowerCase() : ''; const brandFilter = filterBrandSelect ? filterBrandSelect.value : ''; const statusFilter = filterStatusSelect ? filterStatusSelect.value : ''; return inventory.filter(item => { const matchesSearch = !searchTerm || item.name.toLowerCase().includes(searchTerm) || item.brand.toLowerCase().includes(searchTerm); const matchesBrand = !brandFilter || item.brand === brandFilter; const isAvailable = item.availableQuantity > 0; const matchesStatus = !statusFilter || (statusFilter === 'available' && isAvailable) || (statusFilter === 'rented' && !isAvailable); return matchesSearch && matchesBrand && matchesStatus; });
    }; // <-- Assicurati che questa graffa ci sia

    const renderInventoryTable = (inventory) => {
         const inventoryTableBody = document.getElementById('inventory-table')?.querySelector('tbody');
         if (!inventoryTableBody) return; inventoryTableBody.innerHTML = ''; const filteredInventory = applyInventoryFilters(inventory); if (filteredInventory.length === 0) { inventoryTableBody.innerHTML = '<tr><td colspan="7" class="text-center" style="font-style:italic;">Nessun articolo trovato.</td></tr>'; return; } const fragment = document.createDocumentFragment(); filteredInventory.forEach(item => { const tr = document.createElement('tr'); tr.dataset.itemId = item.id; const status = item.availableQuantity > 0 ? '<span class="badge badge-success">Disponibile</span>' : '<span class="badge badge-danger">Esaurito</span>'; tr.innerHTML = `<td><i class="fas fa-tag"></i> ${escapeHtml(item.brand)}</td><td>${escapeHtml(item.name)}</td><td class="text-center">${item.totalQuantity}</td><td class="text-center">${item.availableQuantity}</td><td class="text-right">${formatPrice(item.dailyRate)}</td><td>${status}</td><td class="actions"><button class="btn btn-sm btn-warning btn-edit-item" data-id="${item.id}"><i class="fas fa-edit"></i> Modifica</button> <button class="btn btn-sm btn-danger btn-delete-item" data-id="${item.id}"><i class="fas fa-trash"></i> Elimina</button></td>`; fragment.appendChild(tr); }); inventoryTableBody.appendChild(fragment);
    }; // <-- Assicurati che questa graffa ci sia

    const populateItemDropdown = (selectedBrand, itemSelectElement, availableInfoElement = null, quantityInputElement = null, currentItemId = null, currentItemQuantity = 0) => {
         if (!itemSelectElement) return; itemSelectElement.innerHTML = ''; itemSelectElement.disabled = true; if(availableInfoElement) availableInfoElement.style.display = 'none'; if(quantityInputElement) { quantityInputElement.value = 1; quantityInputElement.max = null; } if (!selectedBrand) { itemSelectElement.innerHTML = '<option value="">-- Seleziona Marca Prima --</option>'; return; } const inventory = getInventory(); const itemsOfBrand = inventory.filter(item => item.brand === selectedBrand && (item.availableQuantity > 0 || item.id === currentItemId)); if (itemsOfBrand.length === 0) { itemSelectElement.innerHTML = `<option value="" disabled>Nessun articolo ${currentItemId ? '' : 'disponibile '}per ${escapeHtml(selectedBrand)}</option>`; return; } itemSelectElement.innerHTML = '<option value="">-- Seleziona Articolo --</option>'; itemsOfBrand.forEach(item => { const option = document.createElement('option'); option.value = item.id; let maxForThisItem = item.availableQuantity + (item.id === currentItemId ? currentItemQuantity : 0); option.dataset.max = maxForThisItem; option.textContent = `${escapeHtml(item.name)} (${item.availableQuantity} disp.)`; itemSelectElement.appendChild(option); }); if (currentItemId && itemsOfBrand.some(item => item.id === currentItemId)) { itemSelectElement.value = currentItemId; } itemSelectElement.disabled = false; if(itemSelectElement.value) { itemSelectElement.dispatchEvent(new Event('change')); } else if (quantityInputElement) { if(availableInfoElement) availableInfoElement.style.display = 'none'; quantityInputElement.max = null; }
    }; // <-- Assicurati che questa graffa ci sia

    const updateBrandFilters = (inventory, brandSelectElement, itemSelectElement = null, availableInfoElement = null, quantityInputElement = null, currentItemId = null, currentItemQuantity = 0) => {
         const brands = [...new Set(inventory.map(item => item.brand))].sort(); if (brandSelectElement) { const currentValue = brandSelectElement.value; brandSelectElement.innerHTML = '<option value="">Tutte le marche</option>'; brands.forEach(brand => { const option = document.createElement('option'); option.value = brand; option.textContent = escapeHtml(brand); brandSelectElement.appendChild(option); }); if (currentValue && brands.includes(currentValue)) { brandSelectElement.value = currentValue; } else { if (itemSelectElement) { populateItemDropdown(null, itemSelectElement, availableInfoElement, quantityInputElement, currentItemId, currentItemQuantity); } } } if (itemSelectElement) { populateItemDropdown(brandSelectElement ? brandSelectElement.value : null, itemSelectElement, availableInfoElement, quantityInputElement, currentItemId, currentItemQuantity); }
    }; // <-- Assicurati che questa graffa ci sia

    const loadInventoryData = () => {
        const inventory = getInventory();
        const filterBrandSelect = document.getElementById('filter-brand'); // Prendi l'elemento qui
        renderInventoryTable(inventory);
        if(filterBrandSelect) { // Controlla se esiste prima di usarlo
             updateBrandFilters(inventory, filterBrandSelect);
        }
        updateStats();
    }; // <-- Assicurati che questa graffa ci sia

    const renderActiveRentalsTable = (rentals) => { const activeRentalsTableBody = document.getElementById('active-rentals-table')?.querySelector('tbody'); if (!activeRentalsTableBody) return; activeRentalsTableBody.innerHTML = ''; const sortedRentals = rentals.sort((a, b) => { const dateA = a.startDate ? new Date(a.startDate) : 0; const dateB = b.startDate ? new Date(b.startDate) : 0; if (isNaN(dateA)) return 1; if (isNaN(dateB)) return -1; return dateB - dateA; }); if (sortedRentals.length === 0) { activeRentalsTableBody.innerHTML = '<tr><td colspan="7" class="text-center" style="font-style:italic;">Nessun noleggio attivo.</td></tr>'; return; } const fragment = document.createDocumentFragment(); sortedRentals.forEach(rental => { const tr = document.createElement('tr'); tr.dataset.rentalId = rental.id; tr.innerHTML = `<td>${escapeHtml(rental.rentalNumber || 'N/A')}</td><td>${escapeHtml(rental.itemName)} (${rental.quantity})</td><td>${escapeHtml(rental.client)}</td><td>${escapeHtml(rental.warehouse || 'N/D')}</td><td>${formatDate(rental.startDate)}</td><td><span class="badge badge-warning">Attivo</span></td><td class="actions"><button class="btn btn-sm btn-success btn-complete-rental" data-id="${rental.id}" title="Completa Noleggio"><i class="fas fa-check"></i></button> <button class="btn btn-sm btn-warning btn-edit-rental" data-id="${rental.id}" title="Modifica Noleggio"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-primary btn-reprint-rental" data-id="${rental.id}" title="Ristampa Ricevuta"><i class="fas fa-print"></i></button> <button class="btn btn-sm btn-danger btn-delete-rental" data-id="${rental.id}" title="Annulla Riga Noleggio"><i class="fas fa-times"></i></button></td>`; fragment.appendChild(tr); }); activeRentalsTableBody.appendChild(fragment); };
    const renderOldestRentals = (maxItems = 5) => { const oldestRentalsList = document.getElementById('oldest-rentals-list'); if (!oldestRentalsList) return; const activeRentals = getActiveRentals(); const rentalsNeedingAttention = activeRentals.filter(rental => getDaysElapsed(rental.startDate) >= MIN_DAYS_FOR_ATTENTION); const oldestPerRentalNumber = rentalsNeedingAttention.reduce((acc, rental) => { const key = rental.rentalNumber; if (!acc[key] || new Date(rental.startDate) < new Date(acc[key].startDate)) { acc[key] = rental; } return acc; }, {}); const uniqueOldestRentals = Object.values(oldestPerRentalNumber).sort((a, b) => new Date(a.startDate) - new Date(b.startDate)); const oldestToDisplay = uniqueOldestRentals.slice(0, maxItems); if (oldestToDisplay.length === 0) { oldestRentalsList.innerHTML = `<li>Nessun noleggio attivo da ${MIN_DAYS_FOR_ATTENTION} o più giorni.</li>`; return; } const fragment = document.createDocumentFragment(); oldestToDisplay.forEach(rental => { const li = document.createElement('li'); const daysElapsed = getDaysElapsed(rental.startDate); const daysElapsedText = ` - <span>${daysElapsed} gg fa</span>`; const itemsForThisRental = activeRentals.filter(r => r.rentalNumber === rental.rentalNumber); const itemsSummary = itemsForThisRental.map(r => `${r.itemName} (Q:${r.quantity})`).join(', '); li.innerHTML = `<span class="rental-details"><i class="fas fa-user" title="Noleggio #${rental.rentalNumber}, Mag: ${escapeHtml(rental.warehouse || 'N/D')}, Op: ${escapeHtml(rental.operator || 'N/D')}, Articoli: ${escapeHtml(itemsSummary)}"></i> ${escapeHtml(rental.client)} - Noleggio #${rental.rentalNumber}</span><span class="rental-date">${formatDate(rental.startDate)}${daysElapsedText}</span>`; fragment.appendChild(li); }); oldestRentalsList.innerHTML = ''; oldestRentalsList.appendChild(fragment); };
    const loadRentalData = () => { const rentals = getActiveRentals(); renderActiveRentalsTable(rentals); renderOldestRentals(); updateStats(); updateBillingStats(); };
    const populateOperatorDropdown = (selectElement) => { if (!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = '<option value="">-- Seleziona Operatore --</option>'; const sortedOperators = [...OPERATORS].sort((a, b) => a.localeCompare(b)); sortedOperators.forEach(opName => { const option = document.createElement('option'); option.value = opName; option.textContent = opName; selectElement.appendChild(option); }); if (currentValue && sortedOperators.includes(currentValue)) { selectElement.value = currentValue; } };
    const populateRentalBrandDropdown = () => {
         const rentalBrandSelect = document.getElementById('rental-brand-selection');
         const rentalItemSelect = document.getElementById('rental-item-selection');
         const quantityAvailableInfo = document.getElementById('quantity-available-info');
         const rentalQuantityInput = document.getElementById('rental-quantity');
         updateBrandFilters(getInventory(), rentalBrandSelect, rentalItemSelect, quantityAvailableInfo, rentalQuantityInput);
    };
    const printSingleRentalReceipt = (rentalDataArray) => { if (!Array.isArray(rentalDataArray) || rentalDataArray.length === 0) { showError("Errore: Dati ricevuta non validi."); return; } const commonData = rentalDataArray[0]; let itemsHtml = ''; rentalDataArray.forEach(item => { itemsHtml += `<div class="receipt-item"><strong>Descrizione:</strong> <span>${escapeHtml(item.itemName)}</span></div><div class="receipt-item"><strong>Quantità:</strong> <span>${escapeHtml(item.quantity)}</span></div>${item.notes ? `<div class="receipt-item"><strong>Note Articolo:</strong> <span>${escapeHtml(item.notes)}</span></div>` : ''}<div style="border-bottom: 1px dotted #eee; margin: 5px 0;"></div>`; }); itemsHtml = itemsHtml.substring(0, itemsHtml.lastIndexOf('<div style="border-bottom')); let receiptHtml = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Ricevuta Noleggio #${commonData.rentalNumber}</title><style>body{font-family:Arial,sans-serif;font-size:11pt;margin:15mm;} .receipt-header{display:flex;align-items:center;gap:20px;margin-bottom:25px;border-bottom:2px solid #000;padding-bottom:15px;} .receipt-header img{max-height:85px;width:auto;flex-shrink:0;} .receipt-header h1{margin:0;font-size:18pt;text-align:left;flex-grow:1;} .receipt-section{margin-bottom:20px; padding-bottom: 15px; border-bottom: 1px dashed #ccc;} .receipt-section:last-of-type { border-bottom: none; } .receipt-section h2 {font-size: 14pt; margin-bottom: 10px; color: #333; } .receipt-item{display: flex; justify-content: space-between; margin-bottom: 8px; line-height:1.5;} .receipt-item strong{font-weight: bold; min-width: 150px; padding-right: 10px;} .receipt-item span{text-align: left; flex-grow: 1;} .receipt-signature { margin-top: 50px; padding-top: 15px; border-top: 1px solid #ccc; } .receipt-signature p { margin-bottom: 40px; } .signature-line { border-bottom: 1px solid #000; width: 70%; margin: 0 auto; } .signature-label { text-align: center; font-size: 9pt; color: #555; margin-top: 5px; } .footer { margin-top: 40px; font-size: 9pt; color: #555; text-align: center; border-top: 1px solid #ccc; padding-top: 15px; } @page{size:A4;margin:15mm;} @media print{body{margin:15mm;font-size:11pt}}</style></head><body><div class="receipt-header"><img src="${LOGO_URL}" alt="Logo CAI Idraulica"><h1>Documento di Noleggio</h1></div><div class="receipt-section"><h2>Dettagli Noleggio</h2><div class="receipt-item"><strong>Numero Noleggio:</strong> <span>${escapeHtml(commonData.rentalNumber || 'N/A')}</span></div><div class="receipt-item"><strong>Data Noleggio:</strong> <span>${formatDate(commonData.startDate)}</span></div><div class="receipt-item"><strong>Magazzino:</strong> <span>${escapeHtml(commonData.warehouse || 'N/D')}</span></div><div class="receipt-item"><strong>Operatore:</strong> <span>${escapeHtml(commonData.operator || 'N/D')}</span></div></div><div class="receipt-section"><h2>Cliente</h2> <div class="receipt-item"><strong>Nominativo:</strong> <span>${escapeHtml(commonData.client)}</span></div></div> <div class="receipt-section"><h2>Articoli Noleggiati</h2> ${itemsHtml} </div> <div class="receipt-signature"><p>Firma per presa visione e accettazione:</p><div class="signature-line"></div><div class="signature-label">(Firma del Cliente)</div></div><div class="footer">Grazie per aver scelto il C.A.I. Consorzio Artigiani Idraulici! <br>Documento generato il: ${new Date().toLocaleString('it-IT')}</div> <script>window.onload=function(){ try { window.print(); window.close(); } catch(e) { console.error('Print failed:', e); } };<\/script></body></html>`; const printWindow = window.open('', '_blank'); if (printWindow) { printWindow.document.open(); printWindow.document.write(receiptHtml); printWindow.document.close(); } else { showError("Impossibile aprire finestra stampa ricevuta."); } };
    const setDefaultPrintDate = () => { const printMonthSelect = document.getElementById('print-month'); const printYearInput = document.getElementById('print-year'); try { const today = new Date(); const currentMonth = today.getMonth() + 1; const currentYear = today.getFullYear(); if (printMonthSelect) printMonthSelect.value = currentMonth; if (printYearInput) printYearInput.value = currentYear; } catch (err) { console.error("Error setting default print date:", err); } };
    const prepareModalForAdditionalItem = (rentalInfo) => {
        const rentalNumberOngoingInput = document.getElementById('rental-number-ongoing');
        const rentalOperatorSelect = document.getElementById('rental-operator');
        const rentalWarehouseSelect = document.getElementById('rental-warehouse');
        const rentalClientNameInput = document.getElementById('rental-client-name');
        const rentalStartDateInput = document.getElementById('rental-start-date');
        const rentalBrandSelect = document.getElementById('rental-brand-selection');
        const rentalItemSelect = document.getElementById('rental-item-selection');
        const quantityAvailableInfo = document.getElementById('quantity-available-info');
        const rentalQuantityInput = document.getElementById('rental-quantity');
        const rentalNotesTextarea = document.getElementById('rental-notes');
        const rentalModalTitle = document.getElementById('rental-modal-title');
        if (!rentalInfo) return; if(rentalNumberOngoingInput) rentalNumberOngoingInput.value = rentalInfo.rentalNumber; if (rentalOperatorSelect) { rentalOperatorSelect.value = rentalInfo.operator; rentalOperatorSelect.disabled = true; } if (rentalWarehouseSelect) { rentalWarehouseSelect.value = rentalInfo.warehouse; rentalWarehouseSelect.disabled = true; } if (rentalClientNameInput) { rentalClientNameInput.value = rentalInfo.client; rentalClientNameInput.disabled = true; } if (rentalStartDateInput) { rentalStartDateInput.value = rentalInfo.startDate; rentalStartDateInput.disabled = true; } if (rentalBrandSelect) rentalBrandSelect.value = ""; populateItemDropdown(null, rentalItemSelect, quantityAvailableInfo, rentalQuantityInput); if (rentalQuantityInput) rentalQuantityInput.value = 1; if (quantityAvailableInfo) quantityAvailableInfo.style.display = 'none'; if (rentalNotesTextarea) rentalNotesTextarea.value = ""; if (rentalModalTitle) rentalModalTitle.textContent = `Aggiungi Articolo a Noleggio #${rentalInfo.rentalNumber}`; openModal('rental-modal'); rentalBrandSelect?.focus();
    };

    // --- Main Application Initialization ---
    const initializeApp = () => {
        console.log("Initializing application...");

        // --- DOM Element References ---
        const inventoryTableBody = document.getElementById('inventory-table')?.querySelector('tbody');
        const activeRentalsTableBody = document.getElementById('active-rentals-table')?.querySelector('tbody');
        const inventorySearchInput = document.getElementById('inventory-search');
        const filterBrandSelect = document.getElementById('filter-brand');
        const filterStatusSelect = document.getElementById('filter-status');
        const newItemBtn = document.getElementById('new-item-btn');
        const newItemModal = document.getElementById('new-item-modal');
        const newItemForm = document.getElementById('new-item-form');
        const editItemModal = document.getElementById('edit-item-modal');
        const editItemForm = document.getElementById('edit-item-form');
        const newRentalBtn = document.getElementById('new-rental-btn');
        const rentalModal = document.getElementById('rental-modal');
        const rentalForm = document.getElementById('new-rental-form');
        const rentalBrandSelect = document.getElementById('rental-brand-selection');
        const rentalItemSelect = document.getElementById('rental-item-selection');
        const rentalQuantityInput = document.getElementById('rental-quantity');
        const quantityAvailableInfo = document.getElementById('quantity-available-info');
        const rentalWarehouseSelect = document.getElementById('rental-warehouse');
        const rentalClientNameInput = document.getElementById('rental-client-name');
        const rentalOperatorSelect = document.getElementById('rental-operator');
        const rentalStartDateInput = document.getElementById('rental-start-date');
        const rentalNotesTextarea = document.getElementById('rental-notes');
        const editRentalModal = document.getElementById('edit-rental-modal');
        const editRentalForm = document.getElementById('edit-rental-form');
        const editRentalIdInput = document.getElementById('edit-rental-id');
        const editRentalOriginalItemIdInput = document.getElementById('edit-rental-original-item-id');
        const editRentalOriginalQuantityInput = document.getElementById('edit-rental-original-quantity');
        const editRentalNumberDisplay = document.getElementById('edit-rental-number-display');
        const editRentalWarehouseDisplay = document.getElementById('edit-rental-warehouse-display');
        const editRentalStartDateDisplay = document.getElementById('edit-rental-startdate-display');
        const editRentalClientNameInput = document.getElementById('edit-rental-client-name');
        const editRentalOperatorSelect = document.getElementById('edit-rental-operator');
        const editRentalBrandSelection = document.getElementById('edit-rental-brand-selection');
        const editRentalItemSelection = document.getElementById('edit-rental-item-selection');
        const editRentalQuantityInput = document.getElementById('edit-rental-quantity');
        const editQuantityAvailableInfo = document.getElementById('edit-quantity-available-info');
        const editRentalNotesTextarea = document.getElementById('edit-rental-notes');
        const allModals = document.querySelectorAll('.modal');
        const exportInventoryBtn = document.getElementById('export-inventory-btn');
        const resetInventoryBtn = document.getElementById('reset-inventory');
        const excelUploadInput = document.getElementById('excel-upload');
        const printRentalsBtn = document.getElementById('print-rentals-btn');
        const printMonthSelect = document.getElementById('print-month');
        const printYearInput = document.getElementById('print-year');
        const resetCompletedBtn = document.getElementById('reset-completed-btn');

        // --- Event Handlers & Actions Setup ---
        try {
            // Modal Close Handlers
            allModals.forEach(modal => { const closeBtn = modal.querySelector('.close-btn'); if(closeBtn) { closeBtn.addEventListener('click', () => closeModal(modal)); } });
            window.addEventListener('click', (event) => { allModals.forEach(modal => { if (event.target == modal) closeModal(modal); }); });

            // --- Inventory Actions ---
            if (excelUploadInput) { excelUploadInput.addEventListener('change', function(e) {
                const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(event) { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); if (jsonData.length < 2) throw new Error("File Excel vuoto o solo intestazione."); const header = jsonData[0].map(h => String(h).trim().toLowerCase()); const brandIndex = header.indexOf('marca'); const nameIndex = header.indexOf('articolo'); const quantityIndex = header.indexOf("quantita'"); const priceIndex = header.indexOf('costo'); const warehouseIndex = header.indexOf('magazzino'); if ([brandIndex, nameIndex, quantityIndex, priceIndex, warehouseIndex].some(index => index === -1)) { throw new Error("Intestazioni mancanti/errate: servono 'marca', 'articolo', 'quantita'', 'costo', 'magazzino'."); } const WAREHOUSES_UPPER = WAREHOUSES.map(w => w.toUpperCase()); const newInventory = jsonData.slice(1).map((row, rowIndex) => { const brand = row[brandIndex] ? String(row[brandIndex]).trim() : null; const name = row[nameIndex] ? String(row[nameIndex]).trim() : null; const totalQuantity = row[quantityIndex] !== undefined && row[quantityIndex] !== null ? parseInt(row[quantityIndex]) : null; const dailyRate = row[priceIndex] !== undefined && row[priceIndex] !== null ? parseFloat(String(row[priceIndex]).replace(',', '.')) : null; const warehouseRaw = row[warehouseIndex] ? String(row[warehouseIndex]).trim() : null; const warehouse = warehouseRaw ? warehouseRaw.toUpperCase() : null; if (!brand || !name || totalQuantity === null || isNaN(totalQuantity) || totalQuantity < 0 || dailyRate === null || isNaN(dailyRate) || dailyRate < 0 || !warehouse) { console.warn(`Riga ${rowIndex + 2}: Dati mancanti/invalidi. Ignorato.`); return null; } if (!WAREHOUSES_UPPER.includes(warehouse)) { console.warn(`Riga ${rowIndex + 2}: Magazzino '${warehouseRaw}' non valido. Ignorato.`); return null; } return { id: generateId('item'), brand: brand, name: name, totalQuantity: totalQuantity, availableQuantity: totalQuantity, dailyRate: dailyRate }; }).filter(item => item !== null); if (newInventory.length === 0) { throw new Error("Nessun articolo valido trovato nel file Excel."); } if (confirm(`Importare ${newInventory.length} articoli? L'inventario corrente verrà SOSTITUITO.`)) { saveInventory(newInventory); loadInventoryData(); alert("Inventario importato con successo."); } } catch (err) { console.error("Error processing Excel file:", err); showError(`Errore importazione Excel: ${err.message}`); } finally { if (excelUploadInput) excelUploadInput.value = ''; } }; reader.onerror = function(event) { console.error("File read error:", event.target.error.code); showError("Impossibile leggere il file."); if (excelUploadInput) excelUploadInput.value = ''; }; reader.readAsArrayBuffer(file);
            }); }
            if (exportInventoryBtn) { exportInventoryBtn.addEventListener('click', function() {
                 try { const inventory = getInventory(); if (inventory.length === 0) { showError("Inventario vuoto."); return; } const dataToExport = [ ["marca", "articolo", "quantita'", "costo", "Disponibili"] ]; inventory.forEach(item => { dataToExport.push([ item.brand, item.name, item.totalQuantity, item.dailyRate, item.availableQuantity ]); }); const worksheet = XLSX.utils.aoa_to_sheet(dataToExport); worksheet['!cols'] = [ { wch: 20 }, { wch: 35 }, { wch: 12 }, { wch: 12 }, { wch: 12 }]; const priceColRange = XLSX.utils.decode_range(worksheet['!ref']); for (let R = priceColRange.s.r + 1; R <= priceColRange.e.r; ++R) { const cellRef = XLSX.utils.encode_cell({ c: 3, r: R }); if(!worksheet[cellRef]) continue; worksheet[cellRef].t = 'n'; worksheet[cellRef].z = '#,##0.00 €'; } const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario"); const today = new Date().toISOString().slice(0, 10); XLSX.writeFile(workbook, `Inventario_CAI_${today}.xlsx`); } catch (err) { console.error("Error exporting inventory:", err); showError("Errore esportazione inventario."); }
            }); }
            if (resetInventoryBtn) { resetInventoryBtn.addEventListener('click', function() {
                const activeRentals = getActiveRentals(); if(activeRentals.length > 0) { showError("Impossibile resettare: ci sono noleggi attivi."); return; } if (confirm("CANCELLARE tutto l'inventario? Azione irreversibile.")) { saveInventory([]); saveData(RENTAL_COUNTER_LS_KEY, 0); loadInventoryData(); loadRentalData(); alert("Inventario resettato."); }
            }); }
            [inventorySearchInput, filterBrandSelect, filterStatusSelect].forEach(el => { if (el) { el.addEventListener('input', () => renderInventoryTable(getInventory())); } });
            if (newItemBtn) { newItemBtn.addEventListener('click', () => {
                 if (newItemForm) newItemForm.reset(); openModal('new-item-modal'); document.getElementById('new-item-brand')?.focus();
            }); }
            if (newItemForm) { newItemForm.addEventListener('submit', (e) => {
                e.preventDefault(); try { const brand = document.getElementById('new-item-brand')?.value.trim(); const name = document.getElementById('new-item-name')?.value.trim(); const quantityInput = document.getElementById('new-item-quantity'); const rateInput = document.getElementById('new-item-daily-rate'); const quantity = quantityInput ? parseInt(quantityInput.value) : null; const dailyRate = rateInput ? parseFloat(rateInput.value) : null; if (!brand || !name || quantity === null || isNaN(quantity) || quantity < 0 || dailyRate === null || isNaN(dailyRate) || dailyRate < 0) { showError('Compila correttamente tutti i campi.'); return; } const newItem = { id: generateId('item'), brand: brand, name: name, totalQuantity: quantity, availableQuantity: quantity, dailyRate: dailyRate }; const inventory = getInventory(); saveInventory([...inventory, newItem]); loadInventoryData(); closeModal(newItemModal); } catch (err) { console.error("Error adding new item:", err); showError("Errore aggiunta nuovo articolo."); }
            }); }
            if (inventoryTableBody) { inventoryTableBody.addEventListener('click', (e) => {
                if (e.target.closest('.btn-edit-item')) { const button = e.target.closest('.btn-edit-item'); const itemId = button.dataset.id; const inventory = getInventory(); const itemToEdit = inventory.find(item => item.id === itemId); if (itemToEdit && editItemModal && editItemForm) { document.getElementById('edit-item-id').value = itemToEdit.id; document.getElementById('edit-item-brand').value = itemToEdit.brand; document.getElementById('edit-item-name').value = itemToEdit.name; document.getElementById('edit-item-total-quantity').value = itemToEdit.totalQuantity; document.getElementById('edit-item-available-quantity').value = itemToEdit.availableQuantity; document.getElementById('edit-item-daily-rate').value = itemToEdit.dailyRate; openModal('edit-item-modal'); } else { showError("Articolo non trovato per modifica."); } }
                else if (e.target.closest('.btn-delete-item')) { const button = e.target.closest('.btn-delete-item'); const itemId = button.dataset.id; const inventory = getInventory(); const itemToDelete = inventory.find(item => item.id === itemId); if (itemToDelete) { const activeRentals = getActiveRentals(); const isRented = activeRentals.some(rental => rental.itemId === itemId); if (isRented) { showError(`Impossibile eliminare "${itemToDelete.brand} ${itemToDelete.name}": articolo noleggiato.`); return; } if (confirm(`Eliminare "${itemToDelete.brand} ${itemToDelete.name}"?`)) { const updatedInventory = inventory.filter(item => item.id !== itemId); saveInventory(updatedInventory); loadInventoryData(); } } else { showError("Articolo non trovato per eliminazione."); } }
            }); }
            if (editItemForm) { editItemForm.addEventListener('submit', (e) => {
                 e.preventDefault(); try { const id = document.getElementById('edit-item-id')?.value; const brand = document.getElementById('edit-item-brand')?.value.trim(); const name = document.getElementById('edit-item-name')?.value.trim(); const totalQuantityInput = document.getElementById('edit-item-total-quantity'); const availableQuantityInput = document.getElementById('edit-item-available-quantity'); const dailyRateInput = document.getElementById('edit-item-daily-rate'); const totalQuantity = totalQuantityInput ? parseInt(totalQuantityInput.value) : null; const availableQuantity = availableQuantityInput ? parseInt(availableQuantityInput.value) : null; const dailyRate = dailyRateInput ? parseFloat(dailyRateInput.value) : null; if (!id || !brand || !name || totalQuantity === null || isNaN(totalQuantity) || totalQuantity < 0 || availableQuantity === null || isNaN(availableQuantity) || availableQuantity < 0 || dailyRate === null || isNaN(dailyRate) || dailyRate < 0) { showError('Compila correttamente tutti i campi.'); return; } if (availableQuantity > totalQuantity) { showError('Disponibile non può superare Totale.'); return; } const inventory = getInventory(); const originalItem = inventory.find(item => item.id === id); if (!originalItem) { showError("Errore: Articolo originale non trovato."); return; } const rentedQuantity = originalItem.totalQuantity - originalItem.availableQuantity; if (totalQuantity < rentedQuantity) { showError(`Nuova Q.tà Totale (${totalQuantity}) < Q.tà Noleggiata (${rentedQuantity}). Non consentito.`); return; } if (availableQuantity < totalQuantity - rentedQuantity) { showError(`Nuova Q.tà Disponibile (${availableQuantity}) < ${totalQuantity - rentedQuantity} (Totale - Noleggiati). Non consentito.`); return; } const updatedInventory = inventory.map(item => item.id === id ? { ...item, brand, name, totalQuantity, availableQuantity, dailyRate } : item ); saveInventory(updatedInventory); loadInventoryData(); closeModal(editItemModal); } catch (err) { console.error("Error saving item edits:", err); showError("Errore salvataggio modifiche articolo."); }
            }); }

            // --- Rental Actions ---
            if (newRentalBtn) { newRentalBtn.addEventListener('click', () => {
                 resetOngoingRentalState(); if (rentalForm) rentalForm.reset();
                 populateOperatorDropdown(rentalOperatorSelect);
                 populateRentalBrandDropdown(); // Popola marche per il modal
                 if (rentalItemSelect) { rentalItemSelect.innerHTML = '<option value="">-- Seleziona Marca Prima --</option>'; rentalItemSelect.disabled = true; } // Reset esplicito
                 if (quantityAvailableInfo) quantityAvailableInfo.style.display = 'none';
                 if (rentalWarehouseSelect) rentalWarehouseSelect.value = '';
                 const today = new Date().toISOString().split('T')[0];
                 if (rentalStartDateInput) rentalStartDateInput.value = today;
                 openModal('rental-modal'); rentalOperatorSelect?.focus();
            }); }
            if (rentalBrandSelect) { rentalBrandSelect.addEventListener('change', (e) => { populateItemDropdown(e.target.value, rentalItemSelect, quantityAvailableInfo, rentalQuantityInput); }); }
            if (rentalItemSelect) { rentalItemSelect.addEventListener('change', (e) => { const infoElement = quantityAvailableInfo; const selectedOption = e.target.options[e.target.selectedIndex]; const maxQuantity = selectedOption?.dataset.max ? parseInt(selectedOption.dataset.max) : 0; if (rentalQuantityInput) { rentalQuantityInput.max = maxQuantity > 0 ? maxQuantity : null; rentalQuantityInput.value = 1; if (maxQuantity > 0 && infoElement) { infoElement.textContent = `Disponibili: ${maxQuantity}`; infoElement.style.display = 'block'; } else if (infoElement) { infoElement.style.display = 'none'; } } }); }
            if (rentalQuantityInput) { rentalQuantityInput.addEventListener('input', (e) => { const max = parseInt(e.target.max); const currentVal = parseInt(e.target.value); if (!isNaN(max) && !isNaN(currentVal) && currentVal > max) { e.target.value = max; showError(`Quantità massima disponibile: ${max}`); } if (!isNaN(currentVal) && currentVal < 1) { e.target.value = 1; } }); }
            if (rentalForm) { rentalForm.addEventListener('submit', (e) => {
                 e.preventDefault(); try { const operator = rentalOperatorSelect.value; const warehouse = rentalWarehouseSelect.value; const clientName = rentalClientNameInput.value.trim().toUpperCase(); const startDate = rentalStartDateInput.value; const brand = rentalBrandSelect.value; const itemId = rentalItemSelect.value; const quantity = rentalQuantityInput ? parseInt(rentalQuantityInput.value) : 0; const notes = rentalNotesTextarea.value.trim().toUpperCase(); if (!operator || !warehouse || !clientName || !startDate || !brand || !itemId || isNaN(quantity) || quantity < 1) { showError('Completa tutti i campi richiesti.'); return; } const inventory = getInventory(); const selectedItem = inventory.find(item => item.id === itemId); if (!selectedItem) { showError('Articolo non trovato.'); populateRentalBrandDropdown(); return; } if (selectedItem.availableQuantity < quantity) { showError(`Solo ${selectedItem.availableQuantity} di "${selectedItem.name}" disp.`); return; } let currentRentalNumber; let isNewRental = true; if (ongoingRentalInfo && ongoingRentalInfo.rentalNumber) { currentRentalNumber = ongoingRentalInfo.rentalNumber; isNewRental = false; } else { currentRentalNumber = getNextRentalNumber(); } const rental = { id: generateId('rental'), rentalNumber: currentRentalNumber, itemId: selectedItem.id, itemName: `${selectedItem.brand} ${selectedItem.name}`, client: clientName, quantity: quantity, startDate: startDate, operator: operator, notes: notes, status: "active", dailyRate: selectedItem.dailyRate, warehouse: warehouse }; saveInventory(inventory.map(item => item.id === selectedItem.id ? { ...item, availableQuantity: item.availableQuantity - quantity } : item )); saveActiveRentals([...getActiveRentals(), rental]); loadInventoryData(); loadRentalData(); ongoingRentalInfo = { rentalNumber: currentRentalNumber, operator: operator, client: clientName, warehouse: warehouse, startDate: startDate }; const currentRentalItems = getActiveRentals().filter(r => r.rentalNumber === currentRentalNumber); printSingleRentalReceipt(currentRentalItems); if (confirm(`Noleggio #${currentRentalNumber} per ${clientName}\nArticolo "${rental.itemName}" aggiunto.\n\nVuoi aggiungere un altro articolo allo stesso noleggio?`)) { prepareModalForAdditionalItem(ongoingRentalInfo); } else { resetOngoingRentalState(); closeModal(rentalModal); } } catch (err) { console.error("Error in rentalForm submit:", err); showError("Errore aggiunta/conferma noleggio."); resetOngoingRentalState(); }
            }); }
            if (activeRentalsTableBody) { activeRentalsTableBody.addEventListener('click', (e) => {
                 if (e.target.closest('.btn-complete-rental')) { const button = e.target.closest('.btn-complete-rental'); const rentalId = button.dataset.id; const activeRentals = getActiveRentals(); const rentalToComplete = activeRentals.find(r => r.id === rentalId); if (rentalToComplete) { const today = new Date().toISOString().split('T')[0]; const endDate = prompt(`Data fine noleggio per #${rentalToComplete.rentalNumber} (${rentalToComplete.itemName}) (AAAA-MM-GG):`, today); if (endDate && /^\d{4}-\d{2}-\d{2}$/.test(endDate)) { const startDateObj = new Date(rentalToComplete.startDate + 'T00:00:00Z'); const endDateObj = new Date(endDate + 'T00:00:00Z'); if (endDateObj < startDateObj) { showError("Data fine non può precedere data inizio."); return; } const completedRental = { ...rentalToComplete, endDate: endDate, status: "completed" }; saveCompletedRentals([...getCompletedRentals(), completedRental]); saveActiveRentals(activeRentals.filter(r => r.id !== rentalId)); const inventory = getInventory(); saveInventory(inventory.map(item => item.id === completedRental.itemId ? { ...item, availableQuantity: item.availableQuantity + completedRental.quantity } : item )); loadInventoryData(); loadRentalData(); } else if (endDate !== null) { showError("Formato data non valido (AAAA-MM-GG)."); } } else { showError("Riga noleggio non trovata per completamento."); } }
                 else if (e.target.closest('.btn-edit-rental')) { const button = e.target.closest('.btn-edit-rental'); const rentalId = button.dataset.id; const activeRentals = getActiveRentals(); const rentalToEdit = activeRentals.find(r => r.id === rentalId); if (!rentalToEdit) { showError("Noleggio non trovato per modifica."); return; } if (editRentalModal && editRentalForm) { editRentalIdInput.value = rentalToEdit.id; editRentalOriginalItemIdInput.value = rentalToEdit.itemId; editRentalOriginalQuantityInput.value = rentalToEdit.quantity; editRentalNumberDisplay.value = rentalToEdit.rentalNumber || 'N/A'; editRentalWarehouseDisplay.value = rentalToEdit.warehouse || 'N/D'; editRentalStartDateDisplay.value = formatDate(rentalToEdit.startDate); editRentalClientNameInput.value = rentalToEdit.client; populateOperatorDropdown(editRentalOperatorSelect); editRentalOperatorSelect.value = rentalToEdit.operator || ""; editRentalNotesTextarea.value = rentalToEdit.notes || ""; const inventory = getInventory(); const originalItemDetails = inventory.find(i => i.id === rentalToEdit.itemId); updateBrandFilters(inventory, editRentalBrandSelection, editRentalItemSelection, editQuantityAvailableInfo, editRentalQuantityInput, rentalToEdit.itemId, rentalToEdit.quantity); if (originalItemDetails) { editRentalBrandSelection.value = originalItemDetails.brand; populateItemDropdown(originalItemDetails.brand, editRentalItemSelection, editQuantityAvailableInfo, editRentalQuantityInput, rentalToEdit.itemId, rentalToEdit.quantity); } else { populateItemDropdown(null, editRentalItemSelection, editQuantityAvailableInfo, editRentalQuantityInput); } editRentalQuantityInput.value = rentalToEdit.quantity; if (editRentalItemSelection.value) { editRentalItemSelection.dispatchEvent(new Event('change')); } openModal('edit-rental-modal'); } else { showError("Errore apertura modulo modifica."); } }
                 else if (e.target.closest('.btn-reprint-rental')) { const button = e.target.closest('.btn-reprint-rental'); const rentalId = button.dataset.id; const activeRentals = getActiveRentals(); const rentalToPrint = activeRentals.find(r => r.id === rentalId); if (rentalToPrint) { const allItemsForRental = activeRentals.filter(r => r.rentalNumber === rentalToPrint.rentalNumber); printSingleRentalReceipt(allItemsForRental); } else { showError("Noleggio non trovato per ristampa."); } }
                 else if (e.target.closest('.btn-delete-rental')) { const button = e.target.closest('.btn-delete-rental'); const rentalId = button.dataset.id; const activeRentals = getActiveRentals(); const rentalToDelete = activeRentals.find(r => r.id === rentalId); if (rentalToDelete) { if (confirm(`Annullare riga?\nArticolo: ${rentalToDelete.itemName} (Q: ${rentalToDelete.quantity})\nNoleggio #: ${rentalToDelete.rentalNumber}\n\nL'articolo tornerà disponibile.`)) { saveActiveRentals(activeRentals.filter(r => r.id !== rentalId)); const inventory = getInventory(); saveInventory(inventory.map(item => item.id === rentalToDelete.itemId ? { ...item, availableQuantity: item.availableQuantity + rentalToDelete.quantity } : item )); loadInventoryData(); loadRentalData(); } } else { showError("Riga noleggio non trovata per annullamento."); } }
            }); }
            if (editRentalBrandSelection) { editRentalBrandSelection.addEventListener('change', (e) => { const originalItemId = editRentalOriginalItemIdInput.value; const originalQuantity = parseInt(editRentalOriginalQuantityInput.value) || 0; populateItemDropdown(e.target.value, editRentalItemSelection, editQuantityAvailableInfo, editRentalQuantityInput, originalItemId, originalQuantity); }); }
            if (editRentalItemSelection) { editRentalItemSelection.addEventListener('change', (e) => { const selectedOption = e.target.options[e.target.selectedIndex]; const maxQuantity = selectedOption?.dataset.max ? parseInt(selectedOption.dataset.max) : 0; if (editRentalQuantityInput) { editRentalQuantityInput.max = maxQuantity > 0 ? maxQuantity : null; if (editQuantityAvailableInfo) { editQuantityAvailableInfo.textContent = `Disponibili (incl. originale se stesso articolo): ${maxQuantity}`; editQuantityAvailableInfo.style.display = 'block'; } } else if (editQuantityAvailableInfo) { editQuantityAvailableInfo.style.display = 'none'; } }); }
            if (editRentalQuantityInput) { editRentalQuantityInput.addEventListener('input', (e) => { const max = parseInt(e.target.max); const currentVal = parseInt(e.target.value); if (!isNaN(max) && !isNaN(currentVal) && currentVal > max) { e.target.value = max; showError(`Quantità massima disponibile (incl. originale se stesso articolo): ${max}`); } if (!isNaN(currentVal) && currentVal < 1) { e.target.value = 1; } }); }
            if(editRentalForm) { editRentalForm.addEventListener('submit', (e) => {
                 e.preventDefault(); try { const rentalId = editRentalIdInput.value; const originalItemId = editRentalOriginalItemIdInput.value; const originalQuantity = parseInt(editRentalOriginalQuantityInput.value) || 0; const newClientName = editRentalClientNameInput.value.trim().toUpperCase(); const newOperator = editRentalOperatorSelect.value; const newItemId = editRentalItemSelection.value; const newQuantity = editRentalQuantityInput ? parseInt(editRentalQuantityInput.value) : 0; const newNotes = editRentalNotesTextarea.value.trim().toUpperCase(); if (!rentalId || !newClientName || !newOperator || !newItemId || isNaN(newQuantity) || newQuantity < 1) { showError("Cliente, Operatore, Articolo e Quantità obbligatori."); return; } const inventory = getInventory(); const activeRentals = getActiveRentals(); const originalRentalRow = activeRentals.find(r => r.id === rentalId); const newItemData = inventory.find(i => i.id === newItemId); if (!originalRentalRow) { showError("Errore: Riga noleggio originale non trovata."); return; } if (!newItemData) { showError("Errore: Nuovo articolo non trovato."); return; } let currentAvailable = newItemData.availableQuantity; if (newItemId === originalItemId) { currentAvailable += originalQuantity; } if (currentAvailable < newQuantity) { showError(`Quantità non disponibile per "${newItemData.name}". Disponibili: ${newItemData.availableQuantity}` + (newItemId === originalItemId ? ` (+${originalQuantity} originali)`: '') + ` Richiesti: ${newQuantity}.`); return; } const updatedInventory = inventory.map(item => { if (item.id === originalItemId) { return { ...item, availableQuantity: item.availableQuantity + originalQuantity }; } return item; }).map(item => { if (item.id === newItemId) { return { ...item, availableQuantity: item.availableQuantity - newQuantity }; } return item; }); const targetRentalNumber = originalRentalRow.rentalNumber; const updatedRentals = activeRentals.map(rental => { if (rental.id === rentalId) { return { ...rental, itemId: newItemId, itemName: `${newItemData.brand} ${newItemData.name}`, quantity: newQuantity, dailyRate: newItemData.dailyRate, client: newClientName, operator: newOperator, notes: newNotes }; } else if (rental.rentalNumber === targetRentalNumber) { return { ...rental, client: newClientName, operator: newOperator }; } return rental; }); saveInventory(updatedInventory); saveActiveRentals(updatedRentals); loadInventoryData(); loadRentalData(); closeModal(editRentalModal); alert("Modifiche noleggio salvate."); } catch(err) { console.error("Error saving rental edits:", err); showError("Errore salvataggio modifiche noleggio."); }
            }); }

            // --- Print/History Actions ---
            if (printRentalsBtn) { printRentalsBtn.addEventListener('click', function() {
                 try { const selectedMonth = printMonthSelect ? parseInt(printMonthSelect.value) : 0; const selectedYear = printYearInput ? parseInt(printYearInput.value) : 0; if (isNaN(selectedYear) || selectedYear < 1900 || selectedYear > 2100) { showError("Anno non valido."); printYearInput?.focus(); return; } if (isNaN(selectedMonth) || selectedMonth < 1 || selectedMonth > 12) { showError("Mese non valido."); printMonthSelect?.focus(); return; } const allCompletedRentals = getCompletedRentals(); const filteredRentals = allCompletedRentals.filter(rental => { if (!rental.endDate) return false; try { const parts = rental.endDate.split('-'); if(parts.length !== 3) return false; const year = parseInt(parts[0]); const month = parseInt(parts[1]); return month === selectedMonth && year === selectedYear; } catch (e) { console.error("Error parsing rental endDate:", rental.endDate, e); return false; } }); if (filteredRentals.length === 0) { showError(`Nessun noleggio completato per ${printMonthSelect?.options[printMonthSelect.selectedIndex]?.text || 'mese'} ${selectedYear}.`); return; } const clientRentals = filteredRentals.reduce((acc, rental) => { const clientKey = rental.client || "Cliente Sconosciuto"; if (!acc[clientKey]) acc[clientKey] = []; rental.dailyRate = rental.dailyRate ?? 0; rental.warehouse = rental.warehouse || 'N/D'; rental.operator = rental.operator || 'N/D'; acc[clientKey].push(rental); return acc; }, {}); const sortedClients = Object.keys(clientRentals).sort((a, b) => a.localeCompare(b)); const monthName = printMonthSelect?.options[printMonthSelect.selectedIndex]?.text || `Mese ${selectedMonth}`; let printHtml = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Stampa Noleggi - ${monthName} ${selectedYear}</title><style>body{font-family:Arial,sans-serif;font-size:9pt;margin:15mm} .print-page-header{display:flex;align-items:center;gap:15px;margin-bottom:15px;border-bottom:2px solid #000;padding-bottom:10px;} .print-page-header img{max-height:60px;width:auto;flex-shrink:0;} .print-page-header h1{margin:0;font-size:14pt;text-align:left;flex-grow:1;} h2{font-size:12pt;margin-top:15px;margin-bottom:8px;border-bottom:1px solid #000;padding-bottom:4px;page-break-before:avoid;page-break-after:avoid;} table{width:100%;border-collapse:collapse;margin-top:5px;margin-bottom:12px;font-size:8pt;page-break-inside:auto;} th,td{border:1px solid #ccc;padding:3px 5px;text-align:left;vertical-align:top;word-wrap:break-word;} th{background-color:#eee;font-weight:bold;white-space:nowrap;} .text-right{text-align:right} .text-center{text-align:center} .total-row td{font-weight:bold;border-top:1px solid #000;background-color:#f8f8f8;} .print-info{text-align:center;font-size:8pt;color:#666;margin-bottom:15px} tr{page-break-inside:avoid;page-break-after:auto;} thead{display:table-header-group;} @page{size:A4;margin:15mm;} @media print{body{margin:15mm;font-size:9pt} h2{page-break-before:auto;} button{display:none;}}</style></head><body><div class="print-page-header"><img src="${LOGO_URL}" alt="Logo CAI Idraulica"><h1>Riepilogo Noleggi Completati - ${monthName} ${selectedYear}</h1></div><div class="print-info">Generato il: ${new Date().toLocaleString('it-IT')}</div>`; sortedClients.forEach(client => { printHtml += `<h2>Cliente: ${escapeHtml(client)}</h2><table><thead><tr><th># Noleggio</th><th>Articolo Noleggiato</th><th>Mag. Orig.</th><th>Operatore</th> <th class="text-center">Q.tà</th><th class="text-right">Prezzo Giorn.</th><th>Data Inizio</th><th>Data Fine</th><th class="text-center">Giorni Tot.</th><th class="text-right">Costo Tot.</th><th>Note</th></tr></thead><tbody>`; let clientTotal = 0; const rentalsForClient = clientRentals[client].sort((a, b) => (a.rentalNumber || 0) - (b.rentalNumber || 0)); rentalsForClient.forEach(rental => { const days = getDaysDifference(rental.startDate, rental.endDate); const totalCost = (rental.dailyRate || 0) * rental.quantity * days; clientTotal += totalCost; printHtml += `<tr><td>${escapeHtml(rental.rentalNumber || 'N/A')}</td><td>${escapeHtml(rental.itemName)}</td><td>${escapeHtml(rental.warehouse)}</td><td>${escapeHtml(rental.operator)}</td> <td class="text-center">${rental.quantity}</td><td class="text-right">${formatPrice(rental.dailyRate)}</td><td>${formatDate(rental.startDate)}</td><td>${formatDate(rental.endDate)}</td><td class="text-center">${days}</td><td class="text-right">${formatPrice(totalCost)}</td><td>${escapeHtml(rental.notes || '')}</td></tr>`; }); printHtml += `<tr class="total-row"><td colspan="9" class="text-right">Totale Cliente (${escapeHtml(client)}):</td><td class="text-right">${formatPrice(clientTotal)}</td><td></td></tr></tbody></table>`; }); printHtml += `<script>window.onload=function(){ try { window.print(); window.close(); } catch(e) { console.error('Print failed:', e); } };<\/script></body></html>`; const printWindow = window.open('', '_blank'); if (printWindow) { printWindow.document.open(); printWindow.document.write(printHtml); printWindow.document.close(); } else { showError("Impossibile aprire finestra stampa."); } } catch (err) { console.error("Error printing history:", err); showError("Errore preparazione stampa storico."); }
            }); }
            if (resetCompletedBtn) { resetCompletedBtn.addEventListener('click', function() {
                 if (confirm("Eliminare TUTTO lo storico noleggi completati? Azione irreversibile.")) { saveCompletedRentals([]); updateBillingStats(); alert("Storico resettato."); }
            }); }

        } catch (err) { // <--- CHIUSURA TRY per event listener
            console.error("Error setting up initial event listeners:", err);
            showError("Errore critico inizializzazione eventi: " + err.message + (err.stack ? "\n" + err.stack : ""));
        } // <--- CHIUSURA CATCH per event listener


        // --- Initial Load ---
        try {
            populateOperatorDropdown(rentalOperatorSelect); // Popola dropdown operatore nuovo noleggio
            populateOperatorDropdown(editRentalOperatorSelect); // Popola dropdown operatore modifica noleggio
            loadInventoryData();
            loadRentalData();
            setDefaultPrintDate();
            console.log("Application initialized successfully.");
        } catch (err) {
             console.error("Error during application initialization:", err);
             showError("Errore critico avvio applicazione: " + err.message);
        }

    }; // End of initializeApp


    // Run Initialization when DOM is ready
    document.addEventListener("DOMContentLoaded", initializeApp);

})(); // End IIFE