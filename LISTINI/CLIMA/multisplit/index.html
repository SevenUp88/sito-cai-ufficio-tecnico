<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Multisplit - CAI</title>
    
    <!-- CSS Principale (risale di 2 livelli) -->
    <link rel="stylesheet" href="../../style.css">
    
    <!-- Font e Icone -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- CLASSI DI UTILITÀ --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        /* --- STILI SPECIFICI CONFIGURATORE --- */
        .config-card {
            background-color: #fff; padding: 30px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 600px;
        }

        /* Indicatori Step */
        .step-indicator {
            display: flex; justify-content: space-between; margin-bottom: 40px; 
            position: relative; padding: 0 10px;
        }
        .step-item {
            text-align: center; flex: 1; position: relative; z-index: 2; 
            opacity: 0.5; transition: opacity 0.3s;
        }
        .step-item.active, .step-item.completed { opacity: 1; }
        
        .step-dot {
            width: 35px; height: 35px; background-color: #f8f9fa; color: #6c757d;
            border: 2px solid #dee2e6; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin: 0 auto 8px auto; transition: all 0.3s;
        }
        .step-item.active .step-dot { 
            background-color: #0056a8; color: white; border-color: #0056a8; 
            transform: scale(1.1); box-shadow: 0 0 10px rgba(0,86,168,0.3);
        }
        .step-item.completed .step-dot { 
            background-color: #28a745; color: white; border-color: #28a745; 
        }
        
        .step-label { font-size: 0.8rem; font-weight: 600; color: #333; display: block; }
        .step-sub { font-size: 0.75rem; color: #0056a8; font-weight: 500; height: 1.2em; display: block; margin-top: 2px;}

        .step-line-bg {
            position: absolute; top: 19px; left: 5%; width: 90%; height: 2px;
            background-color: #e9ecef; z-index: 1;
        }

        /* Contenuto Step */
        .step-content { display: none; animation: fadeIn 0.4s ease; }
        .step-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .step-title { 
            font-size: 1.4rem; color: #0056a8; margin-bottom: 25px; 
            border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; 
        }

        /* Griglie di Selezione */
        .selection-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; 
        }
        
        .select-card {
            border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 160px; background: white;
        }
        .select-card:hover { border-color: #0056a8; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,86,168,0.1); }
        .select-card.selected { border-color: #0056a8; background-color: #f0f7ff; font-weight: bold; }
        
        /* STEP 1: LOGO CENTRATO */
        #grid-brand .select-card { min-height: 120px; justify-content: center; }
        #grid-brand .card-img { max-height: 70px; margin-bottom: 0; width: auto; max-width: 90%; }

        .card-img { max-width: 100%; max-height: 100px; object-fit: contain; margin-bottom: 15px; }
        .card-text { font-size: 1rem; color: #333; font-weight: 500; text-transform: uppercase; }

        /* Card Unità Esterna (Step 4) */
        .ue-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .ue-card {
            border: 1px solid #ddd; border-radius: 8px; padding: 20px;
            cursor: pointer; transition: all 0.2s; background: white;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative;
        }
        .ue-card:hover { border-color: #0056a8; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .ue-card.selected { border-color: #0056a8; background-color: #f0f7ff; }
        
        .ue-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-start; }
        .ue-title { font-weight: bold; color: #0056a8; font-size: 1.1rem; }
        .ue-price { font-weight: bold; font-size: 1.2rem; color: #333; margin-top: 10px; text-align: right; }
        .ue-detail-text { font-size: 0.9rem; color: #666; margin-bottom: 4px; }
        
        .ue-img { width: 100%; height: 140px; object-fit: contain; margin: 10px 0; }

        /* Selezione Unità Interne (Step 5) */
        .ui-slot { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .ui-slot h4 { margin: 0 0 10px 0; color: #495057; font-size: 1rem; }
        
        .ui-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .ui-btn {
            padding: 10px; border: 1px solid #ced4da; background: white; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; flex: 1 1 auto;
            min-width: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .ui-btn:hover { border-color: #0056a8; color: #0056a8; }
        .ui-btn.selected { background: #0056a8; color: white; border-color: #0056a8; font-weight: bold; }
        
        .ui-preview { 
            margin-top: 15px; padding: 15px; background: white; 
            border: 1px dashed #ccc; border-radius: 4px; display: none; 
            flex-direction: row; align-items: center; gap: 15px;
        }
        .ui-preview.visible { display: flex; }
        .ui-preview-img { width: 100px; height: 70px; object-fit: contain; }
        .ui-preview-content { flex: 1; font-size: 0.9rem; color: #555; }
        .ui-preview strong { color: #0056a8; }

        /* Pulsante Scheda Tecnica */
        .btn-tech-sheet {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; margin-top: 5px; font-size: 0.8rem;
            color: #d32f2f; border: 1px solid #d32f2f; border-radius: 4px; 
            text-decoration: none; transition: all 0.2s; background: #fff; font-weight: 500;
        }
        .btn-tech-sheet:hover { background: #d32f2f; color: white; }
        
        /* Navigazione */
        .step-nav { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-nav { padding: 10px 25px; border-radius: 6px; border: none; font-weight: 500; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .btn-prev { background: #e9ecef; color: #495057; }
        .btn-prev:hover { background: #ced4da; }
        .btn-next { background: #0056a8; color: white; }
        .btn-next:hover { background: #004485; }
        .btn-next:disabled { background: #a0c4e8; cursor: not-allowed; }

        /* Riepilogo */
        .summary-box { background: #f8f9fa; padding: 25px; border-radius: 8px; border: 1px solid #e9ecef; }
        .summary-header { border-bottom: 2px solid #0056a8; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .summary-header h3 { margin: 0; color: #0056a8; }
        .summary-date { font-size: 0.9rem; color: #666; }
        
        .summary-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px dotted #ccc; font-size: 0.95rem; align-items: center; }
        .summary-row.total { border-top: 2px solid #ccc; border-bottom: none; margin-top: 15px; padding-top: 15px; font-size: 1.4rem; font-weight: bold; color: #0056a8; }
        
        .loader { text-align: center; padding: 40px; color: #6c757d; }
        
        @media print {
            .sidebar, .top-bar, .step-indicator, .step-nav, .config-title { display: none !important; }
            .config-card { box-shadow: none; border: none; padding: 0; min-height: auto; }
            .summary-box { border: 2px solid #000; background: white; padding: 0; }
            .summary-header { border-bottom: 2px solid #000; padding: 10px; margin: 0; }
            .summary-row { padding: 5px 10px; border-bottom: 1px solid #eee; }
            body { background: white; font-size: 12pt; color: black; }
            .step-content:not(#step-6) { display: none !important; }
            #step-6 { display: block !important; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="initial-loader" class="loader-container"><div class="loader-spinner"></div><p style="margin-top:10px;">Caricamento...</p></div>

    <!-- Login -->
    <section id="login-section" class="hidden login-centered">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo CAI" class="login-logo">
            <h2>Area Riservata</h2>
            <form id="login-form">
                <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
                <button type="submit" class="btn-login">Accedi</button>
            </form>
        </div>
    </section>

    <!-- APP CONTENT -->
    <div id="app-content" class="dashboard-wrapper hidden">
        
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-brand"><a href="/"><img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo CAI"></a></div>
            <ul class="sidebar-menu"></ul> <!-- Gestito da components.js -->
            <div class="sidebar-footer">&copy; 2025 CAI Solutions</div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- Header generato da components.js -->

            <div class="content-container">
                <div class="config-card">
                    
                    <!-- INDICATORI STEP -->
                    <div class="step-indicator">
                        <div class="step-line-bg"></div>
                        <div class="step-item active" id="ind-1"><div class="step-dot">1</div><span class="step-label">Marca</span><span class="step-sub" id="info-1"></span></div>
                        <div class="step-item" id="ind-2"><div class="step-dot">2</div><span class="step-label">Config.</span><span class="step-sub" id="info-2"></span></div>
                        <div class="step-item" id="ind-3"><div class="step-dot">3</div><span class="step-label">Serie</span><span class="step-sub" id="info-3"></span></div>
                        <div class="step-item" id="ind-4"><div class="step-dot">4</div><span class="step-label">Esterna</span><span class="step-sub" id="info-4"></span></div>
                        <div class="step-item" id="ind-5"><div class="step-dot">5</div><span class="step-label">Interne</span><span class="step-sub" id="info-5"></span></div>
                        <div class="step-item" id="ind-6"><div class="step-dot">6</div><span class="step-label">Fine</span></div>
                    </div>

                    <!-- STEP 1: MARCA -->
                    <div id="step-1" class="step-content active">
                        <h3 class="step-title">Seleziona Marca</h3>
                        <div id="grid-brand" class="selection-grid"><div class="loader">Caricamento Marche...</div></div>
                    </div>

                    <!-- STEP 2: CONFIGURAZIONE -->
                    <div id="step-2" class="step-content">
                        <h3 class="step-title">Seleziona Configurazione</h3>
                        <div id="grid-config" class="selection-grid"></div>
                        <div class="step-nav"><button class="btn-nav btn-prev" onclick="window.app.prev()">Indietro</button></div>
                    </div>

                    <!-- STEP 3: SERIE -->
                    <div id="step-3" class="step-content">
                        <h3 class="step-title">Seleziona Serie (Modello UI)</h3>
                        <div id="grid-series" class="selection-grid"></div>
                        <div class="step-nav"><button class="btn-nav btn-prev" onclick="window.app.prev()">Indietro</button></div>
                    </div>

                    <!-- STEP 4: UNITA ESTERNA -->
                    <div id="step-4" class="step-content">
                        <h3 class="step-title">Scegli Unità Esterna</h3>
                        <div id="list-ue" class="ue-list"></div>
                        <div class="step-nav"><button class="btn-nav btn-prev" onclick="window.app.prev()">Indietro</button></div>
                    </div>

                    <!-- STEP 5: UNITA INTERNE -->
                    <div id="step-5" class="step-content">
                        <h3 class="step-title">Configura Unità Interne</h3>
                        <div id="container-ui"></div>
                        <div class="step-nav">
                            <button class="btn-nav btn-prev" onclick="window.app.prev()">Indietro</button>
                            <button id="btn-finish" class="btn-nav btn-next" disabled onclick="window.app.finish()">Vai al Riepilogo</button>
                        </div>
                    </div>

                    <!-- STEP 6: RIEPILOGO -->
                    <div id="step-6" class="step-content">
                        <h3 class="step-title">Riepilogo Preventivo</h3>
                        <div id="summary-box" class="summary-box"></div>
                        <div class="step-nav">
                            <button class="btn-nav btn-prev" onclick="window.app.prev()">Modifica</button>
                            <div style="display:flex; gap:10px;">
                                <button class="btn-nav btn-prev" style="background:#dc3545; color:white;" onclick="location.reload()">Nuovo</button>
                                <button class="btn-nav btn-next" onclick="window.print()">Stampa</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- MENU LATERALE CENTRALIZZATO -->
    <script src="/components.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y", authDomain: "consorzio-artigiani-idraulici.firebaseapp.com", projectId: "consorzio-artigiani-idraulici", storageBucket: "consorzio-artigiani-idraulici.appspot.com", messagingSenderId: "136848104008", appId: "1:136848104008:web:71e2195f1712a832e01b3a" };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- LAYOUT ---
            initLayout("Configuratore Multisplit");

            const state = {
                step: 1,
                data: { brands:[], ue:[], ui:[] },
                sel: { brand:null, type:null, series:null, ue:null, ui:[] }
            };

            // PATH BASE GITHUB PER LE IMMAGINI (RAW)
            const GITHUB_IMG_PATH = 'https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LISTINI/CLIMA/multisplit/img/';

            // Mappa Immagini Unità Esterne (Fallback/Standard)
            const outdoorImages = {
                'HAIER': 'est_haier.png',
                'DAIKIN': 'est_daikin.jpg',
                'HITACHI': 'est_hitachi.jpg',
                'IMMERGAS': 'est_immergas.png',
                'LG': 'est_lg.png',
                'MITSUBISHI': 'est_mitsubishi.png',
                'MITSUBISHI ELECTRIC': 'est_mitsubishi.png',
                'SAMSUNG': 'est_samsung.png',
                'TOSHIBA': 'est_toshiba.jpg',
                'VIESSMANN': 'est_viessmann.avif'
            };

            const ui = {
                loader: document.getElementById('initial-loader'),
                login: document.getElementById('login-section'),
                app: document.getElementById('app-content'),
                loginForm: document.getElementById('login-form'),
                steps: [1,2,3,4,5,6].map(i => document.getElementById(`step-${i}`)),
                inds: [1,2,3,4,5,6].map(i => document.getElementById(`ind-${i}`)),
                infos: [1,2,3,4,5].map(i => document.getElementById(`info-${i}`)),
                grids: {
                    brand: document.getElementById('grid-brand'),
                    config: document.getElementById('grid-config'),
                    series: document.getElementById('grid-series'),
                    ue: document.getElementById('list-ue'),
                    ui: document.getElementById('container-ui')
                },
                summary: document.getElementById('summary-box'),
                btnFinish: document.getElementById('btn-finish')
            };

            // Auth
            auth.onAuthStateChanged(user => {
                ui.loader.style.display='none';
                if(user) {
                    ui.login.classList.add('hidden');
                    ui.app.classList.remove('hidden');
                    initApp();
                } else {
                    ui.login.classList.remove('hidden');
                    ui.app.classList.add('hidden');
                }
            });

            if(ui.loginForm) {
                ui.loginForm.addEventListener('submit', e => {
                    e.preventDefault();
                    auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value)
                        .catch(err => alert(err.message));
                });
            }

            // --- FUNZIONI DI UTILITA' ---
            
            // Genera bottone PDF se presente URL
            function getPdfButton(data) {
                const link = data.scheda_tecnica_url || data.scheda_tecnica || data.link_scheda;
                if (link && (link.startsWith('http') || link.startsWith('www'))) {
                    return `<a href="${link}" target="_blank" class="btn-tech-sheet" onclick="event.stopPropagation()">
                                <i class="fas fa-file-pdf"></i> Scheda Tecnica
                            </a>`;
                }
                return '';
            }

            // --- LOGICA APPLICAZIONE ---
            
            async function initApp() {
                try {
                    const [bSnap, ueSnap, uiSnap] = await Promise.all([
                        db.collection('brands').get(),
                        db.collection('outdoorUnits').get(),
                        db.collection('indoorUnits').get()
                    ]);

                    state.data.brands = bSnap.docs.map(d => ({id:d.id, ...d.data()}));
                    
                    state.data.ue = ueSnap.docs.map(d => {
                        const data = d.data();
                        return {
                            id: d.id, ...data,
                            brandId: (data.marca||'').toLowerCase().trim(),
                            con: Number(data.unita_collegabili || data.unit_collegabili || data.connections || 0),
                            price: Number(data.prezzo||0),
                            compat: Array.isArray(data.compatibleIndoorSeriesIds) ? data.compatibleIndoorSeriesIds : 
                                    (Array.isArray(data.compatible_indoor_series_ids) ? data.compatible_indoor_series_ids : [])
                        };
                    });
                    
                    state.data.ui = uiSnap.docs.map(d => {
                        const data = d.data();
                        const sId = (data.modello||'').toLowerCase().replace(/\s+/g,'_') + '_ui';
                        return {
                            id: d.id, ...data,
                            brandId: (data.marca||'').toLowerCase().trim(),
                            seriesId: sId,
                            price: Number(data.prezzo_ui||0)
                        };
                    });

                    renderBrands();
                } catch(e) { console.error(e); alert("Errore caricamento dati Firebase."); }
            }

            // Step 1: Marche (SOLO LOGO)
            function renderBrands() {
                const validBrands = [...new Set(state.data.ue.map(u => u.brandId))];
                const list = state.data.brands.filter(b => validBrands.includes(b.id));
                
                ui.grids.brand.innerHTML = list.map(b => `
                    <div class="select-card" onclick="window.app.selBrand('${b.id}','${b.name}')" title="${b.name}">
                        <img src="${b.logo}" class="card-img" onerror="this.style.display='none'">
                    </div>
                `).join('');
            }

            // Step 2: Configurazione
            function renderConfigs() {
                const opts = [{id:2,n:'Dual (2)'},{id:3,n:'Trial (3)'},{id:4,n:'Quadri (4)'},{id:5,n:'Penta (5)'}];
                const allowed = state.data.ue.filter(u => u.brandId === state.sel.brand.id).map(u => u.con);
                const list = opts.filter(o => allowed.includes(o.id));
                
                ui.grids.config.innerHTML = list.map(c => `
                    <div class="select-card" onclick="window.app.selConfig(${c.id},'${c.n}')">
                        <span class="card-text" style="font-size:2rem;color:#0056a8;">${c.id}</span>
                        <span>${c.n}</span>
                    </div>
                `).join('');
                if(!list.length) ui.grids.config.innerHTML = '<p>Nessuna configurazione disponibile per questa marca.</p>';
            }

            // Step 3: Serie (Immagini da GitHub basate sul nome con ECCEZIONI)
            function renderSeries() {
                const compatUE = state.data.ue.filter(u => u.brandId === state.sel.brand.id && u.con === state.sel.type.id);
                const compatSeriesIds = new Set();
                compatUE.forEach(u => {
                    if(u.compat) u.compat.forEach(id => compatSeriesIds.add(id));
                });

                const unique = [];
                const seen = new Set();
                state.data.ui.forEach(u => {
                    if(compatSeriesIds.has(u.seriesId) && !seen.has(u.seriesId)) {
                        unique.push({id: u.seriesId, name: u.modello});
                        seen.add(u.seriesId);
                    }
                });

                // Mappa delle eccezioni per i nomi dei file immagini
                const imageOverrides = {
                    'windfree_avant_s2': 'windfree_avant',
                    'windfree_elite_s2': 'windfree_elite', 
                    'cebu_wi-fi': 'cebu',
                };

                ui.grids.series.innerHTML = unique.map(s => {
                    let normalizedName = s.name.toLowerCase().trim().replace(/\s+/g, '_');
                    
                    if(imageOverrides[normalizedName]) {
                        normalizedName = imageOverrides[normalizedName];
                    }

                    const imgPath = `${GITHUB_IMG_PATH}${normalizedName}.png`;

                    return `
                    <div class="select-card" onclick="window.app.selSeries('${s.id}','${s.name}', '${imgPath}')">
                        <img src="${imgPath}" class="card-img" onerror="this.src='/placeholder.png'">
                        <span class="card-text">${s.name}</span>
                    </div>`;
                }).join('');
                if(!unique.length) ui.grids.series.innerHTML = '<p>Nessuna serie compatibile trovata.</p>';
            }

            // Step 4: UE (Con Scheda Tecnica URL)
            function renderUE() {
                const list = state.data.ue.filter(u => 
                    u.brandId === state.sel.brand.id && 
                    u.con === state.sel.type.id &&
                    u.compat?.includes(state.sel.series.id)
                );
                
                const unique = [];
                const seen = new Set();
                list.forEach(u => { if(!seen.has(u.codice_prodotto)) { unique.push(u); seen.add(u.codice_prodotto); } });

                ui.grids.ue.innerHTML = unique.map(u => {
                    const brandKey = u.brandId.toUpperCase();
                    const imgName = outdoorImages[brandKey] || 'placeholder.png';
                    const imgPath = `/LISTINI/CLIMA/images/${imgName}`;
                    const pdfBtn = getPdfButton(u);

                    return `
                    <div class="ue-card" onclick="window.app.selUE('${u.id}')">
                        <div class="ue-header">
                            <span class="ue-title">${u.modello || u.codice_prodotto}</span>
                        </div>
                        <img src="${imgPath}" class="ue-img" onerror="this.src='/placeholder.png'">
                        <div class="ue-detail-text">Codice: ${u.codice_prodotto}</div>
                        <div class="ue-detail-text">Potenza: ${u.potenza} kW</div>
                        <div class="ue-detail-text">Gas: ${u.tipo_refrigerante}</div>
                        ${pdfBtn}
                        <div class="ue-price">€ ${u.price.toFixed(2)}</div>
                    </div>`;
                }).join('');
                
                if(!unique.length) ui.grids.ue.innerHTML = '<p>Nessuna unità esterna compatibile.</p>';
            }

            // Step 5: UI (Con Anteprima e Scheda Tecnica)
            function renderUISelect() {
                const count = state.sel.type.id;
                state.sel.ui = new Array(count).fill(null);
                
                const opts = state.data.ui.filter(i => i.seriesId === state.sel.series.id);
                const unique = [];
                const seen = new Set();
                opts.forEach(i => {
                    if(!seen.has(i.potenza)) { unique.push(i); seen.add(i.potenza); }
                });
                unique.sort((a,b) => parseFloat(a.potenza) - parseFloat(b.potenza));

                ui.grids.ui.innerHTML = '';
                for(let i=0; i<count; i++) {
                    const html = `
                    <div class="ui-slot">
                        <h4>Unità Interna ${i+1}</h4>
                        <div class="ui-options" id="grp-ui-${i}">
                            ${unique.map(u => `
                                <div class="ui-btn" onclick="window.app.pickUI(${i}, '${u.id}', this)">
                                    <span style="font-weight:bold; font-size:1.1em;">${u.potenza}</span>
                                    <small>BTU/h</small>
                                    <small style="margin-top:5px;">€ ${u.price.toFixed(0)}</small>
                                </div>
                            `).join('')}
                        </div>
                        <div class="ui-preview" id="prev-ui-${i}">
                            <img src="" class="ui-preview-img" id="prev-img-${i}" onerror="this.style.display='none'">
                            <div class="ui-preview-content" id="prev-txt-${i}"></div>
                        </div>
                    </div>`;
                    ui.grids.ui.innerHTML += html;
                }
                ui.btnFinish.disabled = true;
            }

            // Step 6: Riepilogo (CON POTENZA UE)
            function renderSummary() {
                const s = state.sel;
                let tot = s.ue.price;
                s.ui.forEach(u => tot += u.price);
                
                const ueName = s.ue.modello || s.ue.codice_prodotto || "Unità Esterna";
                // Aggiunta la potenza accanto al nome se disponibile
                const uePower = s.ue.potenza ? ` (${s.ue.potenza} kW)` : '';
                
                const uePdf = getPdfButton(s.ue);

                let rows = s.ui.map((u,i) => {
                    const uiPdf = getPdfButton(u);
                    const uiName = u.modello || u.codice_prodotto || `Unità ${i+1}`;
                    return `
                    <div class="summary-row">
                        <div>
                            <span style="display:block; font-weight:500;">UI ${i+1}: ${uiName} (${u.potenza})</span>
                            ${uiPdf}
                        </div>
                        <strong>€ ${u.price.toFixed(2)}</strong>
                    </div>`;
                }).join('');

                ui.summary.innerHTML = `
                    <div class="summary-header">
                        <h3>Preventivo ${s.brand.name}</h3>
                        <span class="summary-date">${new Date().toLocaleDateString()}</span>
                    </div>
                    <div class="summary-row">
                        <div>
                            <span style="display:block; font-weight:500;">Unità Esterna: ${ueName}${uePower}</span>
                            ${uePdf}
                        </div>
                        <strong>€ ${s.ue.price.toFixed(2)}</strong>
                    </div>
                    ${rows}
                    <div class="summary-row total">
                        <span>TOTALE (IVA Escl.)</span>
                        <span>€ ${tot.toFixed(2)}</span>
                    </div>
                `;
            }

            // --- NAVIGATION ---
            window.app = {
                goTo: (step) => {
                    state.step = step;
                    ui.steps.forEach(s => s.classList.remove('active'));
                    document.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
                    
                    document.getElementById(`step-${step}`).classList.add('active');
                    
                    ui.inds.forEach((el, idx) => {
                        const s = idx + 1;
                        if(s === step) { el.classList.add('active'); el.classList.remove('completed'); }
                        else if(s < step) { el.classList.add('completed'); el.classList.remove('active'); }
                        else { el.classList.remove('active', 'completed'); }
                    });
                    
                    if(step === 6) renderSummary();
                    window.scrollTo(0,0);
                },
                prev: () => window.app.goTo(state.step - 1),
                finish: () => window.app.goTo(6),
                
                selBrand: (id, name) => {
                    state.sel.brand = {id, name};
                    ui.infos[0].textContent = name;
                    renderConfigs();
                    window.app.goTo(2);
                },
                selConfig: (id, name) => {
                    state.sel.type = {id, name};
                    ui.infos[1].textContent = name;
                    renderSeries();
                    window.app.goTo(3);
                },
                selSeries: (id, name, imgPath) => {
                    state.sel.series = {id, name, imgPath}; 
                    ui.infos[2].textContent = name;
                    renderUE();
                    window.app.goTo(4);
                },
                selUE: (id) => {
                    state.sel.ue = state.data.ue.find(u => u.id === id);
                    ui.infos[3].textContent = state.sel.ue.modello || state.sel.ue.codice_prodotto;
                    renderUISelect();
                    window.app.goTo(5);
                },
                pickUI: (idx, uid, btn) => {
                    document.querySelector(`#grp-ui-${idx} .selected`)?.classList.remove('selected');
                    btn.classList.add('selected');
                    
                    const unit = state.data.ui.find(u => u.id === uid);
                    state.sel.ui[idx] = unit;
                    
                    // Update Preview
                    const wrapper = document.getElementById(`prev-ui-${idx}`);
                    const txt = document.getElementById(`prev-txt-${idx}`);
                    const img = document.getElementById(`prev-img-${idx}`);
                    
                    // Usa l'immagine salvata nello step serie
                    const seriesImg = state.sel.series.imgPath || '/placeholder.png';
                    
                    img.src = seriesImg;
                    img.style.display = 'block';
                    
                    const pdfBtn = getPdfButton(unit);
                    
                    txt.innerHTML = `
                        <div><strong>${unit.codice_prodotto || unit.modello}</strong></div>
                        <div>Dimensioni: ${unit.dimensioni_ui || 'N/D'}</div>
                        ${pdfBtn}
                    `;
                    wrapper.classList.add('visible');
                    
                    const count = state.sel.ui.filter(Boolean).length;
                    ui.infos[4].textContent = `${count}/${state.sel.type.id}`;
                    ui.btnFinish.disabled = count !== state.sel.type.id;
                }
            };

        });
    </script>
</body>
</html>
