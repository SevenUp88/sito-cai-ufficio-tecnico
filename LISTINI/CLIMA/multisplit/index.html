<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Multisplit - CAI</title>
    
    <!-- CSS Principale -->
    <link rel="stylesheet" href="/style.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* --- STILI DI SICUREZZA --- */
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; z-index: 100; }
        .sidebar-brand { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .sidebar-brand img { max-width: 180px; }
        .sidebar-menu { list-style: none; padding: 10px 0; margin: 0; }
        .nav-link { display: flex; align-items: center; padding: 12px 20px; color: #333; text-decoration: none; font-weight: 500; justify-content: space-between; cursor: pointer; border-left: 4px solid transparent; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: #f0f7ff; color: #0056a8; border-left-color: #0056a8; }
        .nav-link i:first-child { width: 25px; text-align: center; margin-right: 10px; font-size: 1.1rem; }
        .submenu-list { list-style: none; padding: 0; background-color: #fafafa; overflow: hidden; max-height: 0; transition: max-height 0.3s ease; }
        .submenu-list.open { max-height: 1000px; }
        .submenu-list li a { padding: 10px 20px 10px 55px; display: block; color: #666; text-decoration: none; font-size: 0.9rem; }
        .submenu-list li a:hover { color: #0056a8; background-color: #eee; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .top-bar { height: 70px; background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; flex-shrink: 0; }
        .page-title h2 { margin: 0; color: #0056a8; font-size: 1.4rem; }
        .user-profile-info { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; }
        .content-container { padding: 30px; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* --- STILI ORIGINALI CONFIGURATORE (Mantenuti dal tuo style.css) --- */
        .configurator-container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 600px; }
        
        .config-step { display: none; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; margin-bottom: 25px; }
        .config-step.active-step { display: block; }
        .config-step h2 { color: #0056a8; margin-top: 0; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 2px solid #0056a8; font-size: 1.6em; }
        .step-number-title { color: #0056a8; margin-right: 8px; font-weight: bold; }

        /* Step Indicator */
        .step-indicator { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 35px; padding: 0 10px; }
        .step-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; flex: 1; position: relative; }
        .step-item.disabled { cursor: not-allowed; opacity: 0.5; }
        .step-dot { width: 35px; height: 35px; border-radius: 50%; background-color: #eee; color: #666; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 5px; border: 2px solid #ddd; }
        .step-item.active .step-dot { background-color: #0056a8; color: white; border-color: #0056a8; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,86,168,0.3); }
        .step-item.completed .step-dot { background-color: #28a745; color: white; border-color: #28a745; }
        .step-name { font-size: 0.8em; font-weight: 600; color: #333; }
        .step-selection-info { font-size: 0.7em; color: #0056a8; margin-top: 3px; min-height: 1.2em; font-weight: 500; }
        .step-line { flex-grow: 1; height: 2px; background-color: #ccc; margin: 18px 5px 0 5px; }

        /* Griglie */
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .selection-item { padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; background-color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; transition: all 0.2s; }
        .selection-item:hover { border-color: #0056a8; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .selection-item.selected { border-color: #0056a8; background-color: #f0f7ff; font-weight: bold; }
        .selection-item img { max-height: 70px; margin-bottom: 10px; object-fit: contain; }

        /* Liste UE */
        .selection-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .unit-selection-card { padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; cursor: pointer; transition: all 0.2s; position: relative; }
        .unit-selection-card:hover { border-color: #0056a8; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .unit-selection-card.selected { border-color: #0056a8; background-color: #f0f7ff; }
        .unit-info h4 { margin: 0 0 5px 0; color: #0056a8; font-size: 1.1em; }
        .unit-price { font-weight: bold; color: #0056a8; font-size: 1.2em; margin-top: 10px; text-align: right; }
        
        /* Tasto PDF */
        .technical-sheet-button { display: inline-block; padding: 6px 12px; font-size: 0.85em; border-radius: 4px; background-color: #dc3545; color: white !important; text-decoration: none; margin-top: 10px; cursor: pointer; float: right; }
        .technical-sheet-button:hover { background-color: #c82333; }

        /* UI Selection */
        .indoor-unit-slot { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .indoor-unit-choices-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .indoor-unit-choice-card { background-color: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 10px 15px; cursor: pointer; text-align: center; min-width: 90px; flex: 1; }
        .indoor-unit-choice-card:hover { border-color: #0056a8; color: #0056a8; }
        .indoor-unit-choice-card.selected { background-color: #0056a8; color: white; border-color: #0056a8; }
        .unit-details { font-size: 0.9em; color: #555; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }

        /* Navigazione */
        .step-navigation { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .step-navigation button { padding: 10px 25px; font-size: 1em; border-radius: 4px; cursor: pointer; border: none; }
        .prev-btn { background-color: #6c757d; color: white; }
        .next-btn { background-color: #0056a8; color: white; }
        .next-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Riepilogo */
        .summary-section { background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .summary-detail-block { background: white; padding: 15px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #ddd; }
        .total-price-iva { font-size: 1.4em; font-weight: bold; color: #0056a8; margin-top: 20px; text-align: right; }

        /* Stampa */
        @media print {
            .sidebar, .top-bar, .step-indicator, .step-navigation { display: none !important; }
            .configurator-container { box-shadow: none; padding: 0; }
            #step-6 { display: block !important; }
            .config-step:not(#step-6) { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="initial-loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;">
        <i class="fas fa-spinner fa-spin" style="font-size:3rem;color:#0056a8;margin-bottom:20px;"></i>
        <p>Caricamento Configuratore...</p>
    </div>

    <!-- Login -->
    <section id="login-section" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f4f6f9;z-index:2000;display:flex;justify-content:center;align-items:center;">
        <div style="background:#fff;padding:40px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center;width:350px;">
            <img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo" style="max-width:180px;margin-bottom:20px;">
            <form id="login-form">
                <input type="email" id="email" required placeholder="Email" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;">
                <input type="password" id="password" required placeholder="Password" style="width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;">
                <button type="submit" style="width:100%;padding:10px;background:#0056a8;color:white;border:none;border-radius:4px;cursor:pointer;">Accedi</button>
            </form>
        </div>
    </section>

    <div id="app-content" class="hidden" style="display:flex; width:100%;">
        
        <nav class="sidebar">
            <div class="sidebar-brand"><a href="/"><img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecnico/main/LOGO%20CAI_.png" alt="Logo"></a></div>
            <ul class="sidebar-menu">
                <li><a href="/" class="nav-link"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li class="has-submenu"><a href="#" class="nav-link"><i class="fas fa-handshake"></i> Noleggi</a><ul class="submenu-list"><li><a href="/NOLEGGI/code.html">Attrezzature</a></li><li><a href="/NOLEGGI/GAS/index.html">Gas</a></li></ul></li>
                <li><a href="/PREVENTIVI/index.html" class="nav-link"><i class="fas fa-calculator"></i> Preventivazione</a></li>
                <li class="has-submenu"><a href="#" class="nav-link active"><i class="fas fa-list"></i> Listini</a>
                    <ul class="submenu-list open">
                        <li><a href="/LISTINI/CLIMA/monosplit/index.html">Clima Monosplit</a></li>
                        <li><a href="#" style="color:#0056a8;font-weight:bold;">Clima Multisplit</a></li>
                        <li><a href="/LISTINI/CALDAIE/index.html">Caldaie</a></li>
                        <li><a href="/LISTINI/SCALDABAGNI/index.html">Scaldabagno</a></li>
                        <li><a href="/LISTINI/SANITARI/index.html">Sanitari</a></li>
                    </ul>
                </li>
                <li><a href="/SCHEDE%20TECNICHE/index.html" class="nav-link"><i class="fas fa-clipboard-list"></i> Schede Tecniche</a></li>
                <li class="has-submenu"><a href="#" class="nav-link"><i class="fas fa-cogs"></i> Configuratori</a><ul class="submenu-list"><li><a href="/CONFIGURATORI/IMPIANTO RADIANTE/index.html">Radiante</a></li><li><a href="/CONFIGURATORI/RADIATORI/index.html">Radiatori</a></li></ul></li>
                <li><a href="/SCONTISTICHE/index.html" class="nav-link"><i class="fas fa-tags"></i> Scontistiche</a></li>
                <li><a href="/AGENDA%20CONSEGNE/index.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="top-bar">
                <div class="page-title"><h2>Configuratore Multisplit</h2></div>
                <div class="user-profile-info"><span id="user-email-display">...</span><button id="logout-button" style="border:none;background:none;"><i class="fas fa-sign-out-alt"></i></button></div>
            </header>

            <div class="content-container">
                <div class="configurator-container">
                    
                    <div class="step-indicator">
                        <div class="step-item active" data-step="1"><div class="step-dot">1</div><span class="step-name">Marca</span><div class="step-selection-info" id="step-info-1"></div></div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="2"><div class="step-dot">2</div><span class="step-name">Config.</span><div class="step-selection-info" id="step-info-2"></div></div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="3"><div class="step-dot">3</div><span class="step-name">Modello</span><div class="step-selection-info" id="step-info-3"></div></div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="4"><div class="step-dot">4</div><span class="step-name">Unità Est.</span><div class="step-selection-info" id="step-info-4"></div></div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="5"><div class="step-dot">5</div><span class="step-name">Unità Int.</span><div class="step-selection-info" id="step-info-5"></div></div>
                        <div class="step-line"></div>
                        <div class="step-item" data-step="6"><div class="step-dot">6</div><span class="step-name">Riepilogo</span></div>
                    </div>

                    <div id="step-1" class="config-step active-step">
                        <h2><span class="step-number-title">1.</span> Seleziona Marca</h2>
                        <div id="brand-selection" class="selection-grid"></div>
                        <div class="step-navigation"></div>
                    </div>

                    <div id="step-2" class="config-step">
                        <h2><span class="step-number-title">2.</span> Scegli Configurazione</h2>
                        <div id="config-type-selection" class="selection-grid"></div>
                        <div class="step-navigation"><button class="btn-nav prev-btn" onclick="showStep(1)">Indietro</button></div>
                    </div>
                    
                    <div id="step-3" class="config-step">
                        <h2><span class="step-number-title">3.</span> Seleziona Modello</h2>
                        <div id="model-selection" class="selection-grid"></div>
                        <div class="step-navigation"><button class="btn-nav prev-btn" onclick="showStep(2)">Indietro</button></div>
                    </div>

                    <div id="step-4" class="config-step">
                        <h2><span class="step-number-title">4.</span> Seleziona Unità Esterna</h2>
                        <div id="outdoor-unit-selection" class="selection-list"></div>
                        <div class="step-navigation"><button class="btn-nav prev-btn" onclick="showStep(3)">Indietro</button></div>
                    </div>

                    <div id="step-5" class="config-step">
                        <h2><span class="step-number-title">5.</span> Seleziona Unità Interne</h2>
                        <div id="indoor-units-selection-area"></div>
                        <div class="step-navigation">
                            <button class="btn-nav prev-btn" onclick="showStep(4)">Indietro</button>
                            <button class="btn-nav next-btn" id="finalize-btn" disabled onclick="showStep(6)">Vai al Riepilogo</button>
                        </div>
                    </div>

                    <div id="step-6" class="config-step">
                        <h2 id="summary-main-title">Riepilogo Configurazione</h2>
                        <div id="config-summary" class="summary-section"></div>
                        <div class="step-navigation summary-actions">
                            <button class="btn-nav prev-btn" onclick="showStep(5)">Modifica</button>
                            <button class="btn-nav next-btn" onclick="window.print()">Stampa</button>
                            <button class="btn-nav prev-btn" style="background:#dc3545;" onclick="location.reload()">Nuova</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y", authDomain: "consorzio-artigiani-idraulici.firebaseapp.com", projectId: "consorzio-artigiani-idraulici", storageBucket: "consorzio-artigiani-idraulici.appspot.com", messagingSenderId: "136848104008", appId: "1:136848104008:web:71e2195f1712a832e01b3a" };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // QUESTO È L'OGGETTO APP_DATA ORIGINALE CHE CONOSCEVI
            const APP_DATA = { brands: [], configTypes: {}, outdoorUnits: [], indoorUnits: [], uiSeriesImageMapping: {} };
            const selections = { brand: null, configType: null, indoorSeries: null, outdoorUnit: null, indoorUnits: [] };
            
            // Immagini manuali per sicurezza
            const indoorImages = {
                'SENSIRA': 'sensira.png', 'PERFERA': 'perfera.png', 'EMURA': 'emura.png', 'PEARL': 'pearl.png', 'FLEXIS': 'flexis.png', 'REVIVE': 'revive.png', 'LIBERO SMART': 'libero_smart.png', 'KIRIGAMINE ZEN': 'kirigamine_zen.png', 'WIND FREE': 'windfree.png', 'SHORAI EDGE': 'shorai_edge.png', 'SEIYA':'seiya.png', 'VITOCLIMA':'vitoclima_300.png'
            };

            // Auth
            auth.onAuthStateChanged(user => {
                document.getElementById('initial-loader').style.display='none';
                if(user) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('user-email-display').textContent = user.email;
                    loadData();
                } else {
                    document.getElementById('login-section').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                }
            });

            document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(e.target[0].value, e.target[1].value); });
            document.getElementById('logout-button').addEventListener('click', () => auth.signOut());
            
            // Menu Toggle
            document.querySelectorAll('.has-submenu > .nav-link').forEach(l => l.addEventListener('click', e => { e.preventDefault(); l.nextElementSibling.style.maxHeight = l.nextElementSibling.style.maxHeight ? null : '500px'; }));

            // --- FUNZIONI ORIGINALI (Senza la parte Admin) ---

            async function loadData() {
                try {
                    const [b, c, o, i, m] = await Promise.all([
                        db.collection('brands').get(),
                        db.collection('configTypes').get(),
                        db.collection('outdoorUnits').get(),
                        db.collection('indoorUnits').get(),
                        db.collection('uiSeriesImageMapping').get()
                    ]);
                    
                    APP_DATA.brands = b.docs.map(d => ({id:d.id, ...d.data()}));
                    APP_DATA.configTypes = c.docs.reduce((a,d) => { a[d.id] = {id:d.id, ...d.data()}; return a; }, {});
                    
                    APP_DATA.outdoorUnits = o.docs.map(d => {
                        const dt = d.data();
                        return {
                            id: d.id, ...dt,
                            brandId: (dt.marca||'').toLowerCase().trim(),
                            connections: Number(dt.unita_collegabili || dt.unit_collegabili || dt.connections || 0),
                            price: Number(dt.prezzo||0),
                            compatibleIndoorSeriesIds: Array.isArray(dt.compatibleIndoorSeriesIds) ? dt.compatibleIndoorSeriesIds : (Array.isArray(dt.compatible_indoor_series_ids) ? dt.compatible_indoor_series_ids : []),
                            scheda_tecnica_url: dt.scheda_tecnica_url
                        };
                    });

                    APP_DATA.indoorUnits = i.docs.map(d => {
                        const dt = d.data();
                        const sId = (dt.modello||'').toLowerCase().replace(/\s+/g,'_') + '_ui';
                        return {
                            id: d.id, ...dt,
                            brandId: (dt.marca||'').toLowerCase().trim(),
                            seriesId: sId,
                            price: Number(dt.prezzo_ui||0),
                            capacityBTU: parseInt((dt.potenza||'').match(/\d+/)?.[0] || 0),
                            kw: (dt.potenza||'').match(/[\d.,]+kW/)?.[0] || 'N/D',
                            scheda_tecnica_url: dt.scheda_tecnica_url
                        };
                    });

                    m.docs.forEach(d => { const dt=d.data(); if(dt.seriesKey) APP_DATA.uiSeriesImageMapping[dt.seriesKey] = dt.imageName; });

                    populateBrands();
                } catch(e) { console.error(e); }
            }

            // *** GESTIONE STEP E NAVIGAZIONE (Logica ripristinata) ***
            let currentStep = 1;
            window.showStep = function(step) {
                // Controllo base: non saltare avanti se non hai finito
                if(step > currentStep + 1) return;

                document.querySelectorAll('.config-step').forEach(s => s.classList.remove('active-step'));
                document.getElementById(`step-${step}`).classList.add('active-step');
                
                document.querySelectorAll('.step-item').forEach((el, i) => {
                    const s = i + 1;
                    el.classList.remove('active', 'completed');
                    if(s === step) el.classList.add('active');
                    else if(s < step) el.classList.add('completed');
                    
                    // Abilita il click per tornare indietro
                    el.onclick = (s < currentStep) ? () => showStep(s) : null;
                });
                
                currentStep = step;
                if(step===6) renderSummary();
                window.scrollTo(0,0);
            };

            function populateBrands() {
                const div = document.getElementById('brand-selection');
                const validBrands = [...new Set(APP_DATA.outdoorUnits.map(u => u.brandId))];
                div.innerHTML = APP_DATA.brands.filter(b => validBrands.includes(b.id)).map(b => `
                    <div class="selection-item" onclick="selectBrand('${b.id}')">
                        <img src="${b.logo}" style="max-height:80px; margin-bottom:10px;">
                        <span>${b.name}</span>
                    </div>
                `).join('');
            }
            window.selectBrand = (id) => { selections.brand = APP_DATA.brands.find(b => b.id === id); populateConfigs(); showStep(2); updateInfo(1, selections.brand.name); };

            function populateConfigs() {
                const div = document.getElementById('config-type-selection');
                const allowed = APP_DATA.outdoorUnits.filter(u => u.brandId === selections.brand.id).map(u => u.connections);
                const configs = Object.values(APP_DATA.configTypes).filter(c => allowed.includes(c.numUnits)).sort((a,b)=>a.numUnits-b.numUnits);
                div.innerHTML = configs.map(c => `
                    <div class="selection-item" onclick="selectConfig('${c.id}')">
                        <span style="font-size:2em; color:#0056a8;">${c.numUnits}</span>
                        <span>${c.name}</span>
                    </div>
                `).join('');
            }
            window.selectConfig = (id) => { selections.configType = APP_DATA.configTypes[id]; populateSeries(); showStep(3); updateInfo(2, selections.configType.name); };

            function populateSeries() {
                const div = document.getElementById('model-selection');
                const compatUE = APP_DATA.outdoorUnits.filter(u => u.brandId === selections.brand.id && u.connections === selections.configType.numUnits);
                const seriesIds = new Set();
                compatUE.forEach(u => u.compatibleIndoorSeriesIds?.forEach(id => seriesIds.add(id)));
                
                const unique = []; const seen = new Set();
                APP_DATA.indoorUnits.forEach(u => {
                    if(seriesIds.has(u.seriesId) && !seen.has(u.seriesId)) {
                        let img = APP_DATA.uiSeriesImageMapping[u.seriesId];
                        // Fallback su mappa manuale se manca
                        if(!img) { for(let k in indoorImages) if(u.modello.toUpperCase().includes(k)) img = indoorImages[k]; }
                        
                        unique.push({id: u.seriesId, name: u.modello, img: img});
                        seen.add(u.seriesId);
                    }
                });
                
                div.innerHTML = unique.map(s => {
                    const img = s.img ? `/LISTINI/CLIMA/images/${s.img}` : '/placeholder.png';
                    return `<div class="selection-item" onclick="selectSeries('${s.id}', '${s.name}')">
                        <img src="${img}" style="max-height:100px;">
                        <span>${s.name}</span>
                    </div>`;
                }).join('');
            }
            window.selectSeries = (id, name) => { selections.indoorSeries = {id, name}; populateUE(); showStep(4); updateInfo(3, name); };

            function populateUE() {
                const div = document.getElementById('outdoor-unit-selection');
                const list = APP_DATA.outdoorUnits.filter(u => 
                    u.brandId === selections.brand.id && 
                    u.connections === selections.configType.numUnits &&
                    u.compatibleIndoorSeriesIds?.includes(selections.indoorSeries.id)
                );
                
                div.innerHTML = list.map(u => {
                    const pdfBtn = u.scheda_tecnica_url ? `<a href="${u.scheda_tecnica_url}" target="_blank" class="technical-sheet-button" onclick="event.stopPropagation()">Scheda Tecnica</a>` : '';
                    return `<div class="unit-selection-card" onclick="selectUE('${u.id}')">
                        <div style="flex:1">
                            <h4>${u.modello || u.codice_prodotto}</h4>
                            <p>Codice: ${u.codice_prodotto}</p>
                            <p>Potenza: ${u.potenza} kW</p>
                            <div class="unit-price">€ ${u.price.toFixed(2)}</div>
                        </div>
                        ${pdfBtn}
                    </div>`;
                }).join('');
            }
            window.selectUE = (id) => { selections.outdoorUnit = APP_DATA.outdoorUnits.find(u => u.id === id); populateUI(); showStep(5); updateInfo(4, selections.outdoorUnit.modello); };

            function populateUI() {
                const div = document.getElementById('indoor-units-selection-area');
                const count = selections.configType.numUnits;
                selections.indoorUnits = new Array(count).fill(null);
                
                const opts = APP_DATA.indoorUnits.filter(i => i.seriesId === selections.indoorSeries.id);
                const unique = []; const seen = new Set();
                opts.forEach(i => { if(!seen.has(i.capacityBTU)) { unique.push(i); seen.add(i.capacityBTU); } });
                unique.sort((a,b) => a.capacityBTU - b.capacityBTU);

                div.innerHTML = '';
                for(let i=0; i<count; i++) {
                    div.innerHTML += `
                    <div style="background:#f9f9f9; padding:15px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
                        <h4>Unità Interna ${i+1}</h4>
                        <div class="indoor-unit-choices-container" id="grp-ui-${i}">
                            ${unique.map(u => `
                                <div class="indoor-unit-choice-card" onclick="pickUI(${i}, '${u.id}', this)">
                                    <span style="font-weight:bold; display:block;">${u.capacityBTU} BTU</span>
                                    <span style="font-size:0.8em;">€ ${u.price.toFixed(0)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div id="preview-ui-${i}" class="unit-details" style="display:none;"></div>
                    </div>`;
                }
                document.getElementById('finalize-btn').disabled = true;
            }

            window.pickUI = (idx, id, btn) => {
                btn.parentElement.querySelectorAll('.indoor-unit-choice-card').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                const unit = APP_DATA.indoorUnits.find(u => u.id === id);
                selections.indoorUnits[idx] = unit;
                
                const pdf = unit.scheda_tecnica_url ? `<a href="${unit.scheda_tecnica_url}" target="_blank" class="technical-sheet-button">Scheda Tecnica</a>` : '';
                const p = document.getElementById(`preview-ui-${idx}`);
                p.innerHTML = `<p><strong>${unit.codice_prodotto}</strong> - ${unit.kw} (${unit.capacityBTU} BTU)</p> <p class="unit-price">€ ${unit.price.toFixed(2)}</p> ${pdf}`;
                p.style.display = 'block';
                
                const c = selections.indoorUnits.filter(Boolean).length;
                updateInfo(5, `${c}/${selections.configType.numUnits} Selezionate`);
                document.getElementById('finalize-btn').disabled = !selections.indoorUnits.every(u => u);
            };

            function renderSummary() {
                const div = document.getElementById('config-summary');
                const s = selections;
                let tot = s.outdoorUnit.price; s.indoorUnits.forEach(u => tot += u.price);
                
                div.innerHTML = `
                    <div class="summary-detail-block">
                        <h3>Preventivo ${s.brand.name}</h3>
                        <p><strong>Unità Esterna:</strong> ${s.outdoorUnit.modello} (${s.outdoorUnit.codice_prodotto}) - € ${s.outdoorUnit.price.toFixed(2)}
                           ${s.outdoorUnit.scheda_tecnica_url ? `<a href="${s.outdoorUnit.scheda_tecnica_url}" target="_blank" style="color:#dc3545; margin-left:10px;"><i class="fas fa-file-pdf"></i></a>` : ''}
                        </p>
                        ${s.indoorUnits.map((u,i) => `
                            <p><strong>UI ${i+1}:</strong> ${u.modello} (${u.capacityBTU} BTU) - € ${u.price.toFixed(2)}
                            ${u.scheda_tecnica_url ? `<a href="${u.scheda_tecnica_url}" target="_blank" style="color:#dc3545; margin-left:10px;"><i class="fas fa-file-pdf"></i></a>` : ''}
                            </p>
                        `).join('')}
                        <div class="total-price-iva">TOTALE: € ${tot.toFixed(2)}</div>
                    </div>
                `;
            }
            
            function updateInfo(step, text) {
                const el = document.getElementById(`step-info-${step}`);
                if(el) el.textContent = text;
            }
        });
    </script>
</body>
</html>
