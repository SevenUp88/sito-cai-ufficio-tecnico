<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAI - Configuratore Canne Fumarie</title>
    
    <!-- I percorsi ai CSS e a FontAwesome sono relativi alla posizione di questo file -->
    <link rel="stylesheet" href="../../style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Nascondiamo il body di default per evitare sfarfallii prima del controllo auth */
        body { visibility: hidden; }

        /* Stili specifici del configuratore */
        #content-area { padding: 15px; }
        .configuratore-container { width: 100%; max-width: 900px; margin: 20px auto; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .config-header { background-color: #0056a8; color: white; padding: 1.5rem 2rem; text-align: center; }
        .config-header h1 { margin: 0; font-size: 1.8rem; }
        #configForm { padding: 2rem; }
        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-step h2 { color: #0056a8; margin-top: 0; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        .visual-selector { text-align: center; margin-top: 2rem; }
        .selection-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; }
        .selection-card { border: 2px solid #dee2e6; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s ease-in-out; width: 220px; }
        .selection-card:hover { border-color: #0056a8; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .selection-card .image-wrapper { height: 120px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; }
        .selection-card .image-wrapper img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .selection-card span { font-weight: 600; font-size: 1.1em; color: #343a40; }
        input[type="radio"].hidden-radio { display: none; }
        input[type="radio"].hidden-radio:checked + .selection-card { border-color: #d71920; background-color: #fdf2f2; }
        .component-row { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid #e9ecef; }
        .component-row .image-wrapper { flex-shrink: 0; width: 60px; height: 60px; display:flex; align-items:center; justify-content:center; }
        .component-row .image-wrapper img { max-height: 100%; max-width: 100%; object-fit: contain; color: #495057; }
        .component-details { flex-grow: 1; }
        .component-details .code { font-size: 0.8em; color: #777; }
        .component-quantity input { width: 80px; text-align: center; }
        #riepilogo { background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #e9ecef; }
        #riepilogo h3 { color: #0056a8; }
        #lista-prodotti li { border-bottom: 1px dotted #ced4da; }
        .total-price span { color: #28a745; }
        .nav-button.btn-prev { background-color: #6c757d; }
        .nav-button.btn-prev:hover { background-color: #5a6268; }
        .nav-button.btn-calculate { background-color: #28a745; }
        .nav-button.btn-calculate:hover { background-color: #218838; }
        .nav-button.btn-send { background-color: #ff8c00; }
        .nav-button.btn-send:hover { background-color: #e67e00; }
        #loader { padding: 2rem; text-align: center; color: #6c757d; font-size: 1.2em; }
    </style>
</head>
<body class="hidden">

    <!-- Loader iniziale (identico alla home) -->
    <div id="initial-loader" class="loader-container">
        <div class="loader-spinner"></div>
        <p>Verifica in corso...</p>
    </div>

    <!-- HEADER IDENTICO ALLA HOME PAGE per coerenza e per far funzionare auth.js -->
    <header class="app-header">
        <a href="../../index.html">
            <img src="https://raw.githubusercontent.com/SevenUp88/sito-cai-ufficio-tecniCO/main/LOGO%20CAI_.png" alt="Logo Ufficio Tecnico CAI" class="logo">
        </a>
        <div class="header-controls">
            <!-- Questo blocco è necessario per auth.js -->
            <div id="user-dashboard" class="hidden">
                <p>Utente: <span id="user-email-display"></span></p>
                <button id="logout-button" class="btn-login">Logout</button>
            </div>
        </div>
    </header>

    <main id="content-area">
        <div class="configuratore-container">
            <div class="config-header"><h1>Configuratore Canne Fumarie</h1></div>
            <div id="loader">Caricamento dati prodotti...</div>
            <form id="configForm" class="hidden">
                <!-- Step 1: Installazione Visiva -->
                <div class="form-step active" data-step="1">
                    <h2>1. Scegli il tipo di scarico</h2>
                    <div class="visual-selector">
                        <div class="selection-container">
                            <input type="radio" id="install-verticale" name="installazione" value="verticale" class="hidden-radio" checked>
                            <label for="install-verticale" class="selection-card"><div class="image-wrapper"><img src="../immagini/scarico_verticale.png" alt="Scarico Verticale"></div><span>Verticale</span></label>
                            <input type="radio" id="install-orizzontale" name="installazione" value="orizzontale" class="hidden-radio">
                            <label for="install-orizzontale" class="selection-card"><div class="image-wrapper"><img src="../immagini/scarico_orizzontale.png" alt="Scarico Orizzontale"></div><span>Orizzontale</span></label>
                        </div>
                    </div>
                    <div class="btn-container" style="justify-content: flex-end;"><button type="button" class="nav-button btn-next">Avanti</button></div>
                </div>

                <!-- Step 2: Dimensioni e Materiali -->
                <div class="form-step" data-step="2">
                    <h2>2. Scegli materiali e diametri</h2>
                    <div class="form-group"><label for="tipologia">Tipo di Parete</label><select id="tipologia" name="tipologia"><option value="monoparete" selected>Monoparete</option><option value="doppiaparete">Doppiaparete</option></select></div>
                    <div class="form-group" id="materiale-monoparete-group"><label for="materiale-monoparete">Materiale Monoparete</label><select id="materiale-monoparete" name="materiale-monoparete"><option value="pps">PPS</option><option value="inox">INOX</option></select></div>
                    <div class="form-group" id="diametro-monoparete-group"><label for="diametro-mono">Diametro (mm)</label><select id="diametro-mono" name="diametro-mono"><option value="60">Ø 60 mm</option><option value="80" selected>Ø 80 mm</option></select></div>
                    <div id="doppiaparete-fields" class="hidden">
                        <div class="form-group"><label for="materiale-doppiaparete">Materiale Doppiaparete</label><select id="materiale-doppiaparete" name="materiale-doppiaparete"><option value="pps/pps">PPS/PPS</option><option value="pps/inox">PPS/INOX</option></select></div>
                        <div class="form-group"><label for="diametro-interno">Diametro Interno</label><select id="diametro-interno" name="diametro-interno"><option value="80" selected>Ø 80 mm</option></select></div>
                        <div class="form-group"><label for="diametro-esterno">Diametro Esterno</label><select id="diametro-esterno" name="diametro-esterno"><option value="130" selected>Ø 130 mm</option></select></div>
                    </div>
                    <div class="btn-container"><button type="button" class="nav-button btn-prev">Indietro</button><button type="button" class="nav-button btn-next">Avanti</button></div>
                </div>
                
                <!-- Step 3: Componenti -->
                <div class="form-step" data-step="3">
                    <h2>3. Aggiungi i componenti necessari</h2>
                    <div class="component-row" data-codice-prodotto="281069"><div class="image-wrapper"><img src=""></div><div class="component-details"><label>ELEM.RETTILINEO L. 200MM</label><span class="code">Cod. 281069</span></div><div class="component-quantity"><input type="number" value="0" min="0" data-prezzo="0.00" data-nome="ELEM.RETTILINEO L. 200MM"></div></div>
                    <div class="component-row" data-codice-prodotto="281074"><div class="image-wrapper"><img src=""></div><div class="component-details"><label>ELEM.RETTILINEO L. 950MM</label><span class="code">Cod. 281074</span></div><div class="component-quantity"><input type="number" value="3" min="0" data-prezzo="0.00" data-nome="ELEM.RETTILINEO L. 950MM"></div></div>
                    <div class="component-row" data-codice-prodotto="281080"><div class="image-wrapper"><img src=""></div><div class="component-details"><label>CURVA 90°</label><span class="code">Cod. 281080</span></div><div class="component-quantity"><input type="number" value="1" min="0" data-prezzo="0.00" data-nome="CURVA 90°"></div></div>
                    
                    <div id="vertical-components" class="hidden">
                        <!-- Componenti che appaiono solo in verticale -->
                    </div>
                    <div class="btn-container"><button type="button" class="nav-button btn-prev">Indietro</button><button type="button" class="nav-button btn-calculate">Calcola Preventivo</button></div>
                </div>
                
                <!-- Step 4: Riepilogo -->
                <div class="form-step" data-step="4">
                    <h2>4. Riepilogo e Preventivo</h2>
                    <div id="riepilogo">
                        <h3>Dettaglio Configurazione</h3>
                        <p><strong>Installazione:</strong> <span id="riepilogo-installazione"></span></p>
                        <p><strong>Tipologia:</strong> <span id="riepilogo-tipologia"></span></p>
                        <p><strong>Materiale:</strong> <span id="riepilogo-materiale"></span></p>
                        <p><strong>Diametri:</strong> <span id="riepilogo-diametro"></span></p>
                        <h3 style="margin-top: 2rem;">Lista Componenti</h3>
                        <ul id="lista-prodotti"></ul>
                        <div class="total-price">Totale Stimato: <span id="prezzo-totale">€ 0.00</span></div>
                    </div>
                    <div class="btn-container">
                        <button type="button" class="nav-button btn-prev">Modifica</button>
                        <button type="button" class="nav-button btn-send">Invia Richiesta</button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- ========================================================== -->
    <!-- === BLOCCO SCRIPT UNIFICATO E COMPLETO === -->
    <!-- ========================================================== -->

    <!-- 1. Librerie Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script> 
    
    <!-- 2. I tuoi script condivisi (con percorso relativo corretto) -->
    <script src="../../firebase-config.js"></script> 
    <script src="../../auth.js"></script> 

    <!-- 3. Lo script specifico per questo configuratore -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loader');
            const configForm = document.getElementById('configForm');
            const db = window.db;

            async function fetchProductData() {
                if (!db) {
                    console.error("Firestore (db) non è inizializzato.");
                    loader.textContent = "Errore di configurazione.";
                    return;
                }
                try {
                    const snapshot = await db.collection("prodottiCanneFumarie").get();
                    const products = snapshot.docs.map(doc => doc.data());
                    
                    products.forEach(product => {
                        const componentRow = document.querySelector(`.component-row[data-codice-prodotto="${product.codice_prodotto}"]`);
                        if (componentRow) {
                            const input = componentRow.querySelector('input[type="number"]');
                            const img = componentRow.querySelector('img');
                            if (product.prezzo !== undefined && product.prezzo !== null) {
                                input.dataset.prezzo = product.prezzo;
                            }
                            if (product.image_url) {
                                img.src = `../immagini/${product.image_url}`;
                                img.alt = product.descrizione;
                            }
                        }
                    });

                    loader.classList.add('hidden');
                    configForm.classList.remove('hidden');
                } catch (error) {
                    console.error("Errore nel caricamento dei dati da Firestore:", error);
                    loader.textContent = "Errore nel caricamento dei dati. Riprova più tardi.";
                }
            }
            
            // Attende un istante per assicurarsi che auth.js abbia fatto il suo controllo
            setTimeout(() => {
                if (firebase.auth().currentUser) {
                    fetchProductData();
                } else {
                    console.log("Nessun utente loggato, attendo il reindirizzamento da auth.js");
                }
            }, 100);

            // Logica del configuratore
            const nextButtons = document.querySelectorAll('.btn-next');
            const prevButtons = document.querySelectorAll('.btn-prev');
            const calculateButton = document.querySelector('.btn-calculate');
            const formSteps = document.querySelectorAll('.form-step');
            const tipologiaSelect = document.getElementById('tipologia');
            const doppiapareteFields = document.getElementById('doppiaparete-fields');
            const monoMaterialGroup = document.getElementById('materiale-monoparete-group');
            const monoDiameterGroup = document.getElementById('diametro-monoparete-group');
            const verticalComponents = document.getElementById('vertical-components');
            let currentStep = 1;

            const goToStep = (step) => {
                currentStep = step;
                formSteps.forEach(s => s.classList.toggle('active', parseInt(s.dataset.step) === currentStep));
            };

            const updateConditionalFields = () => {
                const isMonoparete = tipologiaSelect.value === 'monoparete';
                doppiapareteFields.classList.toggle('hidden', isMonoparete);
                monoMaterialGroup.classList.toggle('hidden', !isMonoparete);
                monoDiameterGroup.classList.toggle('hidden', !isMonoparete);
                const installazioneValue = document.querySelector('input[name="installazione"]:checked').value;
                verticalComponents.classList.toggle('hidden', installazioneValue !== 'verticale');
            };

            document.querySelectorAll('input[name="installazione"]').forEach(radio => { radio.addEventListener('change', updateConditionalFields); });
            tipologiaSelect.addEventListener('change', updateConditionalFields);
            nextButtons.forEach(b => b.addEventListener('click', () => goToStep(currentStep + 1)));
            prevButtons.forEach(b => b.addEventListener('click', () => goToStep(currentStep - 1)));
            calculateButton.addEventListener('click', () => { calcolaPreventivo(); goToStep(currentStep + 1); });

            const calcolaPreventivo = () => {
                const isMonoparete = tipologiaSelect.value === 'monoparete';
                let diametroText = isMonoparete ? document.querySelector('#diametro-mono option:checked').text : `${document.querySelector('#diametro-interno option:checked').text} / ${document.querySelector('#diametro-esterno option:checked').text}`;
                
                document.getElementById('riepilogo-installazione').textContent = document.querySelector('input[name="installazione"]:checked + label span').textContent;
                document.getElementById('riepilogo-tipologia').textContent = document.querySelector('#tipologia option:checked').text;
                document.getElementById('riepilogo-materiale').textContent = isMonoparete ? document.querySelector('#materiale-monoparete option:checked').text : document.querySelector('#materiale-doppiaparete option:checked').text;
                document.getElementById('riepilogo-diametro').textContent = diametroText;

                const componentInputs = document.querySelectorAll('.form-step[data-step="3"] input[type="number"]');
                const listaProdottiEl = document.getElementById('lista-prodotti');
                const prezzoTotaleEl = document.getElementById('prezzo-totale');
                listaProdottiEl.innerHTML = '';
                let totale = 0;

                componentInputs.forEach(input => {
                    const row = input.closest('.component-row');
                    if(row && (window.getComputedStyle(row).display === 'none' || (row.parentElement.id === 'vertical-components' && window.getComputedStyle(row.parentElement).display === 'none'))) return;

                    const quantita = parseInt(input.value);
                    if (quantita > 0) {
                        const prezzoUnitario = parseFloat(input.dataset.prezzo);
                        const nomeProdotto = input.dataset.nome;
                        const codiceProdotto = row.dataset.codiceProdotto;
                        const subTotale = quantita * prezzoUnitario;
                        totale += subTotale;
                        const li = document.createElement('li');
                        li.innerHTML = `<div class="product-info">${nomeProdotto} (x${quantita})<span class="product-code">Cod. ${codiceProdotto}</span></div><strong>€ ${subTotale.toFixed(2)}</strong>`;
                        listaProdottiEl.appendChild(li);
                    }
                });
                prezzoTotaleEl.textContent = `€ ${totale.toFixed(2)}`;
            };
            
            goToStep(1);
            updateConditionalFields();
        });
    </script>
</body>
</html>
