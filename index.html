<script>
    // --------------- FIREBASE CONFIGURATION ---------------
    const firebaseConfig = {
        apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y", // Usa la STESSA config della Home
        authDomain: "consorzio-artigiani-idraulici.firebaseapp.com",
        projectId: "consorzio-artigiani-idraulici",
        storageBucket: "consorzio-artigiani-idraulici.appspot.com", // Corretto con .appspot.com
        messagingSenderId: "136848104008",
        appId: "1:136848104008:web:2724f60607dbe91d09d67d",
        measurementId: "G-NNPV2607G7"
    };
    // ------------------------------------------------------

    try {
        // Utilizza l'SDK compatibile v9
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("Noleggi Page: Firebase App Initialized (compat).");
        } else {
            firebase.app(); // if already initialized, use that one
            console.log("Noleggi Page: Firebase App Already Initialized (compat), using existing.");
        }

        window.db = firebase.firestore();
        window.auth = firebase.auth();
        console.log("Noleggi Page: Firebase Services (db, auth) set on window (compat).");

        // Imposta la persistenza per la pagina Noleggi
        window.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log("Noleggi Page: Firebase Auth persistence set to LOCAL.");
                initializeAuthListenerForNoleggi(); // Chiama il listener dopo che la persistenza è impostata
            })
            .catch((error) => {
                console.error("Noleggi Page: Error setting Firebase Auth persistence:", error);
                initializeAuthListenerForNoleggi(); // Chiama comunque il listener, potrebbe funzionare con la default
            });

        function initializeAuthListenerForNoleggi() {
            let authStateChangeCountNoleggi = 0;
            window.auth.onAuthStateChanged(user => {
                authStateChangeCountNoleggi++;
                console.log(`Noleggi Page: onAuthStateChanged triggered (Count: ${authStateChangeCountNoleggi}). User object:`, user ? user.email : null);

                const loadingIndicator = document.getElementById('loading-indicator');
                const mainContent = document.getElementById('main-content-container');

                if (user) {
                    console.log("Noleggi Page: User IS authenticated:", user.email, user.uid);
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                        loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Caricamento permessi utente...';
                    }
                    if (mainContent) mainContent.style.display = 'none';

                    const userDocRef = window.db.collection('users').doc(user.uid);
                    userDocRef.get().then(doc => {
                        let userRole = 'user';
                        if (doc.exists && doc.data().role) {
                            userRole = doc.data().role;
                        } else {
                            console.warn(`Noleggi Page: User document or role not found in Firestore for UID ${user.uid}. Assigning default 'user' role. Access to admin features will be restricted.`);
                        }
                        window.currentUserRole = userRole;
                        console.log("Noleggi Page: User role set to:", window.currentUserRole);

                        document.body.classList.remove('logged-out');
                        document.body.classList.add('logged-in');
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        if (mainContent) mainContent.style.display = 'block';

                        if (typeof window.initializeApp === 'function') {
                            window.initializeApp(window.currentUserRole); // initializeApp è in code.js
                        } else {
                            console.error("Noleggi Page: initializeApp function not found (is code.js loaded?)!");
                        }
                    }).catch(error => {
                        console.error("Noleggi Page: Error fetching user role from Firestore:", error);
                        if (loadingIndicator) {
                            loadingIndicator.innerHTML = `<p style="color:red;">Errore nel recupero dei permessi utente. L'app potrebbe non funzionare come previsto.</p>`;
                        }
                        window.currentUserRole = 'user'; // Fallback a 'user' in caso di errore grave
                        document.body.classList.remove('logged-out');
                        document.body.classList.add('logged-in');
                        if (loadingIndicator) loadingIndicator.style.display = 'none';
                        if (mainContent) mainContent.style.display = 'block'; // Mostra comunque il contenuto base
                        if (typeof window.initializeApp === 'function') {
                            window.initializeApp(window.currentUserRole);
                        }
                    });
                } else {
                    console.log("Noleggi Page: User IS NOT authenticated.");
                    window.currentUserRole = null;
                    document.body.classList.add('logged-out');
                    document.body.classList.remove('logged-in');
                    if (mainContent) mainContent.style.display = 'none';
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                        loadingIndicator.innerHTML = `
                            <i class="fas fa-exclamation-circle"></i> Accesso Richiesto
                            <p style="font-size: 0.9em; margin-top: 10px;">
                                Per utilizzare questa sezione, per favore effettua il login dalla
                                <a href="../index.html" style="text-decoration: underline; color: var(--primary);">Pagina Principale</a>.
                            </p>`;
                    }
                    if (window.appInitialized) { // Se l'app era già inizializzata, segnala il cambio
                         window.appInitialized = false;
                         // Qui potresti voler resettare UI/dati specifici della pagina noleggi, se necessario
                    }
                }
            });
        } // Fine initializeAuthListenerForNoleggi

    } catch (error) {
        console.error("Noleggi Page: Firebase Initialization Failed:", error);
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) loadingIndicator.innerHTML = "ERRORE CRITICO: Impossibile caricare Firebase.";
        // alert("ERRORE CRITICO: Impossibile inizializzare Firebase sulla pagina Noleggi."); // L'alert può essere troppo invasivo
    }
</script>
