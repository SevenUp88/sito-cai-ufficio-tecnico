<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice Sconti - Visualizzazione da Firestore</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y",
        authDomain: "consorzio-artigiani-idraulici.firebaseapp.com",
        projectId: "consorzio-artigiani-idraulici",
        storageBucket: "consorzio-artigiani-idraulici.firebasestorage.app",
        messagingSenderId: "136848104008",
        appId: "1:136848104008:web:2724f60607dbe91d09d67d",
        measurementId: "G-NNPV2607G7"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const SCONTISTICHE_COLLECTION = "scontisticheProdotti";
    </script>

    <style>
        /* CSS come prima, ma gli stili per il modale potrebbero essere rimossi se non usati altrove */
        :root {
            --primary-color: #0056a8; /* Da style (2).css */
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --danger-color: #dc3545; /* Bootstrap danger */
            --warning-color: #ffc107;
            --header-height: 65px;

            --matrice-primary-color: var(--primary-color);
            --matrice-text-primary: var(--dark-color);
            --matrice-text-secondary: var(--secondary-color);
            --matrice-surface-color: var(--background-color);
            --matrice-bg-color: var(--light-color);
            --matrice-border-color: #e0e0e0;
            --matrice-accent-success: #198754; 
            --matrice-accent-danger: #dc3545;   
        }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--matrice-bg-color); color: var(--matrice-text-primary); line-height: 1.6; padding-top: var(--header-height); min-height: 100vh; font-weight: 400; }
        * { box-sizing: border-box; }

        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 30px; background-color: var(--background-color); box-shadow: 0 2px 5px rgba(0, 86, 168, 0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: var(--header-height); box-sizing: border-box; }
        .app-header .logo { height: 45px; width: auto; flex-shrink: 0; display: block; }
        .app-header a { line-height: 0; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .header-action-button { background: none; border: none; color: var(--primary-color); font-size: 1.8em; cursor: pointer; padding: 5px; transition: color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; }
        .header-action-button:hover { color: var(--matrice-accent-danger); }

        .main-container { max-width: 1300px; margin: 20px auto; padding: 20px; }
        
        .page-title-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 15px; }
        .title-group { flex-grow: 1; }
        .page-title-actions h1 { font-size: 2em; color: var(--primary-color); margin-top: 0; margin-bottom: 2px; font-weight: 700; line-height: 1.2;}
        .page-subtitle { font-size: 0.9em; color: var(--secondary-color, #6c757d); margin-top: 0; margin-bottom: 0; font-weight: 400; line-height: 1.4; }
        /* Rimosso stile per .page-title-actions .button-primary se non c'è più il bottone qui */


        .button { border: none; padding: 10px 18px; font-size: 0.9em; font-weight: 600; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; line-height: 1.4; }
        .button:hover { transform: translateY(-1px); }
        .button-secondary { background-color: var(--matrice-surface-color); color: var(--matrice-text-secondary); border: 1px solid var(--matrice-border-color); }
        .button-secondary:hover { background-color: #e9ecef; border-color: #ced4da; }

        .content-card { background-color: var(--matrice-surface-color); padding: 24px; border-radius: var(--border-radius); border: 1px solid var(--matrice-border-color); margin-bottom: 24px; box-shadow: var(--card-shadow); }
        .filters-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;}
        .filters { display: flex; gap: 20px; align-items: center; flex-wrap: wrap;}
        .filters label { font-weight: 500; margin-right: 8px; color: var(--matrice-text-secondary); font-size: 0.9em;}
        .filters select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.9em; background-color: #fff; color: var(--matrice-text-primary); min-width: 180px; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .filters select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25); }

        .discounts-matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px;}
        .discounts-matrix-table th, .discounts-matrix-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--matrice-border-color); font-size: 0.88em; vertical-align: top; }
        .discounts-matrix-table th { font-weight: 600; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--matrice-text-secondary); background-color: #f8f9fa; }
        .discounts-matrix-table tr:last-child td { border-bottom: none; }
        .discounts-matrix-table tbody tr:nth-child(even) { background-color: #fdfdfd; }
        .discounts-matrix-table tbody tr:hover { background-color: #e9f5fd; }
        .discounts-display { font-weight: 500; color: var(--matrice-text-primary); }
        .category-name { font-weight: 600; color: var(--primary-color); }
        .brand-name { font-weight: 500; color: var(--matrice-text-primary); }
        .service-centers-cell { font-size: 0.85em; line-height: 1.5; max-width: 280px; white-space: normal; word-break: break-word;}
        .service-centers-cell strong { color: var(--dark-color); }
        /* Rimuovi .actions e .action-button se non ci sono più azioni */
        /* Se la colonna Azioni viene rimossa del tutto: */
        /* .discounts-matrix-table th:last-child, .discounts-matrix-table td:last-child { display: none; } */


        .no-data { text-align: center; padding: 40px; color: var(--matrice-text-secondary); font-size: 1.1em; }
        
        /* Stili per .modal, .modal-content, .modal-actions etc. possono essere rimossi se non ci sono più modali */

        .toast { visibility: hidden; min-width: 250px; background-color: var(--matrice-accent-success); color: white; text-align: center; border-radius: var(--border-radius); padding: 16px; position: fixed; z-index: 2000; right: 30px; bottom: 30px; font-size: 1em; box-shadow: var(--card-shadow); opacity: 0; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; transform: translateY(20px); }
        .toast.show { visibility: visible; opacity: 1; transform: translateY(0); }

    </style>
</head>
<body>

    <header class="app-header">
        <a href="/" title="C.A.I. - Home">
             <img src="https://i.postimg.cc/Z5b3Yvr0/LOGO-CAI.png" alt="Logo CAI Consorzio Artigiani Idraulici" class="logo">
        </a>
        <div class="header-controls">
            <a href="/" class="header-action-button" title="Torna alla Home">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </header>

    <div class="main-container">
        <div class="page-title-actions">
            <div class="title-group">
                <h1>Scontistiche in vigore</h1>
                <p class="page-subtitle">Le percentuali di sconto devono essere applicate al valore di listino</p>
            </div>
            <!-- Bottone Nuova Regola RIMOSSO -->
        </div>

        <div class="content-card filters-container">
            <div class="filters">
                <div> <label for="category-filter">Categoria:</label> <select id="category-filter" onchange="triggerFilter()"><option value="">Tutte</option></select> </div>
                <div> <label for="brand-filter">Marca:</label> <select id="brand-filter" onchange="triggerFilter()"><option value="">Tutte</option></select> </div>
            </div>
            <button class="button button-secondary" onclick="resetFilters()" style="font-size:0.9em;">
                <i class="fas fa-undo" style="font-size:0.9em;"></i> Reset Filtri
            </button>
        </div>

        <div class="content-card">
            <table class="discounts-matrix-table">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Marca</th>
                        <th>Sconti Acquisto</th>
                        <th>Sconti Vendita</th>
                        <th>Agenzia</th>
                        <th>Centri Assistenza</th>
                        <!-- <th>Azioni</th> RIMOSSA COLONNA AZIONI -->
                    </tr>
                </thead>
                <tbody id="discounts-matrix-body"></tbody>
            </table>
            <div id="no-data-message" class="no-data" style="display: none;">Nessuna regola di sconto trovata.</div>
        </div>
    </div>

    <!-- MODALE RIMOSSO -->
    <!-- <div id="editRuleModal" class="modal"> ... </div> -->

    <div id="toast-notification" class="toast"></div>

    <script>
        // ----- SCRIPT SEMPLIFICATO SOLO PER LETTURA E FILTRI -----
        let allFirestoreData = []; 
        let currentFilteredRulesUI = [];

        const toastElement = document.getElementById('toast-notification');
        function showToast(message, duration = 3000) { toastElement.textContent = message; toastElement.classList.add("show"); setTimeout(() => toastElement.classList.remove("show"), duration); }

        async function loadDataFromFirestore() {
            showToast("Caricamento dati da Firestore...", 3000);
            try {
                const snapshot = await db.collection(SCONTISTICHE_COLLECTION).orderBy("categoria").orderBy("marca").get(); // Ordina i dati da Firestore
                allFirestoreData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Dati letti da Firestore:", JSON.parse(JSON.stringify(allFirestoreData)));
                
                populateUiFilters(allFirestoreData);
                applyUiFilters();
                showToast("Dati caricati!", 2000);
            } catch (error) {
                console.error("Errore lettura da Firestore:", error);
                showToast(`Errore caricamento: ${error.message}`, 5000);
                allFirestoreData = []; populateUiFilters([]); applyUiFilters();
            }
        }

        function formatDiscountString(arr) { if (!arr || arr.length === 0) return "N/A"; return arr.map(d => d + "%").join(" + ");}

        function populateUiFilters(dataToUse) {
            const categories = [...new Set(dataToUse.map(rule => rule.categoria))].sort();
            // Non serve popolare i brand qui se applyUiFilters li gestisce dinamicamente
            
            const categoryFilterEl = document.getElementById('category-filter');
            const catVal = categoryFilterEl.value;

            categoryFilterEl.innerHTML = '<option value="">Tutte</option>';
            categories.forEach(cat => categoryFilterEl.add(new Option(cat, cat)));
            if (categories.includes(catVal)) categoryFilterEl.value = catVal; else categoryFilterEl.value = "";
        }
        
        function triggerFilter() { applyUiFilters(); }

        function applyUiFilters() {
            const categoryValue = document.getElementById('category-filter').value;
            const brandFilterEl = document.getElementById('brand-filter');
            
            let brandsForCurrentCategory = [];
            if (categoryValue) {
                brandsForCurrentCategory = [...new Set(allFirestoreData
                                            .filter(rule => rule.categoria === categoryValue)
                                            .map(rule => rule.marca))].sort();
            } else { // Nessuna categoria selezionata, mostra tutti i brand disponibili nei dati caricati
                brandsForCurrentCategory = [...new Set(allFirestoreData.map(rule => rule.marca))].sort();
            }

            const currentBrandSelection = brandFilterEl.value;
            brandFilterEl.innerHTML = '<option value="">Tutte</option>';
            brandsForCurrentCategory.forEach(b => brandFilterEl.add(new Option(b, b)));
            
            if (brandsForCurrentCategory.includes(currentBrandSelection)) {
                brandFilterEl.value = currentBrandSelection;
            } else {
                brandFilterEl.value = ""; 
            }

            const finalBrandValue = brandFilterEl.value; 

            currentFilteredRulesUI = allFirestoreData.filter(rule => {
                const matchesCategory = !categoryValue || rule.categoria === categoryValue;
                const matchesBrand = !finalBrandValue || rule.marca === finalBrandValue;
                return matchesCategory && matchesBrand;
            });
            renderTable(currentFilteredRulesUI);
        }

        function resetFilters() {
            document.getElementById('category-filter').value = "";
            document.getElementById('brand-filter').value = ""; // Resetta anche il filtro marca
            applyUiFilters(); // Richiama applyUiFilters che ora gestisce anche il repopulate del filtro marca
            showToast("Filtri resettati.");
        }
        
        function renderTable(rulesToRender) {
            const tableBody = document.getElementById('discounts-matrix-body');
            const noDataMsg = document.getElementById('no-data-message');
            const tableElement = document.querySelector('.discounts-matrix-table'); // Assicurati che la tabella esista
            tableBody.innerHTML = ''; 

            if (!rulesToRender || rulesToRender.length === 0) {
                noDataMsg.textContent = "Nessuna regola di sconto corrisponde ai filtri selezionati.";
                noDataMsg.style.display = 'block';
                if(tableElement) tableElement.style.display = 'none';
                return;
            }
            noDataMsg.style.display = 'none';
            if(tableElement) tableElement.style.display = ''; // Mostra tabella

            // Non serve riordinare qui se i dati da Firestore sono già ordinati (con .orderBy)
            // Oppure, se vuoi un ordinamento client-side aggiuntivo, puoi farlo:
            const sortedRules = [...rulesToRender]; // Se non ordini, puoi rimuovere .sort()
            // .sort((a,b) => { ... }); // L'ordinamento attuale per categoria e marca è ok

            sortedRules.forEach(rule => {
                const row = tableBody.insertRow();
                let caDisplay = "N/A"; const ca = rule.centriAssistenza;
                if (ca && typeof ca === 'object' && Object.keys(ca).length > 0) {
                    const p = [];
                    if (ca.cesena) p.push(`<strong>Cesena:</strong> ${ca.cesena.nome}${ca.cesena.telefono?' ('+ca.cesena.telefono+')':''}`);
                    if (ca.savignano) p.push(`<strong>Savignano:</strong> ${ca.savignano.nome}${ca.savignano.telefono?' ('+ca.savignano.telefono+')':''}`);
                    if (ca.rimini) p.push(`<strong>Rimini:</strong> ${ca.rimini.nome}${ca.rimini.telefono?' ('+ca.rimini.telefono+')':''}`);
                    caDisplay = p.join('<br>');
                }
                
                row.innerHTML = `
                    <td class="category-name">${rule.categoria}</td> <td class="brand-name">${rule.marca}</td>
                    <td class="discounts-display">${formatDiscountString(rule.scontiAcquisto)}</td>
                    <td class="discounts-display">${formatDiscountString(rule.scontiVendita)}</td>
                    <td>${rule.agente || 'N/A'}</td> <td class="service-centers-cell">${caDisplay}</td>
                    <!-- Colonna Azioni RIMOSSA --> `;
            });
        }
        document.addEventListener('DOMContentLoaded', loadDataFromFirestore);
        // ----- FINE SCRIPT -----
    </script>
</body>
</html>
