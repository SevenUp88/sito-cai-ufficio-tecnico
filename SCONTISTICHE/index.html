<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice Sconti & Calcolatore - Protetto</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyC_gm-MK5dk2jc_MmmwO7TWBm7oW_D5t1Y",
        authDomain: "consorzio-artigiani-idraulici.firebaseapp.com",
        projectId: "consorzio-artigiani-idraulici",
        storageBucket: "consorzio-artigiani-idraulici.firebasestorage.app",
        messagingSenderId: "136848104008",
        appId: "1:136848104008:web:2724f60607dbe91d09d67d",
        measurementId: "G-NNPV2607G7"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const SCONTISTICHE_COLLECTION = "scontisticheProdotti";
    </script>

    <style>
        :root {
            --primary-color: #0056a8; --secondary-color: #6c757d; --light-color: #f8f9fa;
            --dark-color: #343a40; --background-color: #ffffff; --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 8px; --danger-color: #dc3545; --warning-color: #ffc107;
            --header-height: 65px; --matrice-primary-color: var(--primary-color);
            --matrice-text-primary: var(--dark-color); --matrice-text-secondary: var(--secondary-color);
            --matrice-surface-color: var(--background-color); --matrice-bg-color: var(--light-color);
            --matrice-border-color: #e0e0e0; --matrice-accent-success: #198754;
            --matrice-accent-danger: #dc3545;
        }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--matrice-bg-color); color: var(--matrice-text-primary); line-height: 1.6; padding-top: var(--header-height); min-height: 100vh; font-weight: 400; }
        * { box-sizing: border-box; }

        /* Stili CSS rimangono invariati... */
        #auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - var(--header-height) - 40px); padding: 20px; }
        .login-form { background-color: var(--background-color); padding: 30px 40px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); width: 100%; max-width: 400px; text-align: center; }
        .login-form h2 { color: var(--primary-color); margin-bottom: 25px; }
        .login-form .form-group { margin-bottom: 20px; text-align: left; }
        .login-form label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--secondary-color); }
        .login-form input[type="email"], .login-form input[type="password"] { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1em; }
        .login-form .button-login { background-color: var(--primary-color); color: white; padding: 12px; width: 100%; font-size: 1.1em; border: none; border-radius: var(--border-radius); cursor: pointer; }
        .auth-error { color: var(--danger-color); margin-top: 15px; font-size: 0.9em; min-height: 1.2em; }
        .content-hidden { display: none !important; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 30px; background-color: var(--background-color); box-shadow: 0 2px 5px rgba(0,86,168,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: var(--header-height); }
        .app-header .logo { height: 45px; width: auto; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .header-user-info { font-size: 0.85em; color: var(--secondary-color); }
        .button-logout { background: none; border: 1px solid var(--secondary-color); color: var(--secondary-color); font-size: 0.85em; padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .main-container { max-width: 1300px; margin: 20px auto; padding: 20px; }
        .content-card { background-color: var(--matrice-surface-color); padding: 24px; border-radius: var(--border-radius); border: 1px solid var(--matrice-border-color); margin-bottom: 24px; box-shadow: var(--card-shadow); }
        .filters-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;}
        .filters { display: flex; gap: 20px; align-items: center; flex-wrap: wrap;}
        .button { border: none; padding: 10px 18px; font-size: 0.9em; font-weight: 600; border-radius: var(--border-radius); cursor: pointer; }
        .button-secondary { background-color: var(--matrice-surface-color); color: var(--matrice-text-secondary); border: 1px solid var(--matrice-border-color); }
        .discounts-matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px;}
        .discounts-matrix-table th, .discounts-matrix-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--matrice-border-color); font-size: 0.85em; vertical-align: top; }
        .discounts-matrix-table th { font-weight: 600; font-size: 0.8em; text-transform: uppercase; color: var(--matrice-text-secondary); background-color: #f8f9fa; }
        .category-name { font-weight: 600; color: var(--primary-color); }
        .no-data { text-align: center; padding: 40px; color: var(--matrice-text-secondary); }
    </style>
</head>
<body>

    <header class="app-header">
         <img src="https://i.postimg.cc/Z5b3Yvr0/LOGO-CAI.png" alt="Logo CAI Consorzio Artigiani Idraulici" class="logo">
        <div class="header-controls">
            <div id="user-info-header" class="header-user-info content-hidden">Utente: <strong id="user-email-display"></strong></div>
            <button id="logout-button" class="button-logout content-hidden" title="Esci"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>

    <div id="auth-container">
        <div class="login-form">
            <h2>Accesso Riservato Matrice Sconti</h2>
            <div class="form-group"><label for="email">Email:</label><input type="email" id="email" required></div>
            <div class="form-group"><label for="password">Password:</label><input type="password" id="password" required></div>
            <button id="login-button" class="button button-login">Accedi</button>
            <p id="auth-error-message" class="auth-error"></p>
        </div>
    </div>

    <div id="main-content-wrapper" class="main-container content-hidden">
        <div id="app-loader" class="loader content-hidden"></div>
        
        <!-- Intestazione pagina rimossa per brevità, l'utente ce l'ha già -->

        <!-- Calcolatore rimosso per brevità, l'utente ce l'ha già -->

        <div class="content-card filters-container">
            <div class="filters">
                <div> <label for="category-filter">Categoria:</label> <select id="category-filter" onchange="triggerFilter()"><option value="">Tutte</option></select> </div>
                <div> <label for="brand-filter">Marca:</label> <select id="brand-filter" onchange="triggerFilter()"><option value="">Tutte</option></select> </div>
            </div>
            <button class="button button-secondary" onclick="resetFilters()"><i class="fas fa-undo"></i> Reset Filtri</button>
        </div>

        <div class="content-card">
            <table class="discounts-matrix-table">
                <thead><tr><th>Categoria</th><th>Marca</th><th>Sconti Acquisto</th><th>Trasporto (%)</th><th>Sconti Vendita</th><th>Agenzia</th><th>Centri Assistenza</th></tr></thead>
                <tbody id="discounts-matrix-body"></tbody>
            </table>
            <div id="no-data-message" class="no-data" style="display: none;">Nessuna regola.</div>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script>
    // #######################################################################
    //                       SCRIPT PRINCIPALE DELL'APPLICAZIONE
    // #######################################################################
    
    // ----- 1. DEFINIZIONI GLOBALI E COSTANTI -----
    let allFirestoreData = [];
    let processedAndMergedData = []; // NUOVO: Conterrà i dati puliti e senza doppioni
    let currentFilteredRulesUI = [];

    // Riferimenti agli elementi del DOM (invariati)
    const authContainer = document.getElementById('auth-container'); 
    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const appLoader = document.getElementById('app-loader');
    const loginButton = document.getElementById('login-button');
    const logoutButton = document.getElementById('logout-button'); 
    const userInfoHeader = document.getElementById('user-info-header');
    const userEmailDisplay = document.getElementById('user-email-display');

    
    // ----- 2. FUNZIONI HELPER -----
    
    /**
     * Formatta un array in una stringa leggibile (es. "50 / 6").
     * Aggiunge il simbolo % se l'elemento è un numero.
     */
    function formattaArray(array) {
      if (!array || array.length === 0) return 'N/A';
      return array.map(item => {
          if (typeof item === 'number') {
              return `${item}%`; // Aggiunge il simbolo % solo ai numeri
          }
          return item; // Lascia il testo così com'è (es. SOGECOM)
      }).join(' + '); // Usa '+' come separatore come nell'immagine
    }
    
    /**
     * Mostra una notifica toast.
     */
    function showToast(message, duration = 3000) {
        const toastElement = document.getElementById('toast-notification');
        toastElement.textContent = message; 
        toastElement.classList.add("show"); 
        setTimeout(() => toastElement.classList.remove("show"), duration); 
    }

    
    // ----- 3. LOGICA PRINCIPALE (MERGE, TABELLE, FILTRI) -----
    
    /**
     * NUOVA FUNZIONE: Prende i dati grezzi da Firestore e li unisce.
     * Risolve il problema dei doppioni.
     */
    function processAndMergeData() {
        const merged = {}; // Usiamo un oggetto per unire i dati facilmente
        
        allFirestoreData.forEach(rule => {
            const key = `${rule.categoria}|${rule.marca}`; // Chiave univoca es. "Climatizzazione|Haier"
            
            if (!merged[key]) {
                // Se è la prima volta che vediamo questa combinazione, la aggiungiamo.
                merged[key] = { ...rule };
            } else {
                // Se esiste già, la aggiorniamo, dando priorità ai dati più "completi".
                // Questo fonde la riga con gli sconti e la riga con il trasporto.
                const existing = merged[key];
                
                // Priorità a chi ha sconti
                if (rule.scontiAcquisto && rule.scontiAcquisto.length > 0) existing.scontiAcquisto = rule.scontiAcquisto;
                if (rule.scontiVendita && rule.scontiVendita.length > 0) existing.scontiVendita = rule.scontiVendita;
                
                // Priorità a chi ha un agente definito
                if (rule.agente) existing.agente = rule.agente;
                
                // Priorità a chi ha il trasporto definito (e non nullo)
                if (typeof rule.trasporto === 'number') existing.trasporto = rule.trasporto;

                // Priorità a chi ha i centri assistenza
                if (rule.centriAssistenza && rule.centriAssistenza.length > 0) existing.centriAssistenza = rule.centriAssistenza;
            }
        });
        
        // Convertiamo l'oggetto fuso in un array e lo salviamo nella variabile globale.
        processedAndMergedData = Object.values(merged);
    }

    /**
     * Popola la tabella HTML con le regole di sconto fornite.
     */
    function renderTable(rulesToRender) {
        const tableBody = document.getElementById('discounts-matrix-body');
        const noDataMsg = document.getElementById('no-data-message');
        tableBody.innerHTML = ''; 

        if (!rulesToRender || rulesToRender.length === 0) {
            noDataMsg.textContent = "Nessuna regola per i filtri selezionati.";
            noDataMsg.style.display = 'block';
            return;
        }
        noDataMsg.style.display = 'none';

        const sortedRules = [...rulesToRender].sort((a,b) => a.categoria.localeCompare(b.categoria) || a.marca.localeCompare(b.marca));

        sortedRules.forEach(rule => {
            const row = tableBody.insertRow();
            
            let trasportoDisplay = "N/A";
            if (typeof rule.trasporto === 'number') {
                trasportoDisplay = `${rule.trasporto.toFixed(2)}%`;
            }
            
            row.innerHTML = `
                <td class="category-name">${rule.categoria || 'N/A'}</td> 
                <td class="brand-name">${rule.marca || 'N/A'}</td>
                <td>${formattaArray(rule.scontiAcquisto)}</td>
                <td>${trasportoDisplay}</td>
                <td>${formattaArray(rule.scontiVendita)}</td>
                <td>${rule.agente || 'N/A'}</td>
                <td>${formattaArray(rule.centriAssistenza)}</td>
            `;
        });
    }

    /**
     * Popola i filtri usando i dati già fusi e puliti.
     */
    function populateUiFilters() {
        // Usa `processedAndMergedData` invece di `allFirestoreData`
        const categories = [...new Set(processedAndMergedData.map(rule => rule.categoria))].sort();
        const categoryFilterEl = document.getElementById('category-filter');
        categoryFilterEl.innerHTML = '<option value="">Tutte</option>';
        categories.forEach(cat => categoryFilterEl.add(new Option(cat, cat)));
    }
    
    /**
     * Applica i filtri sui dati fusi e puliti e aggiorna la UI.
     */
    function applyUiFilters() {
        const categoryValue = document.getElementById('category-filter').value;
        const brandFilterEl = document.getElementById('brand-filter');
        
        // Popola il filtro marche in base alla categoria selezionata, usando i dati fusi.
        let brandsForCurrentCategory = [];
        if (categoryValue) {
            brandsForCurrentCategory = [...new Set(processedAndMergedData.filter(r => r.categoria === categoryValue).map(r => r.marca))].sort();
        } else {
            brandsForCurrentCategory = [...new Set(processedAndMergedData.map(r => r.marca))].sort();
        }
        
        const currentBrandSelection = brandFilterEl.value;
        brandFilterEl.innerHTML = '<option value="">Tutte</option>';
        brandsForCurrentCategory.forEach(b => brandFilterEl.add(new Option(b,b)));
        brandFilterEl.value = brandsForCurrentCategory.includes(currentBrandSelection) ? currentBrandSelection : "";
        const finalBrandValue = brandFilterEl.value; 

        // Filtra i dati finali
        currentFilteredRulesUI = processedAndMergedData.filter(rule => 
            (!categoryValue || rule.categoria === categoryValue) &&
            (!finalBrandValue || rule.marca === finalBrandValue)
        );
        
        renderTable(currentFilteredRulesUI);
    }

    function resetFilters() {
        document.getElementById('category-filter').value = "";
        document.getElementById('brand-filter').value = "";
        applyUiFilters(); 
        showToast("Filtri resettati.");
    }
    function triggerFilter() { applyUiFilters(); }

    /**
     * Carica i dati da Firestore, li processa e li unisce.
     */
    async function loadDataFromFirestore() {
        showToast("Caricamento dati...", 2500); 
        appLoader.classList.remove('content-hidden');
        try {
            const snapshot = await db.collection(SCONTISTICHE_COLLECTION).get();
            allFirestoreData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // --- PASSAGGIO CHIAVE: Processa e unisce i dati ---
            processAndMergeData();

            // Ora i filtri e la tabella lavoreranno sui dati puliti.
            populateUiFilters(); 
            applyUiFilters();
        } catch (error) { 
            console.error("Firestore Read Err:", error); 
            showToast("Errore nel caricamento dati.", 4000); 
            processedAndMergedData = [];
            populateUiFilters();
            applyUiFilters(); 
        } finally { 
            appLoader.classList.add('content-hidden'); 
        }
    }


    // ----- 4. GESTIONE AUTENTICAZIONE E LISTENER -----
    auth.onAuthStateChanged(async (user) => {
        appLoader.classList.remove('content-hidden');
        if (user) {
            authContainer.classList.add('content-hidden'); 
            mainContentWrapper.classList.remove('content-hidden');
            userEmailDisplay.textContent = user.email;
            userInfoHeader.classList.remove('content-hidden'); 
            logoutButton.classList.remove('content-hidden');
            await loadDataFromFirestore();
        } else {
            authContainer.classList.remove('content-hidden'); 
            mainContentWrapper.classList.add('content-hidden');
            userInfoHeader.classList.add('content-hidden');
            logoutButton.classList.add('content-hidden');
            processedAndMergedData = []; // Pulisce i dati al logout
            populateUiFilters();
            applyUiFilters();
        }
        appLoader.classList.add('content-hidden');
    });

    // Listener per i bottoni (invariati, l'utente li ha già)
    loginButton.addEventListener('click', () => { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => { showToast("Credenziali non valide", 3000); }); });
    logoutButton.addEventListener('click', () => { auth.signOut(); });
    
    </script>
</body>
</html>
