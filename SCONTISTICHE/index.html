<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrice Sconti - Sconti Pro</title>
    <!-- Stile di base per questo prototipo, potresti voler integrare style (2).css -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* :root e stili base dal tuo style (2).css, adattati se necessario */
        :root {
            --primary-color: #0056a8; /* Da style (2).css */
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --header-height: 65px;

            /* Colori specifici della matrice sconti (se diversi, altrimenti usa quelli sopra) */
            --matrice-primary-color: var(--primary-color); /* Eredita o sovrascrivi */
            --matrice-text-primary: var(--dark-color);
            --matrice-text-secondary: var(--secondary-color);
            --matrice-surface-color: var(--background-color);
            --matrice-bg-color: var(--light-color);
            --matrice-border-color: #e0e0e0; /* Simile a product-card border */
            --matrice-accent-success: #27ae60; /* Mantenuto da matrice originale */
            --matrice-accent-danger: #c0392b;   /* Mantenuto da matrice originale */

        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--matrice-bg-color);
            color: var(--matrice-text-primary);
            line-height: 1.6;
            padding-top: var(--header-height); /* Spazio per header fisso */
            min-height: 100vh;
            font-weight: 400;
        }

        * { box-sizing: border-box; }

        /* === Header Styles (da style (2).css) === */
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 30px; background-color: var(--background-color); box-shadow: 0 2px 5px rgba(0, 86, 168, 0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: var(--header-height); box-sizing: border-box; }
        .app-header .logo { height: 45px; width: auto; flex-shrink: 0; display: block; }
        .app-header a { line-height: 0; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .header-action-button { background: none; border: none; color: var(--primary-color); font-size: 1.8em; cursor: pointer; padding: 5px; transition: color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; }
        .header-action-button:hover { color: var(--danger-color); }
        /* Fine Header Styles */


        /* Container principale della pagina Matrice Sconti */
        .main-container {
            max-width: 1300px; /* Un po' più largo per la tabella */
            margin: 20px auto;
            padding: 20px;
        }

        .page-title-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title-actions h1 {
            font-size: 2em;
            color: var(--primary-color); /* Uso il blu primario per il titolo */
            margin-top: 0;
            margin-bottom: 0; /* Tolto margine inferiore per allineare meglio */
            font-weight: 700;
        }

        .button {
            border: none;
            padding: 10px 18px; /* Leggermente meno padding orizzontale */
            font-size: 0.9em;   /* Leggermente più piccolo */
            font-weight: 600;
            border-radius: var(--border-radius); /* Usa il border-radius standard */
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            line-height: 1.4; /* Aggiunto per coerenza */
        }
        .button:hover { transform: translateY(-1px); }
        .button:active { transform: translateY(0); }

        .button-primary { background-color: var(--matrice-primary-color); color: white; }
        .button-primary:hover { background-color: #004182; /* Più scuro del primary-color */ box-shadow: 0 2px 8px rgba(0, 86, 168, 0.3); }
        .button-secondary { background-color: var(--matrice-surface-color); color: var(--matrice-text-secondary); border: 1px solid var(--matrice-border-color); }
        .button-secondary:hover { background-color: #e9ecef; border-color: #ced4da; }
        .button-danger { background-color: var(--matrice-accent-danger); color:white; } /* Era var(--accent-color-danger) */
        .button-danger:hover { background-color: #a5281b; box-shadow: 0 2px 8px rgba(192, 57, 43, 0.3); }


        /* Card per filtri e tabella */
        .content-card {
            background-color: var(--matrice-surface-color);
            padding: 24px;
            border-radius: var(--border-radius);
            border: 1px solid var(--matrice-border-color);
            margin-bottom: 24px;
            box-shadow: var(--card-shadow); /* Usa lo shadow standard */
        }
        .filters-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;}
        .filters { display: flex; gap: 20px; align-items: center; flex-wrap: wrap;}
        .filters label { font-weight: 500; margin-right: 8px; color: var(--matrice-text-secondary); font-size: 0.9em;}
        .filters select, .filters input[type="text"] { /* Stile input/select simile a style(2).css */
            padding: 8px 12px;
            border-radius: 4px; /* Ridotto border-radius */
            border: 1px solid #ced4da; /* Colore bordo standard */
            font-size: 0.9em;
            background-color: #fff; /* Sfondo bianco */
            color: var(--matrice-text-primary);
            min-width: 180px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .filters select:focus, .filters input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color); /* Usa il primary-color per il focus */
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25); /* Stile focus standard Bootstrap-like */
        }

        .discounts-matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px;}
        .discounts-matrix-table th, .discounts-matrix-table td {
            padding: 12px 15px; /* Ridotto padding per celle */
            text-align: left;
            border-bottom: 1px solid var(--matrice-border-color);
            font-size: 0.88em; /* Leggermente più piccolo */
            vertical-align: top;
        }
        .discounts-matrix-table th {
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--matrice-text-secondary);
            background-color: #f8f9fa; /* Sfondo leggero per header tabella */
        }
        .discounts-matrix-table tr:last-child td { border-bottom: none; }
        .discounts-matrix-table tbody tr:nth-child(even) { background-color: #fdfdfd; } /* Righe alternate */
        .discounts-matrix-table tbody tr:hover { background-color: #e9f5fd; } /* Hover più evidente */

        .discounts-display { font-weight: 500; color: var(--matrice-text-primary); }
        .category-name { font-weight: 600; color: var(--primary-color); } /* Usa colore primario */
        .brand-name { font-weight: 500; color: var(--matrice-text-primary); }
        .service-centers-cell { font-size: 0.85em; line-height: 1.5; }
        .service-centers-cell strong { color: var(--dark-color); } /* Evidenzia nome città */


        .actions .action-button {
            font-size: 0.8em; padding: 5px 8px; border-radius: 4px;
            border: 1px solid transparent; margin-left: 4px;
        }
        .actions .edit-btn { background-color: #e0efff; color: var(--primary-color); border-color: #b3d7ff; }
        .actions .edit-btn:hover { background-color: #cce5ff; }
        .actions .delete-btn { background-color: #f8d7da; color: var(--danger-color); border-color: #f5c2c7;}
        .actions .delete-btn:hover { background-color: #f1c1c5; }


        .no-data { text-align: center; padding: 40px; color: var(--matrice-text-secondary); font-size: 1.1em; }

        /* Stili Modale (simili alla versione precedente ma con colori allineati) */
        .modal {
            display: none; position: fixed; z-index: 1030; /* Sopra la maggior parte degli elementi */
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0, 0, 0, 0.6); /* Sfondo più scuro */
        }
        .modal-content {
            background-color: var(--matrice-surface-color);
            margin: 5% auto; padding: 25px 35px;
            border-radius: var(--border-radius); width: 90%; max-width: 650px; /* Max-width leggermente aumentata */
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeInModal 0.3s ease-out;
        }
        @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .modal-content h3 { margin-top:0; font-size:1.6em; color: var(--primary-color); font-weight: 600; margin-bottom: 25px; text-align: center; }
        .modal-content .form-group { margin-bottom: 16px; }
        .modal-content label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--matrice-text-secondary); font-size:0.9em; }
        .modal-content input[type="text"], .modal-content input[type="number"] {
            width: 100%; padding: 10px 12px; /* Adattato padding */
            border: 1px solid #ced4da;
            border-radius: 4px; font-size: 0.95em;
            background-color: #fff;
            color: var(--matrice-text-primary);
        }
        .modal-content input[type="text"]:focus, .modal-content input[type="number"]:focus {
             outline: none; border-color: var(--primary-color);
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
        }
        .sconto-fields { display: flex; gap: 10px; margin-bottom: 8px; }
        .sconto-fields:last-of-type { margin-bottom: 0; }
        .sconto-fields input { width: calc( (100% / 3) - (20px / 3) ); }


        .modal-actions { text-align: right; margin-top: 30px; display: flex; justify-content: flex-end; gap: 12px;}
        .modal-actions .button-primary { background-color: var(--matrice-accent-success); } /* Verde per salva */
        .modal-actions .button-primary:hover { background-color: #1f8b4c; }


        /* Toast (invariato ma usa variabili globali se possibile) */
        .toast { /* ... invariato ... */ }
        .modal-row { /* ... invariato ... */ }

    </style>
</head>
<body>

    <header class="app-header">
        <a href="/" title="C.A.I. - Home"> <!-- Link alla Home del sito -->
             <img src="https://i.postimg.cc/Z5b3Yvr0/LOGO-CAI.png" alt="Logo CAI Consorzio Artigiani Idraulici" class="logo">
        </a>
        <div class="header-controls">
            <!-- Potresti aggiungere altri controlli qui se necessario per la matrice sconti -->
            <a href="/" class="header-action-button" title="Torna alla Home">
                <i class="fas fa-home"></i>
            </a>
        </div>
    </header>

    <div class="main-container">
        <div class="page-title-actions">
            <h1>Matrice Sconti Applicati</h1>
            <button class="button button-primary" onclick="openAddRuleModal()">
                <i class="fas fa-plus" style="font-size:0.9em;"></i> Nuova Regola
            </button>
        </div>

        <div class="content-card filters-container">
            <div class="filters">
                <div>
                    <label for="category-filter">Categoria:</label>
                    <select id="category-filter" onchange="filterDiscountRules()">
                        <option value="">Tutte</option>
                    </select>
                </div>
                <div>
                    <label for="brand-filter">Marca:</label>
                    <select id="brand-filter" onchange="filterDiscountRules()">
                        <option value="">Tutte</option>
                    </select>
                </div>
            </div>
            <button class="button button-secondary" onclick="resetFilters()" style="font-size:0.9em;">
                <i class="fas fa-undo" style="font-size:0.9em;"></i> Reset Filtri
            </button>
        </div>

        <div class="content-card">
            <table class="discounts-matrix-table">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Marca</th>
                        <th>Sconti Acquisto</th>
                        <th>Sconti Vendita</th>
                        <th>Agenzia</th>
                        <th>Centri Assistenza</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="discounts-matrix-body"></tbody>
            </table>
            <div id="no-data-message" class="no-data" style="display: none;">Nessuna regola di sconto corrisponde ai filtri selezionati (o dati non ancora caricati).</div>
        </div>
    </div> <!-- Fine .main-container -->

    <div id="editRuleModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Modifica Regola Sconto</h3>
            <input type="hidden" id="editRuleId">

            <div class="modal-row">
                <div class="form-group">
                    <label for="editCategoria">Categoria</label>
                    <input type="text" id="editCategoria" placeholder="Nome categoria">
                </div>
                <div class="form-group">
                    <label for="editMarca">Marca</label>
                    <input type="text" id="editMarca" placeholder="Nome marca">
                </div>
            </div>
             <!-- Sottocategoria rimossa -->

            <hr style="margin: 20px 0; border-color: var(--matrice-border-color); border-top:none;">
            
            <div class="form-group">
                <label for="editAgente">Agenzia Rappresentante</label>
                <input type="text" id="editAgente" placeholder="Nome agenzia (futuro: ref + tel)">
            </div>
            
            <div class="form-group">
                <label>Centri Assistenza (formato: Nome | Telefono)</label>
                <div class="sconto-fields"> <!-- Riusa .sconto-fields per layout, ma questi sono text -->
                    <input type="text" id="editCentroAssistenza1" placeholder="Assistenza Cesena">
                    <input type="text" id="editCentroAssistenza2" placeholder="Assistenza Savignano">
                    <input type="text" id="editCentroAssistenza3" placeholder="Assistenza Rimini">
                </div>
            </div>
             <hr style="margin: 20px 0; border-color: var(--matrice-border-color); border-top:none;">


            <div class="form-group">
                <label>Sconti Acquisto (max 6, lasciare vuoto se non applicabile)</label>
                <div class="sconto-fields">
                    <input type="number" id="editScontoAcquisto1" placeholder="Sconto 1 %" min="0" max="100" step="0.01">
                    <input type="number" id="editScontoAcquisto2" placeholder="Sconto 2 %" min="0" max="100" step="0.01">
                    <input type="number" id="editScontoAcquisto3" placeholder="Sconto 3 %" min="0" max="100" step="0.01">
                </div>
                <div class="sconto-fields">
                    <input type="number" id="editScontoAcquisto4" placeholder="Sconto 4 %" min="0" max="100" step="0.01">
                    <input type="number" id="editScontoAcquisto5" placeholder="Sconto 5 %" min="0" max="100" step="0.01">
                    <input type="number" id="editScontoAcquisto6" placeholder="Sconto 6 %" min="0" max="100" step="0.01">
                </div>
            </div>
            <div class="form-group">
                <label>Sconti Vendita (max 2, lasciare vuoto se non applicabile)</label>
                <div class="sconto-fields">
                    <input type="number" id="editScontoVendita1" placeholder="Sconto 1 %" min="0" max="100" step="0.01">
                    <input type="number" id="editScontoVendita2" placeholder="Sconto 2 %" min="0" max="100" step="0.01">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="button button-secondary" onclick="closeModal()">Annulla</button>
                <button type="button" class="button button-primary" onclick="saveRuleChanges()"> <!-- Stile del bottone "Salva" ereditato e corretto sopra -->
                    <i class="fas fa-check" style="font-size:0.9em;"></i> Salva
                </button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast">Messaggio Toast!</div>

    <script>
        // ----- INIZIO SCRIPT -----
        let discountRulesData = [];
        let currentFilteredRules = [];
        let nextId = 1;

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR7adRsTXVEHY2zeVqHmlYj1n259pWbMxE1I9ihp1DKmOtlHH135ZxC5xLeF2xn_EKaNcZB0NpLbBX5/pub?gid=623616075&single=true&output=csv';

        const modal = document.getElementById('editRuleModal');
        const modalTitle = document.getElementById('modalTitle');
        const editRuleIdInput = document.getElementById('editRuleId');
        const editCategoriaInput = document.getElementById('editCategoria');
        // Sottocategoria rimossa dai campi JS principali
        const editMarcaInput = document.getElementById('editMarca');
        const editAgenteInput = document.getElementById('editAgente'); // Nome agenzia
        
        const editCentroAssistenza1Input = document.getElementById('editCentroAssistenza1');
        const editCentroAssistenza2Input = document.getElementById('editCentroAssistenza2');
        const editCentroAssistenza3Input = document.getElementById('editCentroAssistenza3');
        
        const toastElement = document.getElementById('toast-notification');

        function showToast(message, duration = 3000) { /* ...invariata... */ }
        
        async function loadDataFromCSV() {
            try {
                showToast("Caricamento dati dal CSV...", 2000);
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error(`Errore HTTP: ${response.status} ${response.statusText}`);
                
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).map(row => 
                    row.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''))
                );

                const headersRaw = rows[0];
                if (!headersRaw || headersRaw.length === 0) throw new Error("Header CSV non valido.");
                
                const headerMap = {};
                headersRaw.forEach((header, index) => {
                    headerMap[String(header).trim().toLowerCase()] = index;
                });
                console.log("Header CSV mappati:", headerMap);

                const parseCSVCascadeDiscount = (str) => {
                    if (!str || typeof str !== 'string') return [];
                    return str.split(';').map(s => parseFloat(String(s).trim().replace(',', '.'))).filter(n => !isNaN(n) && n >= 0 && n <= 100);
                };
                const parseCSVCentroAssistenza = (str) => {
                    const s = String(str || "").trim();
                    if (!s || s.toLowerCase() === 'no' || s.toLowerCase() === 'n/d') return null;
                    const parts = s.split('|').map(p => p.trim());
                    return (parts.length >= 1 && parts[0]) ? { nome: parts[0], telefono: (parts[1] || null) } : null;
                };
                
                discountRulesData = rows.slice(1).map((row, csvRowIndex) => {
                    if (row.join('').trim() === '') return null;
                    
                    const idFromCSV = row[headerMap['id']] ? String(row[headerMap['id']]).trim() : null;
                    const id = (idFromCSV && idFromCSV.length > 0) ? idFromCSV : `csv_${Date.now()}_${csvRowIndex}`;
                    
                    const categoria = row[headerMap['categoria']];
                    const marca = row[headerMap['marca']];
                    if (!categoria || !marca) return null;

                    const scontiAcquisto = parseCSVCascadeDiscount(row[headerMap['sconto_in_acquisto']]);
                    const scontiVendita = parseCSVCascadeDiscount(row[headerMap['sconto_in_vendita']]);
                    const agente = row[headerMap['agenzia']];
                    
                    const centriAssistenza = {};
                    const pCesena = parseCSVCentroAssistenza(row[headerMap['assistenza_cesena']]);
                    if (pCesena) centriAssistenza.cesena = pCesena;
                    const pSavignano = parseCSVCentroAssistenza(row[headerMap['assistenza_savignano']]);
                    if (pSavignano) centriAssistenza.savignano = pSavignano;
                    const pRimini = parseCSVCentroAssistenza(row[headerMap['assistenza_rimini']]);
                    if (pRimini) centriAssistenza.rimini = pRimini;
                    
                    return { id, categoria, marca, scontiAcquisto, scontiVendita, agente, centriAssistenza, sottocategoria: "" };
                }).filter(rule => rule !== null);

                if (discountRulesData.length > 0) { /* ... Logica nextId come prima ... */ }
                
                showToast("Dati CSV processati!", 3000);
                console.log("Dati caricati:", JSON.parse(JSON.stringify(discountRulesData)));

            } catch (error) { /* ... Gestione errori come prima ... */ } 
            finally { populateFilters(); filterDiscountRules(); }
        }

        function getScontiFromFields(baseId, count) { /* ...invariata... */ }
        function setScontiToFields(baseId, count, scontiArray) { /* ...invariata... */ }

        function openEditModal(ruleId) {
            const rule = discountRulesData.find(r => String(r.id) === String(ruleId));
            if (!rule) { console.error("MODIFICA: Regola non trovata:", ruleId); return; }
            
            modalTitle.textContent = "Modifica Regola Sconto";
            editRuleIdInput.value = rule.id;
            editCategoriaInput.value = rule.categoria;
            editMarcaInput.value = rule.marca;
            editAgenteInput.value = rule.agente || "";

            const caObj = rule.centriAssistenza || {};
            if (editCentroAssistenza1Input) editCentroAssistenza1Input.value = caObj.cesena ? `${caObj.cesena.nome}${caObj.cesena.telefono ? ' | ' + caObj.cesena.telefono : ''}` : "";
            if (editCentroAssistenza2Input) editCentroAssistenza2Input.value = caObj.savignano ? `${caObj.savignano.nome}${caObj.savignano.telefono ? ' | ' + caObj.savignano.telefono : ''}` : "";
            if (editCentroAssistenza3Input) editCentroAssistenza3Input.value = caObj.rimini ? `${caObj.rimini.nome}${caObj.rimini.telefono ? ' | ' + caObj.rimini.telefono : ''}` : "";
            
            setScontiToFields('editScontoAcquisto', 6, rule.scontiAcquisto);
            setScontiToFields('editScontoVendita', 2, rule.scontiVendita);
            modal.style.display = "block";
        }

        function openAddRuleModal() { /* ...come prima, ma senza sottocategoria... */
            modalTitle.textContent = "Aggiungi Nuova Regola Sconto";
            editRuleIdInput.value = ""; 
            editCategoriaInput.value = "";
            editMarcaInput.value = "";
            editAgenteInput.value = ""; 
            if (editCentroAssistenza1Input) editCentroAssistenza1Input.value = "";
            /* ... et altri campi centro assistenza e sconti a "" o [] ... */
            setScontiToFields('editScontoAcquisto', 6, []);
            setScontiToFields('editScontoVendita', 2, []);
            modal.style.display = "block";
            editCategoriaInput.focus();
        }
        function closeModal() { /* ...invariata... */ }

        function saveRuleChanges() {
            const idOriginale = editRuleIdInput.value;
            const categoria = editCategoriaInput.value.trim();
            const marca = editMarcaInput.value.trim();
            const agente = editAgenteInput.value.trim();
            
            const centriAssistenzaSalvataggio = {};
            const parseInputCentro = (el) => {
                if (el && el.value.trim()) {
                    const parts = el.value.trim().split('|').map(p => p.trim());
                    return (parts.length >= 1 && parts[0]) ? { nome: parts[0], telefono: (parts[1] || null) } : null;
                } return null;
            };
            const caCesena = parseInputCentro(editCentroAssistenza1Input); if (caCesena) centriAssistenzaSalvataggio.cesena = caCesena;
            /* ... et altri caSavignano e caRimini ... */

            const scontiAcquisto = getScontiFromFields('editScontoAcquisto', 6);
            const scontiVendita = getScontiFromFields('editScontoVendita', 2);
            if (scontiAcquisto === null || scontiVendita === null || !categoria || !marca) { /* ... gestione errore ... */ return; }

            const ruleDataToSave = { categoria, marca, scontiAcquisto, scontiVendita, agente, centriAssistenza: centriAssistenzaSalvataggio, sottocategoria: "" };

            if (idOriginale) { /* ... Logica modifica ... */ }
            else { /* ... Logica aggiunta ... */ }
            closeModal(); filterDiscountRules(); populateFilters(); showToast("Regola salvata (in memoria)!");
        }
        function deleteRule(ruleId) { /* ...invariata... */ }
        function formatDiscountString(arr) { /* ...invariata... */ }
        function populateFilters() { /* ...invariata... */ }
        function updateBrandFilterOptions(selectedCategory, previouslySelectedBrandValue) { /* ...invariata... */ }

        function renderTable(rulesToRender) {
            const tableBody = document.getElementById('discounts-matrix-body');
            /* ... (inizio logica come prima) ... */

            sortedRules.forEach(rule => {
                const row = tableBody.insertRow();
                
                let centriAssistenzaDisplay = "N/A";
                const ca = rule.centriAssistenza;
                if (ca && typeof ca === 'object' && Object.keys(ca).length > 0) {
                    const parts = [];
                    if (ca.cesena) parts.push(`<strong>Cesena:</strong> ${ca.cesena.nome}${ca.cesena.telefono ? ' (' + ca.cesena.telefono + ')' : ''}`);
                    if (ca.savignano) parts.push(`<strong>Savignano:</strong> ${ca.savignano.nome}${ca.savignano.telefono ? ' (' + ca.savignano.telefono + ')' : ''}`);
                    if (ca.rimini) parts.push(`<strong>Rimini:</strong> ${ca.rimini.nome}${ca.rimini.telefono ? ' (' + ca.rimini.telefono + ')' : ''}`);
                    centriAssistenzaDisplay = parts.join('<br>');
                }
                
                const escapedId = String(rule.id).replace(/'/g, "\\'");
                // Nuovo ordine colonne: Categoria, Marca, Sconti Acquisto, Sconti Vendita, Agenzia, Centri Assistenza, Azioni
                row.innerHTML = `
                    <td class="category-name">${rule.categoria}</td>
                    <td class="brand-name">${rule.marca}</td>
                    <td class="discounts-display">${formatDiscountString(rule.scontiAcquisto)}</td>
                    <td class="discounts-display">${formatDiscountString(rule.scontiVendita)}</td>
                    <td>${rule.agente || '<em>N/A</em>'}</td>
                    <td class="service-centers-cell">${centriAssistenzaDisplay}</td>
                    <td class="actions">
                        <button class="button action-button edit-btn" onclick="openEditModal('${escapedId}')"><i class="fas fa-edit"></i> Modifica</button>
                        <button class="button action-button delete-btn" onclick="deleteRule('${escapedId}')"><i class="fas fa-trash-alt"></i> Elimina</button>
                    </td>
                `;
            });
        }
        function filterDiscountRules() { /* ...invariata... */ }
        function resetFilters() { /* ...invariata... */ }
        window.onclick = function(event) { if (event.target == modal) closeModal(); }
        document.addEventListener('DOMContentLoaded', async () => { await loadDataFromCSV(); });
        // ----- FINE SCRIPT -----
    </script>
</body>
</html>
