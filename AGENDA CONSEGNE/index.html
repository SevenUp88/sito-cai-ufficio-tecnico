<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda Consegne Cloud</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ... [TUTTO IL CSS √à IDENTICO ALLA VERSIONE "PRO" PRECEDENTE, VIENE INCLUSO QUI SOTTO] ... */
    :root { --primary-color: #005A9C; --primary-light: #E6F0F8; --background-color: #f4f7fa; --card-background: #ffffff; --text-primary: #1a202c; --text-secondary: #5a6678; --border-color: #dce3eb; --shadow-color: rgba(45, 55, 71, 0.1); --font-family: 'Inter', sans-serif; --success-color: #28a745; --danger-color: #c82333; }
    * { box-sizing: border-box; }
    body { font-family: var(--font-family); background-color: var(--background-color); margin: 0; padding: 24px; color: var(--text-primary); }
    .app-container { max-width: 900px; margin: 0 auto; }
    h1 { text-align: center; color: var(--primary-color); font-weight: 700; margin-bottom: 2rem; }
    .controls-header { background: var(--card-background); padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .controls-header label { font-weight: 600; font-size: 16px; }
    .controls-header select { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; font-family: inherit; margin-left: 12px; }
    #consegneContainer { display: grid; gap: 1.25rem; }
    .delivery-card { background: var(--card-background); border-left: 5px solid transparent; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); padding: 1.25rem; display: flex; gap: 1.25rem; transition: box-shadow 0.3s ease, border-color 0.4s ease; }
    .delivery-card:hover { box-shadow: 0 8px 25px rgba(45, 55, 71, 0.12); }
    .delivery-card.is-filled { border-left-color: var(--success-color); }
    .card-time { font-size: 1.25rem; font-weight: 700; color: var(--primary-color); width: 70px; flex-shrink: 0; text-align: right; }
    .card-fields { flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; }
    .form-group { display: flex; align-items: center; gap: 10px; }
    .form-group svg { flex-shrink: 0; width: 20px; height: 20px; stroke: var(--text-secondary); }
    .form-group.row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    input[type=text], textarea { width: 100%; font-size: 1rem; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit; color: var(--text-primary); background: #f9fafb; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
    textarea { min-height: 80px; resize: vertical; }
    .pause-label { text-align: center; padding: 1rem; font-weight: 500; color: var(--text-secondary); background-color: var(--primary-light); border: 1px dashed var(--primary-color); border-radius: 12px; }
    .btn-group { margin-top: 2rem; display: flex; justify-content: center; gap: 1rem; }
    button { background: var(--primary-color); border: none; color: white; font-weight: 600; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-family: inherit; display: flex; align-items: center; gap: 8px; transition: background-color 0.25s, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button:hover { background: #004a80; }
    button#clear-day-btn { background-color: var(--danger-color); }
    button#clear-day-btn:hover { background-color: #a51c29; }
    .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .auth-box { background: white; padding: 2rem; border-radius: 12px; text-align: center; }
    #printable { display: none; }
    @media print { /* Stili di stampa identici a prima */ }
  </style>

  <!-- IMPORTANT: Replace YOUR_API_KEY_HERE with your actual Google Maps API Key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=places"></script>
</head>

<body>
  <!-- Overlay per l'autenticazione -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2>Accesso Richiesto</h2>
      <p>Effettua il login per accedere all'agenda.</p>
      <p id="authError" style="color:red;"></p>
      <input type="email" id="email" placeholder="Email" style="margin-bottom: 10px;">
      <input type="password" id="password" placeholder="Password" style="margin-bottom: 20px;">
      <button onclick="handleLogin()">Accedi</button>
    </div>
  </div>
  
  <div id="app" class="app-container" style="display: none;">
    <h1>Agenda Consegne Cloud</h1>
    
    <div class="controls-header">
       <div>
        <label for="daySelect">Giorno:</label>
        <select id="daySelect" onchange="buildAgenda()"></select>
        <span id="user-info" style="margin-left: 20px; font-weight: 500;"></span>
       </div>
       <div>
        <button id="clear-day-btn" onclick="clearDayData()">üóëÔ∏è Svuota</button>
        <button onclick="handleLogout()" style="background-color: var(--danger-color);">üö™ Logout</button>
       </div>
    </div>
    
    <div id="consegneContainer"></div>
    
    <div class="btn-group">
      <button onclick="printDaily()">üñ®Ô∏è Stampa Giorno</button>
      <button onclick="printWeekly()">üñ®Ô∏è Stampa Settimana</button>
    </div>
  </div>

  <div id="printable"></div>

  <script type="module">
    // Importo le funzionalit√† da firebase-config.js
    import { auth, db, doc, setDoc, getDoc } from './firebase-config.js';
    import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    
    // Variabili Globali
    let currentUser = null;
    let agendaData = {};
    let saveTimeout = null;
    let autocompleteObjects = [];

    const allHours = ["08:00", "09:00", "10:00", "11:00", "14:00", "15:00", "16:00", "17:00", "18:00"];
    const ICONS = { /* SVG delle icone omessi per brevit√† */ };

    // --- Gestione Autenticazione ---
    onAuthStateChanged(auth, async (user) => {
      const authOverlay = document.getElementById('authOverlay');
      const appDiv = document.getElementById('app');
      
      if (user) {
        currentUser = user;
        authOverlay.style.display = 'none';
        appDiv.style.display = 'block';
        document.getElementById('user-info').textContent = `Utente: ${user.email}`;
        await loadAgendaData(); // Carica i dati dell'utente loggato
        populateDaySelector();
        buildAgenda();
      } else {
        currentUser = null;
        authOverlay.style.display = 'flex';
        appDiv.style.display = 'none';
      }
    });

    window.handleLogin = () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const errorP = document.getElementById('authError');
      errorP.textContent = '';
      signInWithEmailAndPassword(auth, email, password)
        .catch(error => errorP.textContent = "Credenziali non valide.");
    };

    window.handleLogout = () => signOut(auth);

    // --- Gestione Dati con Firestore ---
    async function loadAgendaData() {
      if (!currentUser) return;
      console.log(`Caricamento dati per l'utente ${currentUser.uid}`);
      const docRef = doc(db, 'agende', currentUser.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        agendaData = docSnap.data();
        console.log("Dati caricati:", agendaData);
      } else {
        console.log("Nessun dato esistente per questo utente. Creazione nuovo documento.");
        agendaData = {}; // Inizia con un oggetto vuoto
      }
    }

    function handleAutoSave(event) {
      clearTimeout(saveTimeout);
      
      const [day, hour, field] = event.target.id.split('-');
      if (!day || !hour || !field) return;

      // Aggiorna l'oggetto dati in memoria
      const key = `${day}-${hour}-${field}`;
      agendaData[key] = event.target.value.trim();

      checkCardFilledState(day, hour);

      // Salva l'intero documento su Firestore dopo 1.5 secondi di inattivit√†
      saveTimeout = setTimeout(async () => {
        if (!currentUser) return;
        console.log("Salvataggio automatico su Firestore...");
        const docRef = doc(db, 'agende', currentUser.uid);
        try {
          await setDoc(docRef, agendaData, { merge: true });
          console.log("Dati salvati con successo!");
        } catch (e) {
          console.error("Errore nel salvataggio dei dati: ", e);
        }
      }, 1500);
    }
    
    // --- Costruzione UI ---
    function populateDaySelector() {
      const select = document.getElementById('daySelect');
      const dayLabels = { mon: "Luned√¨", tue: "Marted√¨", wed: "Mercoled√¨", thu: "Gioved√¨", fri: "Venerd√¨" };
      select.innerHTML = '';
      Object.entries(dayLabels).forEach(([key, label]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = label;
          select.appendChild(option);
      });
    }

    window.buildAgenda = () => {
      const container = document.getElementById("consegneContainer");
      container.innerHTML = "";
      const selectedDay = document.getElementById("daySelect").value;
      
      allHours.forEach(hour => {
        if (hour === "14:00") { container.insertAdjacentHTML('beforeend', `<div class="pause-label">üïê Pausa pranzo</div>`); }
        
        const note = agendaData[`${selectedDay}-${hour}-note`] || "";
        const indirizzo = agendaData[`${selectedDay}-${hour}-indirizzo`] || "";
        const contatto = agendaData[`${selectedDay}-${hour}-contatto`] || "";
        
        const card = document.createElement('div');
        card.className = 'delivery-card';
        card.id = `card-${selectedDay}-${hour}`;
        card.innerHTML = `
          <div class="card-time">${hour}</div>
          <div class="card-fields">
            <div class="form-group"><textarea id="${selectedDay}-${hour}-note" placeholder="Materiale, dettagli...">${note}</textarea></div>
            <div class="form-group row">
              <input type="text" id="${selectedDay}-${hour}-indirizzo" value="${indirizzo}" placeholder="Indirizzo e n. civico">
              <input type="text" id="${selectedDay}-${hour}-contatto" value="${contatto}" placeholder="Contatto e tel.">
            </div>
          </div>
        `;
        container.appendChild(card);
        
        ['note', 'indirizzo', 'contatto'].forEach(field => {
          document.getElementById(`${selectedDay}-${hour}-${field}`).addEventListener('input', handleAutoSave);
        });
        
        checkCardFilledState(selectedDay, hour);
      });
      initAutocomplete(selectedDay);
    }
    
    // --- Funzioni di Utilit√† ---
    function checkCardFilledState(day, hour) {
        const card = document.getElementById(`card-${day}-${hour}`);
        if (!card) return;
        const note = (agendaData[`${day}-${hour}-note`] || "").trim();
        const indirizzo = (agendaData[`${day}-${hour}-indirizzo`] || "").trim();
        const contatto = (agendaData[`${day}-${hour}-contatto`] || "").trim();
        card.classList.toggle('is-filled', !!(note || indirizzo || contatto));
    }

    window.clearDayData = () => {
        const selectedDay = document.getElementById("daySelect").value;
        if (!confirm(`Sei sicuro di voler cancellare TUTTE le consegne di ${document.getElementById(selectedDay).textContent}?`)) return;
        
        allHours.forEach(hour => {
            ["note", "indirizzo", "contatto"].forEach(field => {
                delete agendaData[`${selectedDay}-${hour}-${field}`];
            });
        });
        
        // Forza un salvataggio immediato dei dati rimossi
        clearTimeout(saveTimeout);
        handleAutoSave({ target: { id: `${selectedDay}-08:00-note`, value: '' } }); // Simula un evento
        buildAgenda();
        alert(`${document.getElementById(selectedDay).textContent} √® stato svuotato.`);
    };
    
    function initAutocomplete(day) {
        // ... (Logica Autocomplete identica a prima) ...
    }

    // --- Logica di Stampa (legge da agendaData invece che da localStorage) ---
    // (Le funzioni di stampa vanno adattate per usare agendaData, come mostrato qui)
    function generatePrintTable(days) {
        let dayLabelsPrint = { mon: "Luned√¨", tue: "Marted√¨", wed: "Mercoled√¨", thu: "Gioved√¨", fri: "Venerd√¨" };
        let html = `<thead><tr><th>Ora</th>${days.map(d => `<th>${dayLabelsPrint[d]}</th>`).join('')}</tr></thead><tbody>`;
        allHours.forEach(hour => {
            if(hour === "14:00") html += `<tr><td colspan="${days.length+1}" style="text-align:center;">Pausa Pranzo</td></tr>`;
            html += `<tr><td>${hour}</td>`;
            days.forEach(day => {
                const note = (agendaData[`${day}-${hour}-note`] || "").replace(/\n/g, "<br>");
                const indirizzo = agendaData[`${day}-${hour}-indirizzo`] || "";
                const contatto = agendaData[`${day}-${hour}-contatto`] || "";
                let content = note || indirizzo || contatto ? `${note}<br>${indirizzo}<br>${contatto}` : '-';
                html += `<td>${content}</td>`;
            });
            html += `</tr>`;
        });
        return html;
    }
    window.printDaily = () => printContent(`<h2>Consegne Giornaliere</h2><table>${generatePrintTable([document.getElementById('daySelect').value])}</tbody></table>`);
    window.printWeekly = () => printContent(`<h2>Agenda Settimanale</h2><table>${generatePrintTable(Object.keys({mon:0,tue:0,wed:0,thu:0,fri:0}))}</tbody></table>`);
    function printContent(html) { /* identica a prima */ }

  </script>
</body>
</html>
